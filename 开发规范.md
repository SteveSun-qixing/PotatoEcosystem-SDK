# SDK 开发规范

**版本**: 1.0.0  
**更新日期**: 2026-01-31  
**状态**: 正式版

---

## 1. 总则

### 1.1 规范继承

SDK 开发必须遵循 **生态共用/08-开发规范总则.md** 中定义的所有规范。

### 1.2 额外要求

本文档定义 SDK 特有的额外开发规范。

---

## 2. 架构规范

### 2.1 模块化

**每个模块必须**:
- 独立文件
- 单一职责
- 清晰接口
- 完整类型

**示例**:
```typescript
// ✅ 正确: 模块独立,职责清晰
// src/api/FileAPI.ts
export class FileAPI {
  // 只负责文件操作
}

// src/api/CardAPI.ts
export class CardAPI {
  // 只负责卡片管理
}
```

### 2.2 依赖注入

**所有依赖必须通过构造函数注入**:

```typescript
// ✅ 正确
class FileAPI {
  constructor(
    private coreConnector: CoreConnector,
    private logger: Logger
  ) {}
}

// ❌ 错误: 不要在模块内部创建依赖
class FileAPI {
  private coreConnector = new CoreConnector();
}
```

### 2.3 通过 Core 通信

**所有对 Foundation 的调用必须通过 CoreConnector**:

```typescript
// ✅ 正确
const result = await this.coreConnector.request({
  service: 'resource',
  method: 'read',
  payload: { path: filePath }
});

// ❌ 错误: 不要直接调用 Foundation
import { ZIPProcessor } from '@chips/foundation';
const data = ZIPProcessor.read(filePath);
```

---

## 3. 代码规范

### 3.1 TypeScript 严格模式

**必须启用 TypeScript 严格模式**:

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true
  }
}
```

### 3.2 命名规范

**类名**: PascalCase
```typescript
class ChipsSDK {}
class FileAPI {}
class CoreConnector {}
```

**方法和变量**: camelCase
```typescript
async loadCard(path: string): Promise<Card> {}
const cardMetadata = card.metadata;
```

**常量**: UPPER_SNAKE_CASE
```typescript
const DEFAULT_CACHE_SIZE = 100 * 1024 * 1024;
const MAX_FILE_SIZE = 2 * 1024 * 1024 * 1024;
```

**私有成员**: 前缀 `_`
```typescript
class ChipsSDK {
  private _coreConnector: CoreConnector;
  private _initialized = false;
}
```

**类型和接口**: PascalCase
```typescript
interface Card {}
interface CardMetadata {}
type EventHandler = (data: any) => void;
```

### 3.3 注释规范

**所有公开 API 必须有 JSDoc 注释**:

```typescript
/**
 * 加载卡片文件
 * 
 * @param path - 卡片文件路径(相对或绝对路径)
 * @param options - 加载选项
 * @returns Promise<Card> - 卡片对象
 * @throws {ChipsError} 文件不存在时抛出 RES-3001
 * 
 * @example
 * ```typescript
 * const card = await sdk.loadCard('path/to/card.card');
 * console.log(card.metadata.name);
 * ```
 */
async loadCard(path: string, options?: LoadOptions): Promise<Card> {
  // 实现
}
```

**复杂逻辑必须有解释注释**:

```typescript
// 使用 LRU 策略淘汰缓存
// 优先淘汰最久未使用的项,直到缓存大小低于限制
private evictCache(): void {
  // ...
}
```

---

## 4. 错误处理规范

### 4.1 使用标准错误类

```typescript
class ChipsError extends Error {
  constructor(
    public code: string,
    message: string,
    public details?: any
  ) {
    super(message);
    this.name = 'ChipsError';
  }
}
```

### 4.2 错误代码

**使用标准错误代码格式**: `[分类]-[编号]`

```typescript
// ✅ 正确
throw new ChipsError(
  'FILE-1001',
  t('error.file_not_found'),
  { path: filePath }
);

// ❌ 错误
throw new Error('File not found');
```

### 4.3 错误记录

**所有错误必须记录日志**:

```typescript
try {
  await operation();
} catch (error) {
  this.logger.error('Operation failed', error, {
    context: { operation: 'loadCard', path }
  });
  throw error;
}
```

---

## 5. 测试规范

### 5.1 测试覆盖率

**要求**:
- 单元测试覆盖率 ≥ 85%
- 所有公开 API 必须有测试
- 核心功能测试覆盖率 100%

### 5.2 测试结构

```typescript
describe('FileAPI', () => {
  let fileAPI: FileAPI;
  let mockConnector: MockCoreConnector;
  
  beforeEach(() => {
    mockConnector = new MockCoreConnector();
    fileAPI = new FileAPI(mockConnector);
  });
  
  afterEach(() => {
    mockConnector.reset();
  });
  
  describe('loadCard', () => {
    it('should load card successfully', async () => {
      // Arrange
      mockConnector.mockResponse('resource.read', cardData);
      
      // Act
      const card = await fileAPI.loadCard('test.card');
      
      // Assert
      expect(card).toBeDefined();
      expect(card.id).toBe('test123');
    });
    
    it('should throw error when file not found', async () => {
      // Arrange
      mockConnector.mockError('FILE-1001', 'File not found');
      
      // Act & Assert
      await expect(fileAPI.loadCard('missing.card'))
        .rejects
        .toThrow('File not found');
    });
  });
});
```

### 5.3 Mock 对象

**创建清晰的 Mock 对象**:

```typescript
class MockCoreConnector implements CoreConnector {
  private responses = new Map<string, any>();
  
  mockResponse(service: string, data: any): void {
    this.responses.set(service, data);
  }
  
  async request(params: RequestParams): Promise<ResponseData> {
    const data = this.responses.get(params.service);
    if (!data) {
      throw new Error(`No mock for ${params.service}`);
    }
    return { status: 'success', data };
  }
}
```

---

## 6. 文档规范

### 6.1 README

**每个模块必须有 README**,包含:
- 模块说明
- 主要功能
- 使用示例
- API 列表

### 6.2 CHANGELOG

**每个版本必须更新 CHANGELOG**:

```markdown
## [1.1.0] - 2026-02-01

### Added
- 新增批量加载功能
- 新增虚拟滚动支持

### Changed
- 优化文件加载性能

### Fixed
- 修复缓存内存泄漏问题
```

### 6.3 API 文档

**每个 API 必须有完整文档**,包含:
- 功能描述
- 参数说明
- 返回值说明
- 错误说明
- 使用示例

---

## 7. 性能规范

### 7.1 避免阻塞

**所有 I/O 操作必须异步**:

```typescript
// ✅ 正确
async loadCard(path: string): Promise<Card> {
  const data = await this.coreConnector.request({...});
  return this.parseCard(data);
}

// ❌ 错误: 不要使用同步操作
loadCard(path: string): Card {
  const data = fs.readFileSync(path);
  return this.parseCard(data);
}
```

### 7.2 使用缓存

**合理使用缓存避免重复计算**:

```typescript
private cache = new Map<string, Card>();

async loadCard(path: string): Promise<Card> {
  // 检查缓存
  if (this.cache.has(path)) {
    return this.cache.get(path)!;
  }
  
  // 加载文件
  const card = await this.loadCardFromFile(path);
  
  // 缓存结果
  this.cache.set(path, card);
  
  return card;
}
```

### 7.3 懒加载

**按需加载模块和资源**:

```typescript
class ChipsSDK {
  private _renderer?: RendererEngine;
  
  // 懒加载渲染引擎
  get renderer(): RendererEngine {
    if (!this._renderer) {
      this._renderer = new RendererEngine(this._coreConnector);
    }
    return this._renderer;
  }
}
```

---

## 8. 安全规范

### 8.1 输入验证

**所有外部输入必须验证**:

```typescript
async loadCard(path: string): Promise<Card> {
  // 验证路径
  if (!this.isValidPath(path)) {
    throw new ChipsError(
      'FILE-1002',
      'Invalid file path',
      { path }
    );
  }
  
  // 继续处理
}

private isValidPath(path: string): boolean {
  // 防止路径遍历
  if (path.includes('..')) return false;
  
  // 检查文件扩展名
  if (!path.endsWith('.card')) return false;
  
  return true;
}
```

### 8.2 不记录敏感信息

**日志中不要包含敏感信息**:

```typescript
// ✅ 正确
this.logger.info('User logged in', { userId: user.id });

// ❌ 错误: 不要记录密码
this.logger.info('User logged in', { 
  userId: user.id, 
  password: user.password  // 危险!
});
```

---

## 9. Git 规范

### 9.1 提交消息

**格式**: `类型(范围): 简短描述`

```bash
# 功能
git commit -m "feat(file): 添加批量加载功能"

# 修复
git commit -m "fix(cache): 修复内存泄漏问题"

# 文档
git commit -m "docs(readme): 更新 API 文档"

# 重构
git commit -m "refactor(renderer): 优化渲染流程"

# 测试
git commit -m "test(file): 添加文件加载测试"
```

### 9.2 分支规范

- `main`: 主分支,稳定版本
- `develop`: 开发分支
- `feature/*`: 功能分支
- `fix/*`: 修复分支
- `release/*`: 发布分支

---

## 10. 发布规范

### 10.1 版本号

**遵循语义化版本**:
- 主版本号: 不兼容的 API 变更
- 次版本号: 向后兼容的功能新增
- 修订号: 向后兼容的 Bug 修复

### 10.2 发布检查清单

- [ ] 所有测试通过
- [ ] 测试覆盖率 ≥ 85%
- [ ] 更新 CHANGELOG
- [ ] 更新版本号
- [ ] 更新文档
- [ ] 代码审查通过
- [ ] 无已知安全漏洞

---

## 11. 代码审查规范

### 11.1 审查要点

**功能正确性**:
- 实现是否符合需求
- 边界情况是否处理
- 错误处理是否完善

**代码质量**:
- 是否遵循开发规范
- 是否有充分的注释
- 是否有测试覆盖

**性能**:
- 是否有性能问题
- 是否有内存泄漏
- 是否可以优化

**安全**:
- 是否有安全漏洞
- 输入是否验证
- 敏感数据是否保护

### 11.2 审查模板

```markdown
## 功能
- [ ] 实现符合需求
- [ ] 边界情况已处理
- [ ] 错误处理完善

## 代码质量
- [ ] 遵循开发规范
- [ ] 注释充分
- [ ] 测试覆盖

## 性能
- [ ] 无性能问题
- [ ] 无内存泄漏

## 安全
- [ ] 无安全漏洞
- [ ] 输入已验证

## 其他
- 建议: [...]
- 问题: [...]
```

---

**文档维护者**: Chips 生态核心团队  
**反馈渠道**: 提交 Issue 到官方仓库
