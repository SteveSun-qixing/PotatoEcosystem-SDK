# Phase9 - 渲染引擎

**状态**: 待开始  
**预计时间**: 4-5 天  
**依赖**: Phase5, Phase6, Phase7, Phase8

---

## 1. 阶段目标

- 实现 RendererEngine 渲染引擎
- 实现卡片渲染
- 实现箱子渲染
- 支持懒加载和虚拟滚动
- 支持渲染实例管理

---

## 2. 任务清单

### 2.1 渲染类型定义

#### 任务 9.1.1: 定义渲染类型
**优先级**: P0  
**描述**: 创建 `src/renderer/types.ts`

```typescript
import { ChipsId } from '../types/base';
import { Card } from '../types/card';
import { Box } from '../types/box';

/**
 * 渲染模式
 */
export type RenderMode = 'view' | 'edit' | 'preview';

/**
 * 渲染状态
 */
export type RenderStatus = 'pending' | 'rendering' | 'rendered' | 'error' | 'destroyed';

/**
 * 渲染选项
 */
export interface RenderOptions {
  mode?: RenderMode;
  theme?: string;
  readOnly?: boolean;
  interactive?: boolean;
  lazyLoad?: boolean;
  virtualScroll?: boolean;
  animations?: boolean;
  className?: string;
  style?: Record<string, string>;
  attributes?: Record<string, string>;
}

/**
 * 卡片渲染选项
 */
export interface CardRenderOptions extends RenderOptions {
  showCover?: boolean;
  expandedBaseCards?: ChipsId[];
}

/**
 * 箱子渲染选项
 */
export interface BoxRenderOptions extends RenderOptions {
  layout?: string;
  layoutConfig?: Record<string, unknown>;
  loadCards?: boolean;
  cardOptions?: CardRenderOptions;
}

/**
 * 渲染实例
 */
export interface RenderInstance {
  id: string;
  type: 'card' | 'box';
  targetId: ChipsId;
  container: HTMLElement;
  status: RenderStatus;
  options: RenderOptions;
  data: Card | Box;
  createdAt: string;
  updatedAt?: string;
  error?: Error;
}

/**
 * 渲染结果
 */
export interface RenderResult {
  success: boolean;
  instance?: RenderInstance;
  element?: HTMLElement;
  error?: Error;
}

/**
 * 懒加载配置
 */
export interface LazyLoadConfig {
  threshold?: number;
  rootMargin?: string;
  placeholder?: HTMLElement | string;
}

/**
 * 虚拟滚动配置
 */
export interface VirtualScrollConfig {
  itemHeight?: number | 'auto';
  bufferSize?: number;
  overscan?: number;
}

/**
 * 渲染事件
 */
export interface RenderEvent {
  instanceId: string;
  type: 'start' | 'complete' | 'error' | 'update' | 'destroy';
  data?: unknown;
  error?: Error;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持多种渲染模式

---

### 2.2 RenderInstance 实现

#### 任务 9.2.1: 实现 RenderInstance 类
**优先级**: P0  
**描述**: 创建 `src/renderer/instance.ts`

```typescript
import { RenderInstance, RenderStatus, RenderOptions, RenderMode } from './types';
import { Card } from '../types/card';
import { Box } from '../types/box';
import { ChipsId } from '../types/base';
import { generateUuid } from '../utils/id';

/**
 * 渲染实例管理类
 */
export class RenderInstanceManager {
  private _instances = new Map<string, RenderInstance>();

  /**
   * 创建实例
   */
  create(
    type: 'card' | 'box',
    targetId: ChipsId,
    container: HTMLElement,
    data: Card | Box,
    options: RenderOptions
  ): RenderInstance {
    const instance: RenderInstance = {
      id: generateUuid(),
      type,
      targetId,
      container,
      status: 'pending',
      options,
      data,
      createdAt: new Date().toISOString(),
    };

    this._instances.set(instance.id, instance);
    return instance;
  }

  /**
   * 获取实例
   */
  get(instanceId: string): RenderInstance | undefined {
    return this._instances.get(instanceId);
  }

  /**
   * 获取目标的实例
   */
  getByTarget(targetId: ChipsId): RenderInstance | undefined {
    for (const instance of this._instances.values()) {
      if (instance.targetId === targetId) {
        return instance;
      }
    }
    return undefined;
  }

  /**
   * 获取容器的实例
   */
  getByContainer(container: HTMLElement): RenderInstance | undefined {
    for (const instance of this._instances.values()) {
      if (instance.container === container) {
        return instance;
      }
    }
    return undefined;
  }

  /**
   * 更新实例状态
   */
  updateStatus(instanceId: string, status: RenderStatus, error?: Error): void {
    const instance = this._instances.get(instanceId);
    if (instance) {
      instance.status = status;
      instance.updatedAt = new Date().toISOString();
      if (error) {
        instance.error = error;
      }
    }
  }

  /**
   * 更新实例数据
   */
  updateData(instanceId: string, data: Card | Box): void {
    const instance = this._instances.get(instanceId);
    if (instance) {
      instance.data = data;
      instance.updatedAt = new Date().toISOString();
    }
  }

  /**
   * 更新实例选项
   */
  updateOptions(instanceId: string, options: Partial<RenderOptions>): void {
    const instance = this._instances.get(instanceId);
    if (instance) {
      instance.options = { ...instance.options, ...options };
      instance.updatedAt = new Date().toISOString();
    }
  }

  /**
   * 销毁实例
   */
  destroy(instanceId: string): boolean {
    const instance = this._instances.get(instanceId);
    if (instance) {
      instance.status = 'destroyed';
      this._instances.delete(instanceId);
      return true;
    }
    return false;
  }

  /**
   * 获取所有实例
   */
  getAll(): RenderInstance[] {
    return Array.from(this._instances.values());
  }

  /**
   * 获取指定类型的实例
   */
  getByType(type: 'card' | 'box'): RenderInstance[] {
    return this.getAll().filter((i) => i.type === type);
  }

  /**
   * 获取指定状态的实例
   */
  getByStatus(status: RenderStatus): RenderInstance[] {
    return this.getAll().filter((i) => i.status === status);
  }

  /**
   * 实例数量
   */
  get count(): number {
    return this._instances.size;
  }

  /**
   * 清除所有实例
   */
  clear(): void {
    for (const instance of this._instances.values()) {
      instance.status = 'destroyed';
    }
    this._instances.clear();
  }
}
```

**验收标准**:
- [ ] 实例创建/销毁正常
- [ ] 实例查询功能完整
- [ ] 状态更新正常

---

### 2.3 RendererEngine 实现

#### 任务 9.3.1: 实现 RendererEngine 类
**优先级**: P0  
**描述**: 创建 `src/renderer/engine.ts`

```typescript
import { CoreConnector, ChipsError, ErrorCodes } from '../core';
import { Logger } from '../logger';
import { ConfigManager } from '../config';
import { EventBus } from '../event';
import { PluginSystem } from '../plugin';
import { ThemeManager } from '../theme';
import { Card } from '../types/card';
import { Box } from '../types/box';
import { ChipsId } from '../types/base';
import {
  RenderOptions,
  CardRenderOptions,
  BoxRenderOptions,
  RenderResult,
  RenderInstance,
  LazyLoadConfig,
  VirtualScrollConfig,
} from './types';
import { RenderInstanceManager } from './instance';

/**
 * 默认渲染选项
 */
const DEFAULT_RENDER_OPTIONS: Required<RenderOptions> = {
  mode: 'view',
  theme: 'default',
  readOnly: true,
  interactive: true,
  lazyLoad: true,
  virtualScroll: false,
  animations: true,
  className: '',
  style: {},
  attributes: {},
};

/**
 * 渲染引擎
 */
export class RendererEngine {
  private _connector: CoreConnector;
  private _logger: Logger;
  private _config: ConfigManager;
  private _eventBus: EventBus;
  private _pluginSystem: PluginSystem;
  private _themeManager: ThemeManager;
  private _instanceManager: RenderInstanceManager;
  private _lazyObserver: IntersectionObserver | null = null;

  constructor(
    connector: CoreConnector,
    logger: Logger,
    config: ConfigManager,
    eventBus: EventBus,
    pluginSystem: PluginSystem,
    themeManager: ThemeManager
  ) {
    this._connector = connector;
    this._logger = logger.createChild('RendererEngine');
    this._config = config;
    this._eventBus = eventBus;
    this._pluginSystem = pluginSystem;
    this._themeManager = themeManager;
    this._instanceManager = new RenderInstanceManager();
  }

  /**
   * 初始化渲染引擎
   */
  async initialize(): Promise<void> {
    this._logger.debug('Initializing renderer engine');
    
    // 创建懒加载观察器
    this._createLazyObserver();
    
    this._logger.info('Renderer engine initialized');
  }

  /**
   * 渲染卡片
   */
  async renderCard(
    card: Card,
    container: HTMLElement,
    options?: CardRenderOptions
  ): Promise<RenderResult> {
    const opts = { ...DEFAULT_RENDER_OPTIONS, ...options } as Required<CardRenderOptions>;
    
    this._logger.debug('Rendering card', { id: card.id, options: opts });

    // 验证容器
    if (!container || !(container instanceof HTMLElement)) {
      return {
        success: false,
        error: new ChipsError(ErrorCodes.RENDER_CONTAINER_INVALID, 'Invalid container'),
      };
    }

    // 创建实例
    const instance = this._instanceManager.create('card', card.id, container, card, opts);
    
    try {
      // 发布开始事件
      await this._eventBus.emit('render:start', { instanceId: instance.id, type: 'card' });
      this._instanceManager.updateStatus(instance.id, 'rendering');

      // 应用主题
      if (opts.theme) {
        await this._themeManager.apply(opts.theme, { scope: 'card', target: container });
      }

      // 创建卡片容器
      const cardElement = this._createCardElement(card, opts);
      
      // 渲染封面
      if (opts.showCover !== false) {
        await this._renderCardCover(card, cardElement);
      }

      // 渲染基础卡片
      await this._renderBaseCards(card, cardElement, opts);

      // 添加到容器
      container.innerHTML = '';
      container.appendChild(cardElement);

      // 应用样式和属性
      this._applyElementOptions(container, opts);

      // 更新状态
      this._instanceManager.updateStatus(instance.id, 'rendered');

      // 发布完成事件
      await this._eventBus.emit('render:complete', { instanceId: instance.id, type: 'card' });

      this._logger.info('Card rendered', { id: card.id, instanceId: instance.id });

      return {
        success: true,
        instance,
        element: cardElement,
      };
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error));
      this._instanceManager.updateStatus(instance.id, 'error', err);
      
      // 发布错误事件
      await this._eventBus.emit('render:error', { instanceId: instance.id, error: err });

      this._logger.error('Card render failed', { id: card.id, error: err });

      return {
        success: false,
        instance,
        error: err,
      };
    }
  }

  /**
   * 渲染箱子
   */
  async renderBox(
    box: Box,
    container: HTMLElement,
    cards: Card[],
    options?: BoxRenderOptions
  ): Promise<RenderResult> {
    const opts = { ...DEFAULT_RENDER_OPTIONS, ...options } as Required<BoxRenderOptions>;
    
    this._logger.debug('Rendering box', { id: box.id, cardCount: cards.length, options: opts });

    // 验证容器
    if (!container || !(container instanceof HTMLElement)) {
      return {
        success: false,
        error: new ChipsError(ErrorCodes.RENDER_CONTAINER_INVALID, 'Invalid container'),
      };
    }

    // 创建实例
    const instance = this._instanceManager.create('box', box.id, container, box, opts);

    try {
      // 发布开始事件
      await this._eventBus.emit('render:start', { instanceId: instance.id, type: 'box' });
      this._instanceManager.updateStatus(instance.id, 'rendering');

      // 应用主题
      if (opts.theme) {
        await this._themeManager.apply(opts.theme, { scope: 'box', target: container });
      }

      // 创建箱子容器
      const boxElement = this._createBoxElement(box, opts);

      // 渲染卡片列表
      const layout = opts.layout || box.content.active_layout;
      await this._renderBoxCards(cards, boxElement, layout, opts);

      // 添加到容器
      container.innerHTML = '';
      container.appendChild(boxElement);

      // 应用样式和属性
      this._applyElementOptions(container, opts);

      // 更新状态
      this._instanceManager.updateStatus(instance.id, 'rendered');

      // 发布完成事件
      await this._eventBus.emit('render:complete', { instanceId: instance.id, type: 'box' });

      this._logger.info('Box rendered', { id: box.id, instanceId: instance.id });

      return {
        success: true,
        instance,
        element: boxElement,
      };
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error));
      this._instanceManager.updateStatus(instance.id, 'error', err);

      // 发布错误事件
      await this._eventBus.emit('render:error', { instanceId: instance.id, error: err });

      this._logger.error('Box render failed', { id: box.id, error: err });

      return {
        success: false,
        instance,
        error: err,
      };
    }
  }

  /**
   * 更新渲染实例
   */
  async update(instanceId: string, data?: Card | Box, options?: RenderOptions): Promise<RenderResult> {
    const instance = this._instanceManager.get(instanceId);
    if (!instance) {
      return {
        success: false,
        error: new ChipsError(ErrorCodes.RENDER_INSTANCE_NOT_FOUND, `Instance not found: ${instanceId}`),
      };
    }

    // 更新数据
    if (data) {
      this._instanceManager.updateData(instanceId, data);
    }

    // 更新选项
    if (options) {
      this._instanceManager.updateOptions(instanceId, options);
    }

    // 重新渲染
    if (instance.type === 'card') {
      return this.renderCard(
        (data || instance.data) as Card,
        instance.container,
        instance.options as CardRenderOptions
      );
    } else {
      // 箱子需要卡片数据，这里简化处理
      return this.renderBox(
        (data || instance.data) as Box,
        instance.container,
        [],
        instance.options as BoxRenderOptions
      );
    }
  }

  /**
   * 销毁渲染实例
   */
  async destroy(instanceId: string): Promise<boolean> {
    const instance = this._instanceManager.get(instanceId);
    if (!instance) {
      return false;
    }

    this._logger.debug('Destroying render instance', { instanceId });

    // 清空容器
    if (instance.container) {
      instance.container.innerHTML = '';
    }

    // 销毁实例
    this._instanceManager.destroy(instanceId);

    // 发布事件
    await this._eventBus.emit('render:destroy', { instanceId });

    return true;
  }

  /**
   * 获取渲染实例
   */
  getInstance(instanceId: string): RenderInstance | undefined {
    return this._instanceManager.get(instanceId);
  }

  /**
   * 获取所有渲染实例
   */
  getAllInstances(): RenderInstance[] {
    return this._instanceManager.getAll();
  }

  /**
   * 清理所有渲染实例
   */
  async cleanup(): Promise<void> {
    this._logger.debug('Cleaning up all render instances');
    
    for (const instance of this._instanceManager.getAll()) {
      await this.destroy(instance.id);
    }
  }

  // ========== 私有方法 ==========

  /**
   * 创建卡片元素
   */
  private _createCardElement(card: Card, options: Required<CardRenderOptions>): HTMLElement {
    const element = document.createElement('div');
    element.className = 'chips-card';
    element.setAttribute('data-card-id', card.id);
    element.setAttribute('data-mode', options.mode);
    
    if (options.readOnly) {
      element.setAttribute('data-readonly', 'true');
    }
    
    return element;
  }

  /**
   * 创建箱子元素
   */
  private _createBoxElement(box: Box, options: Required<BoxRenderOptions>): HTMLElement {
    const element = document.createElement('div');
    element.className = 'chips-box';
    element.setAttribute('data-box-id', box.id);
    element.setAttribute('data-layout', options.layout || box.content.active_layout);
    element.setAttribute('data-mode', options.mode);
    
    return element;
  }

  /**
   * 渲染卡片封面
   */
  private async _renderCardCover(card: Card, container: HTMLElement): Promise<void> {
    // 通过 Core 获取封面内容
    const response = await this._connector.request<string>({
      service: 'card',
      method: 'getCover',
      payload: { cardId: card.id },
    });

    if (response.success && response.data) {
      const coverElement = document.createElement('div');
      coverElement.className = 'chips-card-cover';
      
      // 使用沙盒渲染 HTML
      const iframe = document.createElement('iframe');
      iframe.sandbox.add('allow-same-origin');
      iframe.srcdoc = response.data;
      coverElement.appendChild(iframe);
      
      container.appendChild(coverElement);
    }
  }

  /**
   * 渲染基础卡片
   */
  private async _renderBaseCards(
    card: Card,
    container: HTMLElement,
    options: Required<CardRenderOptions>
  ): Promise<void> {
    const baseCardsContainer = document.createElement('div');
    baseCardsContainer.className = 'chips-base-cards';

    for (const baseCard of card.structure.structure) {
      const plugin = this._pluginSystem.get(baseCard.type);
      
      if (plugin && 'render' in plugin) {
        const baseCardElement = document.createElement('div');
        baseCardElement.className = 'chips-base-card';
        baseCardElement.setAttribute('data-base-card-id', baseCard.id);
        baseCardElement.setAttribute('data-base-card-type', baseCard.type);

        try {
          const context = {
            sdk: null,
            config: {},
            logger: this._logger,
          };
          
          await (plugin as any).render(baseCard, baseCardElement, context);
        } catch (error) {
          this._logger.warn('Base card render failed', { baseCardId: baseCard.id, error });
          baseCardElement.innerHTML = `<div class="chips-base-card-error">渲染失败</div>`;
        }

        baseCardsContainer.appendChild(baseCardElement);
      }
    }

    container.appendChild(baseCardsContainer);
  }

  /**
   * 渲染箱子中的卡片
   */
  private async _renderBoxCards(
    cards: Card[],
    container: HTMLElement,
    layout: string,
    options: Required<BoxRenderOptions>
  ): Promise<void> {
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'chips-box-cards';

    // 获取布局插件
    const layoutPlugin = this._pluginSystem.get(layout);
    
    if (layoutPlugin && 'render' in layoutPlugin) {
      // 先渲染所有卡片元素
      const cardElements: HTMLElement[] = [];
      
      for (const card of cards) {
        const cardElement = document.createElement('div');
        cardElement.className = 'chips-box-card-item';
        cardElement.setAttribute('data-card-id', card.id);
        
        // 渲染卡片
        await this.renderCard(card, cardElement, options.cardOptions);
        cardElements.push(cardElement);
      }

      // 使用布局插件渲染
      try {
        const config = options.layoutConfig || {};
        await (layoutPlugin as any).render(cardElements, cardsContainer, config);
      } catch (error) {
        this._logger.warn('Layout render failed', { layout, error });
        // 降级为简单布局
        cardElements.forEach((el) => cardsContainer.appendChild(el));
      }
    } else {
      // 默认布局
      for (const card of cards) {
        const cardElement = document.createElement('div');
        cardElement.className = 'chips-box-card-item';
        cardElement.setAttribute('data-card-id', card.id);
        
        await this.renderCard(card, cardElement, options.cardOptions);
        cardsContainer.appendChild(cardElement);
      }
    }

    container.appendChild(cardsContainer);
  }

  /**
   * 应用元素选项
   */
  private _applyElementOptions(element: HTMLElement, options: RenderOptions): void {
    if (options.className) {
      element.classList.add(...options.className.split(' ').filter(Boolean));
    }

    if (options.style) {
      for (const [key, value] of Object.entries(options.style)) {
        element.style.setProperty(key, value);
      }
    }

    if (options.attributes) {
      for (const [key, value] of Object.entries(options.attributes)) {
        element.setAttribute(key, value);
      }
    }
  }

  /**
   * 创建懒加载观察器
   */
  private _createLazyObserver(): void {
    if (typeof IntersectionObserver === 'undefined') {
      return;
    }

    this._lazyObserver = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            const element = entry.target as HTMLElement;
            const instanceId = element.getAttribute('data-lazy-instance');
            
            if (instanceId) {
              // 触发懒加载渲染
              this._eventBus.emit('render:lazyLoad', { instanceId, element });
            }
          }
        }
      },
      {
        rootMargin: '100px',
        threshold: 0.1,
      }
    );
  }
}
```

**验收标准**:
- [ ] 卡片渲染正常
- [ ] 箱子渲染正常
- [ ] 实例管理正常
- [ ] 事件发布正常

---

### 2.4 单元测试

#### 任务 9.4.1: 创建 RendererEngine 单元测试
**优先级**: P0  
**描述**: 创建 `tests/unit/renderer/engine.test.ts`

**测试用例**:
1. 卡片渲染
2. 箱子渲染
3. 实例管理
4. 更新渲染
5. 销毁实例
6. 错误处理
7. 主题应用
8. 事件发布

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 覆盖率 ≥ 80%

---

## 3. 验收标准

### 3.1 功能验收

- [ ] 卡片渲染正常
- [ ] 箱子渲染正常
- [ ] 实例管理完整
- [ ] 更新渲染正常
- [ ] 销毁实例正常
- [ ] 主题应用正常
- [ ] 事件发布正常

### 3.2 性能要求

- [ ] 单卡片渲染 < 100ms
- [ ] 100 卡片箱子渲染 < 1s
- [ ] 内存占用稳定

### 3.3 代码质量

- [ ] 测试覆盖率 ≥ 80%
- [ ] 所有方法有 JSDoc 注释

---

## 4. 注意事项

1. **XSS 防护**: 封面 HTML 必须在沙盒中渲染
2. **内存管理**: 销毁实例时清理 DOM 引用
3. **性能优化**: 大量卡片使用虚拟滚动
4. **错误隔离**: 单卡片渲染错误不影响其他

---

**状态更新日期**: 2026-02-01
