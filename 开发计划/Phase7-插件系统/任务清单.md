# Phase7 - 插件系统

**状态**: 待开始  
**预计时间**: 3-4 天  
**依赖**: Phase3, Phase4

---

## 1. 阶段目标

- 实现 PluginSystem 插件管理系统
- 支持插件注册/卸载
- 实现插件生命周期管理
- 支持多种插件类型（基础卡片、布局、主题、工具）

---

## 2. 任务清单

### 2.1 插件类型定义

#### 任务 7.1.1: 定义插件类型
**优先级**: P0  
**描述**: 创建 `src/plugin/types.ts`

```typescript
import { ChipsId, ProtocolVersion } from '../types/base';

/**
 * 插件类型
 */
export type PluginType = 'base-card' | 'layout' | 'theme' | 'tool' | 'custom';

/**
 * 插件状态
 */
export type PluginStatus = 'registered' | 'loading' | 'active' | 'inactive' | 'error' | 'unloaded';

/**
 * 插件元数据
 */
export interface PluginMetadata {
  id: ChipsId;
  name: string;
  version: string;
  description?: string;
  author?: string;
  license?: string;
  homepage?: string;
  repository?: string;
  keywords?: string[];
  dependencies?: Record<string, string>;
  peerDependencies?: Record<string, string>;
  chipsVersion?: ProtocolVersion;
}

/**
 * 插件配置
 */
export interface PluginConfig {
  [key: string]: unknown;
}

/**
 * 插件上下文
 */
export interface PluginContext {
  sdk: unknown; // ChipsSDK 实例
  config: PluginConfig;
  logger: unknown; // Logger 实例
}

/**
 * 插件生命周期钩子
 */
export interface PluginLifecycle {
  /** 插件加载前 */
  onBeforeLoad?(context: PluginContext): Promise<void> | void;
  /** 插件加载后 */
  onLoad?(context: PluginContext): Promise<void> | void;
  /** 插件激活 */
  onActivate?(context: PluginContext): Promise<void> | void;
  /** 插件停用 */
  onDeactivate?(context: PluginContext): Promise<void> | void;
  /** 插件卸载前 */
  onBeforeUnload?(context: PluginContext): Promise<void> | void;
  /** 插件卸载后 */
  onUnload?(context: PluginContext): Promise<void> | void;
  /** 配置变更 */
  onConfigChange?(key: string, value: unknown, context: PluginContext): void;
}

/**
 * 基础插件接口
 */
export interface Plugin extends PluginLifecycle {
  metadata: PluginMetadata;
  type: PluginType;
  config?: PluginConfig;
}

/**
 * 基础卡片插件
 */
export interface BaseCardPlugin extends Plugin {
  type: 'base-card';
  /** 渲染卡片内容 */
  render(data: unknown, container: HTMLElement, context: PluginContext): Promise<void> | void;
  /** 获取默认配置 */
  getDefaultConfig?(): Record<string, unknown>;
  /** 获取编辑器 */
  getEditor?(context: PluginContext): unknown;
}

/**
 * 布局插件
 */
export interface LayoutPlugin extends Plugin {
  type: 'layout';
  /** 渲染布局 */
  render(items: HTMLElement[], container: HTMLElement, config: PluginConfig): Promise<void> | void;
  /** 获取布局默认配置 */
  getDefaultConfig?(): PluginConfig;
  /** 支持的配置项 */
  configSchema?: Record<string, unknown>;
}

/**
 * 主题插件
 */
export interface ThemePlugin extends Plugin {
  type: 'theme';
  /** CSS 变量 */
  variables: Record<string, string>;
  /** CSS 样式 */
  styles?: string;
  /** 父主题 */
  extends?: string;
}

/**
 * 工具插件
 */
export interface ToolPlugin extends Plugin {
  type: 'tool';
  /** 执行工具 */
  execute(context: PluginContext, ...args: unknown[]): Promise<unknown> | unknown;
}

/**
 * 插件注册选项
 */
export interface RegisterPluginOptions {
  config?: PluginConfig;
  autoActivate?: boolean;
}

/**
 * 插件实例信息
 */
export interface PluginInstance {
  plugin: Plugin;
  status: PluginStatus;
  config: PluginConfig;
  loadedAt?: string;
  activatedAt?: string;
  error?: Error;
}

/**
 * 插件查询选项
 */
export interface QueryPluginsOptions {
  type?: PluginType;
  status?: PluginStatus;
  keyword?: string;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持多种插件类型

---

### 2.2 PluginSystem 实现

#### 任务 7.2.1: 实现 PluginSystem 类
**优先级**: P0  
**描述**: 创建 `src/plugin/system.ts`

```typescript
import { CoreConnector, ChipsError, ErrorCodes } from '../core';
import { Logger } from '../logger';
import { ConfigManager } from '../config';
import { EventBus } from '../event';
import {
  Plugin,
  PluginType,
  PluginStatus,
  PluginMetadata,
  PluginConfig,
  PluginContext,
  PluginInstance,
  RegisterPluginOptions,
  QueryPluginsOptions,
  BaseCardPlugin,
  LayoutPlugin,
  ThemePlugin,
  ToolPlugin,
} from './types';
import { ChipsId } from '../types/base';

/**
 * 插件系统
 */
export class PluginSystem {
  private _connector: CoreConnector;
  private _logger: Logger;
  private _config: ConfigManager;
  private _eventBus: EventBus;
  private _plugins = new Map<ChipsId, PluginInstance>();
  private _sdk: unknown;

  constructor(
    connector: CoreConnector,
    logger: Logger,
    config: ConfigManager,
    eventBus: EventBus
  ) {
    this._connector = connector;
    this._logger = logger.createChild('PluginSystem');
    this._config = config;
    this._eventBus = eventBus;
  }

  /**
   * 设置 SDK 实例（用于插件上下文）
   */
  setSDK(sdk: unknown): void {
    this._sdk = sdk;
  }

  /**
   * 注册插件
   */
  async register(plugin: Plugin, options?: RegisterPluginOptions): Promise<void> {
    const opts = { autoActivate: true, ...options };
    const { id } = plugin.metadata;

    this._logger.debug('Registering plugin', { id, type: plugin.type });

    // 检查是否已注册
    if (this._plugins.has(id)) {
      throw new ChipsError(
        ErrorCodes.PLUGIN_CONFLICT,
        `Plugin already registered: ${id}`
      );
    }

    // 验证插件
    this._validatePlugin(plugin);

    // 创建插件实例
    const instance: PluginInstance = {
      plugin,
      status: 'registered',
      config: { ...plugin.config, ...opts.config },
    };

    this._plugins.set(id, instance);

    // 发布事件
    await this._eventBus.emit('plugin:registered', { plugin, options: opts });

    this._logger.info('Plugin registered', { id, type: plugin.type });

    // 自动激活
    if (opts.autoActivate) {
      await this.activate(id);
    }
  }

  /**
   * 卸载插件
   */
  async unregister(pluginId: ChipsId): Promise<void> {
    this._logger.debug('Unregistering plugin', { id: pluginId });

    const instance = this._plugins.get(pluginId);
    if (!instance) {
      throw new ChipsError(ErrorCodes.PLUGIN_NOT_FOUND, `Plugin not found: ${pluginId}`);
    }

    // 先停用
    if (instance.status === 'active') {
      await this.deactivate(pluginId);
    }

    // 调用卸载钩子
    const context = this._createContext(instance);
    try {
      await instance.plugin.onBeforeUnload?.(context);
      await instance.plugin.onUnload?.(context);
    } catch (error) {
      this._logger.warn('Plugin unload hook error', { id: pluginId, error });
    }

    instance.status = 'unloaded';
    this._plugins.delete(pluginId);

    // 发布事件
    await this._eventBus.emit('plugin:unregistered', { pluginId });

    this._logger.info('Plugin unregistered', { id: pluginId });
  }

  /**
   * 激活插件
   */
  async activate(pluginId: ChipsId): Promise<void> {
    this._logger.debug('Activating plugin', { id: pluginId });

    const instance = this._plugins.get(pluginId);
    if (!instance) {
      throw new ChipsError(ErrorCodes.PLUGIN_NOT_FOUND, `Plugin not found: ${pluginId}`);
    }

    if (instance.status === 'active') {
      return;
    }

    instance.status = 'loading';
    const context = this._createContext(instance);

    try {
      // 调用加载钩子
      await instance.plugin.onBeforeLoad?.(context);
      await instance.plugin.onLoad?.(context);
      instance.loadedAt = new Date().toISOString();

      // 调用激活钩子
      await instance.plugin.onActivate?.(context);
      instance.activatedAt = new Date().toISOString();
      instance.status = 'active';
      instance.error = undefined;

      // 发布事件
      await this._eventBus.emit('plugin:activated', { pluginId, plugin: instance.plugin });

      this._logger.info('Plugin activated', { id: pluginId });
    } catch (error) {
      instance.status = 'error';
      instance.error = error instanceof Error ? error : new Error(String(error));
      
      this._logger.error('Plugin activation failed', { id: pluginId, error });
      
      throw new ChipsError(
        ErrorCodes.PLUGIN_LOAD_FAILED,
        `Failed to activate plugin: ${pluginId}`,
        { error: String(error) }
      );
    }
  }

  /**
   * 停用插件
   */
  async deactivate(pluginId: ChipsId): Promise<void> {
    this._logger.debug('Deactivating plugin', { id: pluginId });

    const instance = this._plugins.get(pluginId);
    if (!instance) {
      throw new ChipsError(ErrorCodes.PLUGIN_NOT_FOUND, `Plugin not found: ${pluginId}`);
    }

    if (instance.status !== 'active') {
      return;
    }

    const context = this._createContext(instance);

    try {
      await instance.plugin.onDeactivate?.(context);
      instance.status = 'inactive';
      instance.activatedAt = undefined;

      // 发布事件
      await this._eventBus.emit('plugin:deactivated', { pluginId });

      this._logger.info('Plugin deactivated', { id: pluginId });
    } catch (error) {
      this._logger.warn('Plugin deactivation error', { id: pluginId, error });
      instance.status = 'inactive';
    }
  }

  /**
   * 获取插件
   */
  get<T extends Plugin = Plugin>(pluginId: ChipsId): T | undefined {
    const instance = this._plugins.get(pluginId);
    return instance?.plugin as T | undefined;
  }

  /**
   * 获取插件实例
   */
  getInstance(pluginId: ChipsId): PluginInstance | undefined {
    return this._plugins.get(pluginId);
  }

  /**
   * 获取插件状态
   */
  getStatus(pluginId: ChipsId): PluginStatus | undefined {
    return this._plugins.get(pluginId)?.status;
  }

  /**
   * 检查插件是否已注册
   */
  has(pluginId: ChipsId): boolean {
    return this._plugins.has(pluginId);
  }

  /**
   * 检查插件是否激活
   */
  isActive(pluginId: ChipsId): boolean {
    return this._plugins.get(pluginId)?.status === 'active';
  }

  /**
   * 获取所有插件
   */
  getAll(options?: QueryPluginsOptions): PluginInstance[] {
    let plugins = Array.from(this._plugins.values());

    if (options?.type) {
      plugins = plugins.filter((p) => p.plugin.type === options.type);
    }

    if (options?.status) {
      plugins = plugins.filter((p) => p.status === options.status);
    }

    if (options?.keyword) {
      const keyword = options.keyword.toLowerCase();
      plugins = plugins.filter(
        (p) =>
          p.plugin.metadata.name.toLowerCase().includes(keyword) ||
          p.plugin.metadata.description?.toLowerCase().includes(keyword) ||
          p.plugin.metadata.keywords?.some((k) => k.toLowerCase().includes(keyword))
      );
    }

    return plugins;
  }

  /**
   * 按类型获取插件
   */
  getByType<T extends Plugin>(type: PluginType): T[] {
    return this.getAll({ type }).map((i) => i.plugin as T);
  }

  /**
   * 获取基础卡片插件
   */
  getBaseCardPlugins(): BaseCardPlugin[] {
    return this.getByType<BaseCardPlugin>('base-card');
  }

  /**
   * 获取布局插件
   */
  getLayoutPlugins(): LayoutPlugin[] {
    return this.getByType<LayoutPlugin>('layout');
  }

  /**
   * 获取主题插件
   */
  getThemePlugins(): ThemePlugin[] {
    return this.getByType<ThemePlugin>('theme');
  }

  /**
   * 获取工具插件
   */
  getToolPlugins(): ToolPlugin[] {
    return this.getByType<ToolPlugin>('tool');
  }

  /**
   * 更新插件配置
   */
  async updateConfig(pluginId: ChipsId, config: Partial<PluginConfig>): Promise<void> {
    const instance = this._plugins.get(pluginId);
    if (!instance) {
      throw new ChipsError(ErrorCodes.PLUGIN_NOT_FOUND, `Plugin not found: ${pluginId}`);
    }

    const context = this._createContext(instance);

    for (const [key, value] of Object.entries(config)) {
      const oldValue = instance.config[key];
      instance.config[key] = value;

      try {
        instance.plugin.onConfigChange?.(key, value, context);
      } catch (error) {
        this._logger.warn('Plugin config change handler error', { id: pluginId, key, error });
      }
    }

    // 发布事件
    await this._eventBus.emit('plugin:configChanged', { pluginId, config });
  }

  /**
   * 获取插件配置
   */
  getConfig(pluginId: ChipsId): PluginConfig | undefined {
    return this._plugins.get(pluginId)?.config;
  }

  /**
   * 获取插件数量
   */
  get count(): number {
    return this._plugins.size;
  }

  /**
   * 获取活跃插件数量
   */
  get activeCount(): number {
    return this.getAll({ status: 'active' }).length;
  }

  /**
   * 验证插件
   */
  private _validatePlugin(plugin: Plugin): void {
    const { metadata, type } = plugin;

    if (!metadata?.id) {
      throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Plugin must have an id');
    }

    if (!metadata?.name) {
      throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Plugin must have a name');
    }

    if (!metadata?.version) {
      throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Plugin must have a version');
    }

    if (!type) {
      throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Plugin must have a type');
    }

    // 类型特定验证
    switch (type) {
      case 'base-card':
        if (typeof (plugin as BaseCardPlugin).render !== 'function') {
          throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Base card plugin must have a render method');
        }
        break;
      case 'layout':
        if (typeof (plugin as LayoutPlugin).render !== 'function') {
          throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Layout plugin must have a render method');
        }
        break;
      case 'theme':
        if (!(plugin as ThemePlugin).variables) {
          throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Theme plugin must have variables');
        }
        break;
      case 'tool':
        if (typeof (plugin as ToolPlugin).execute !== 'function') {
          throw new ChipsError(ErrorCodes.PLUGIN_INVALID, 'Tool plugin must have an execute method');
        }
        break;
    }
  }

  /**
   * 创建插件上下文
   */
  private _createContext(instance: PluginInstance): PluginContext {
    return {
      sdk: this._sdk,
      config: instance.config,
      logger: this._logger.createChild(instance.plugin.metadata.id),
    };
  }
}
```

**验收标准**:
- [ ] 插件注册/卸载正常
- [ ] 插件激活/停用正常
- [ ] 生命周期钩子调用正确
- [ ] 插件查询功能完整

---

### 2.3 单元测试

#### 任务 7.3.1: 创建 PluginSystem 单元测试
**优先级**: P0  
**描述**: 创建 `tests/unit/plugin/system.test.ts`

**测试用例**:
1. 插件注册
2. 插件卸载
3. 插件激活/停用
4. 生命周期钩子
5. 插件验证
6. 配置更新
7. 按类型查询
8. 事件发布

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 覆盖率 ≥ 85%

---

## 3. 验收标准

### 3.1 功能验收

- [ ] 插件注册正常
- [ ] 插件卸载正常
- [ ] 插件激活/停用正常
- [ ] 生命周期钩子调用正确
- [ ] 支持四种插件类型
- [ ] 配置管理完整
- [ ] 事件发布正常

### 3.2 代码质量

- [ ] 测试覆盖率 ≥ 85%
- [ ] 所有方法有 JSDoc 注释
- [ ] 错误处理完善

---

## 4. 注意事项

1. **插件隔离**: 插件之间不应直接通信
2. **错误处理**: 单个插件错误不应影响其他插件
3. **资源清理**: 卸载插件时确保资源释放
4. **版本兼容**: 检查插件与 SDK 版本兼容性

---

**状态更新日期**: 2026-02-01
