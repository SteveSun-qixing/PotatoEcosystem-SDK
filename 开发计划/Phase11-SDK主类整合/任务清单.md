# Phase11 - SDK 主类整合

**状态**: 待开始  
**预计时间**: 2-3 天  
**依赖**: Phase2 - Phase10

---

## 1. 阶段目标

- 实现 ChipsSDK 主类
- 整合所有模块
- 实现统一的初始化流程
- 提供便捷的快捷方法

---

## 2. 任务清单

### 2.1 SDK 主类实现

#### 任务 11.1.1: 实现 ChipsSDK 类
**优先级**: P0  
**描述**: 创建 `src/sdk.ts`

```typescript
import { CoreConnector, ConnectorOptions, ChipsError, ErrorCodes } from './core';
import { Logger, LoggerOptions, LogLevel } from './logger';
import { ConfigManager, ConfigManagerOptions } from './config';
import { EventBus, EventBusOptions } from './event';
import { I18nManager, I18nManagerOptions } from './i18n';
import { FileAPI } from './api/file-api';
import { CardAPI, CreateCardOptions, UpdateCardOptions } from './api/card-api';
import { BoxAPI, CreateBoxOptions, UpdateBoxOptions } from './api/box-api';
import { PluginSystem, Plugin, RegisterPluginOptions } from './plugin';
import { ThemeManager, Theme, ApplyThemeOptions } from './theme';
import { ResourceManager, LoadResourceOptions, Resource } from './resource';
import { RendererEngine, RenderOptions, CardRenderOptions, BoxRenderOptions, RenderResult } from './renderer';
import { Card } from './types/card';
import { Box } from './types/box';
import { ChipsId } from './types/base';

/**
 * SDK 初始化选项
 */
export interface ChipsSDKOptions {
  /** Core 连接配置 */
  connector?: ConnectorOptions;
  /** 日志配置 */
  logger?: LoggerOptions;
  /** 配置管理配置 */
  config?: ConfigManagerOptions;
  /** 事件总线配置 */
  eventBus?: EventBusOptions;
  /** 多语言配置 */
  i18n?: I18nManagerOptions;
  /** 是否自动连接 */
  autoConnect?: boolean;
  /** 是否启用调试模式 */
  debug?: boolean;
}

/**
 * SDK 状态
 */
export type SDKStatus = 'created' | 'initializing' | 'ready' | 'error' | 'destroyed';

/**
 * SDK 版本信息
 */
export interface SDKVersion {
  version: string;
  build: string;
  timestamp: string;
}

/**
 * Chips SDK 主类
 */
export class ChipsSDK {
  private static _instance: ChipsSDK | null = null;

  // 核心模块
  private _connector: CoreConnector;
  private _logger: Logger;
  private _config: ConfigManager;
  private _eventBus: EventBus;
  private _i18n: I18nManager;

  // 功能模块
  private _fileApi: FileAPI;
  private _cardApi: CardAPI;
  private _boxApi: BoxAPI;
  private _pluginSystem: PluginSystem;
  private _themeManager: ThemeManager;
  private _resourceManager: ResourceManager;
  private _renderer: RendererEngine;

  // 状态
  private _status: SDKStatus = 'created';
  private _options: ChipsSDKOptions;

  // 版本信息
  static readonly VERSION: SDKVersion = {
    version: '1.0.0',
    build: 'alpha',
    timestamp: new Date().toISOString(),
  };

  constructor(options: ChipsSDKOptions = {}) {
    this._options = {
      autoConnect: true,
      debug: false,
      ...options,
    };

    // 初始化核心模块
    this._connector = new CoreConnector(options.connector);
    this._logger = new Logger('ChipsSDK', {
      level: options.debug ? 'debug' : 'info',
      ...options.logger,
    });
    this._config = new ConfigManager(options.config);
    this._eventBus = new EventBus(options.eventBus);
    this._i18n = new I18nManager(options.i18n);

    // 初始化功能模块
    this._fileApi = new FileAPI(this._connector, this._logger, this._config);
    this._cardApi = new CardAPI(this._connector, this._logger, this._config, this._eventBus, this._fileApi);
    this._boxApi = new BoxAPI(this._connector, this._logger, this._config, this._eventBus, this._fileApi, this._cardApi);
    this._pluginSystem = new PluginSystem(this._connector, this._logger, this._config, this._eventBus);
    this._themeManager = new ThemeManager(this._connector, this._logger, this._config, this._eventBus, this._pluginSystem);
    this._resourceManager = new ResourceManager(this._connector, this._logger, this._config, this._eventBus);
    this._renderer = new RendererEngine(
      this._connector,
      this._logger,
      this._config,
      this._eventBus,
      this._pluginSystem,
      this._themeManager
    );

    // 设置插件系统的 SDK 引用
    this._pluginSystem.setSDK(this);

    this._logger.info('ChipsSDK created', { version: ChipsSDK.VERSION.version });
  }

  /**
   * 获取单例实例
   */
  static getInstance(options?: ChipsSDKOptions): ChipsSDK {
    if (!ChipsSDK._instance) {
      ChipsSDK._instance = new ChipsSDK(options);
    }
    return ChipsSDK._instance;
  }

  /**
   * 初始化 SDK
   */
  async initialize(): Promise<void> {
    if (this._status === 'ready') {
      return;
    }

    if (this._status === 'initializing') {
      throw new ChipsError('SDK-1001', 'SDK is already initializing');
    }

    this._status = 'initializing';
    this._logger.info('SDK initializing...');

    try {
      // 连接到 Core
      if (this._options.autoConnect) {
        await this._connector.connect();
        this._logger.debug('Connected to Core');
      }

      // 初始化配置
      await this._config.initialize(this._connector);
      this._logger.debug('Config initialized');

      // 初始化渲染引擎
      await this._renderer.initialize();
      this._logger.debug('Renderer initialized');

      // 发布就绪事件
      await this._eventBus.emit('sdk:ready', { sdk: this });

      this._status = 'ready';
      this._logger.info('SDK initialized successfully');
    } catch (error) {
      this._status = 'error';
      this._logger.error('SDK initialization failed', { error });
      throw error;
    }
  }

  /**
   * 销毁 SDK
   */
  async destroy(): Promise<void> {
    if (this._status === 'destroyed') {
      return;
    }

    this._logger.info('SDK destroying...');

    try {
      // 清理渲染实例
      await this._renderer.cleanup();

      // 断开连接
      this._connector.disconnect();

      // 清理缓存
      this._resourceManager.clearCache();
      this._fileApi.clearCache();

      // 清除事件订阅
      this._eventBus.clear();

      // 发布销毁事件
      await this._eventBus.emit('sdk:destroyed', {});

      this._status = 'destroyed';

      // 清除单例
      if (ChipsSDK._instance === this) {
        ChipsSDK._instance = null;
      }

      this._logger.info('SDK destroyed');
    } catch (error) {
      this._logger.error('SDK destroy error', { error });
    }
  }

  // ========== 状态和配置 ==========

  /**
   * 获取 SDK 状态
   */
  get status(): SDKStatus {
    return this._status;
  }

  /**
   * 检查是否就绪
   */
  get isReady(): boolean {
    return this._status === 'ready';
  }

  /**
   * 获取版本信息
   */
  get version(): SDKVersion {
    return ChipsSDK.VERSION;
  }

  // ========== 模块访问器 ==========

  /** Core 连接器 */
  get connector(): CoreConnector {
    return this._connector;
  }

  /** 日志系统 */
  get logger(): Logger {
    return this._logger;
  }

  /** 配置管理 */
  get config(): ConfigManager {
    return this._config;
  }

  /** 事件总线 */
  get events(): EventBus {
    return this._eventBus;
  }

  /** 多语言系统 */
  get i18n(): I18nManager {
    return this._i18n;
  }

  /** 文件 API */
  get file(): FileAPI {
    return this._fileApi;
  }

  /** 卡片 API */
  get card(): CardAPI {
    return this._cardApi;
  }

  /** 箱子 API */
  get box(): BoxAPI {
    return this._boxApi;
  }

  /** 插件系统 */
  get plugins(): PluginSystem {
    return this._pluginSystem;
  }

  /** 主题管理器 */
  get themes(): ThemeManager {
    return this._themeManager;
  }

  /** 资源管理器 */
  get resources(): ResourceManager {
    return this._resourceManager;
  }

  /** 渲染引擎 */
  get renderer(): RendererEngine {
    return this._renderer;
  }

  // ========== 快捷方法 ==========

  /**
   * 创建卡片
   */
  async createCard(options: CreateCardOptions): Promise<Card> {
    this._ensureReady();
    return this._cardApi.create(options);
  }

  /**
   * 加载卡片
   */
  async loadCard(path: string): Promise<Card> {
    this._ensureReady();
    return this._fileApi.loadCard(path);
  }

  /**
   * 保存卡片
   */
  async saveCard(path: string, card: Card, overwrite = false): Promise<void> {
    this._ensureReady();
    return this._cardApi.save(path, card, overwrite);
  }

  /**
   * 创建箱子
   */
  async createBox(options: CreateBoxOptions): Promise<Box> {
    this._ensureReady();
    return this._boxApi.create(options);
  }

  /**
   * 加载箱子
   */
  async loadBox(path: string): Promise<Box> {
    this._ensureReady();
    return this._fileApi.loadBox(path);
  }

  /**
   * 保存箱子
   */
  async saveBox(path: string, box: Box, overwrite = false): Promise<void> {
    this._ensureReady();
    return this._boxApi.save(path, box, overwrite);
  }

  /**
   * 渲染卡片
   */
  async renderCard(card: Card, container: HTMLElement, options?: CardRenderOptions): Promise<RenderResult> {
    this._ensureReady();
    return this._renderer.renderCard(card, container, options);
  }

  /**
   * 渲染箱子
   */
  async renderBox(box: Box, container: HTMLElement, cards: Card[], options?: BoxRenderOptions): Promise<RenderResult> {
    this._ensureReady();
    return this._renderer.renderBox(box, container, cards, options);
  }

  /**
   * 注册插件
   */
  async registerPlugin(plugin: Plugin, options?: RegisterPluginOptions): Promise<void> {
    return this._pluginSystem.register(plugin, options);
  }

  /**
   * 应用主题
   */
  async applyTheme(themeId: ChipsId, options?: ApplyThemeOptions): Promise<void> {
    return this._themeManager.apply(themeId, options);
  }

  /**
   * 加载资源
   */
  async loadResource(uri: string, options?: LoadResourceOptions): Promise<Resource> {
    this._ensureReady();
    return this._resourceManager.load(uri, options);
  }

  /**
   * 订阅事件
   */
  on<T = unknown>(eventType: string, handler: (data: T) => void | Promise<void>): string {
    return this._eventBus.on(eventType, handler);
  }

  /**
   * 取消订阅事件
   */
  off(eventType: string, handlerOrId?: ((data: unknown) => void) | string): void {
    this._eventBus.off(eventType, handlerOrId);
  }

  /**
   * 发布事件
   */
  async emit<T = unknown>(eventType: string, data: T): Promise<void> {
    return this._eventBus.emit(eventType, data);
  }

  /**
   * 设置日志级别
   */
  setLogLevel(level: LogLevel): void {
    this._logger.setLevel(level);
  }

  /**
   * 获取翻译
   */
  t(key: string, params?: Record<string, string | number>): string {
    return this._i18n.t(key, params);
  }

  /**
   * 设置语言
   */
  setLocale(locale: string): void {
    this._i18n.setLocale(locale);
  }

  // ========== 私有方法 ==========

  /**
   * 确保 SDK 已就绪
   */
  private _ensureReady(): void {
    if (this._status !== 'ready') {
      throw new ChipsError('SDK-1002', 'SDK is not ready. Call initialize() first.');
    }
  }
}

// 导出便捷函数
export function createSDK(options?: ChipsSDKOptions): ChipsSDK {
  return new ChipsSDK(options);
}

export function getSDK(): ChipsSDK {
  return ChipsSDK.getInstance();
}
```

**验收标准**:
- [ ] 初始化流程正常
- [ ] 模块整合完整
- [ ] 快捷方法可用
- [ ] 单例模式支持

---

### 2.2 入口文件

#### 任务 11.2.1: 创建入口文件
**优先级**: P0  
**描述**: 创建 `src/index.ts`

```typescript
// SDK 主类
export { ChipsSDK, ChipsSDKOptions, SDKStatus, SDKVersion, createSDK, getSDK } from './sdk';

// 核心模块
export {
  CoreConnector,
  ConnectorOptions,
  RequestParams,
  ResponseData,
  ChipsError,
  ConnectionError,
  TimeoutError,
  ProtocolError,
  RouteError,
  FileError,
  ValidationError,
  ErrorCodes,
} from './core';

// 类型定义
export type {
  ChipsId,
  Timestamp,
  Tag,
  ProtocolVersion,
  Status,
  LogLevel,
} from './types/base';

export type {
  Card,
  CardMetadata,
  CardStructure,
  CardManifest,
  BaseCardInfo,
  ResourceInfo,
  CreateCardOptions,
  UpdateCardOptions,
  BaseCardData,
  CardResource,
} from './types/card';

export type {
  Box,
  BoxMetadata,
  BoxStructure,
  BoxContent,
  BoxCardInfo,
  CreateBoxOptions,
  UpdateBoxOptions,
  AddCardToBoxOptions,
  LayoutConfig,
} from './types/box';

// API 模块
export { FileAPI } from './api/file-api';
export type { LoadOptions, SaveOptions, FileInfo, FileValidationResult } from './api/file-types';
export { CardAPI } from './api/card-api';
export { BoxAPI } from './api/box-api';

// 渲染模块
export { RendererEngine } from './renderer';
export type {
  RenderMode,
  RenderStatus,
  RenderOptions,
  CardRenderOptions,
  BoxRenderOptions,
  RenderResult,
  RenderInstance,
} from './renderer/types';

// 插件模块
export { PluginSystem } from './plugin';
export type {
  Plugin,
  PluginType,
  PluginStatus,
  PluginMetadata,
  PluginConfig,
  PluginContext,
  PluginLifecycle,
  BaseCardPlugin,
  LayoutPlugin,
  ThemePlugin,
  ToolPlugin,
  RegisterPluginOptions,
  PluginInstance,
} from './plugin/types';

// 主题模块
export { ThemeManager } from './theme';
export type {
  Theme,
  ThemeMetadata,
  ThemeVariables,
  ThemeScope,
  ApplyThemeOptions,
} from './theme/types';

// 资源模块
export { ResourceManager } from './resource';
export type {
  Resource,
  ResourceProtocol,
  ResourceType,
  LoadResourceOptions,
  ParsedUri,
} from './resource/types';

// 事件模块
export { EventBus } from './event';
export type { EventData, EventHandler, EventSubscription } from './event/types';

// 配置模块
export { ConfigManager } from './config';
export type { ConfigSchema, ConfigManagerOptions, ConfigChangeHandler } from './config/types';

// 日志模块
export { Logger } from './logger';
export type { LogEntry, LoggerOptions, LogHandler } from './logger/types';

// 多语言模块
export { I18nManager } from './i18n';
export type { Locale, Translation, I18nManagerOptions } from './i18n/types';

// 工具函数
export { generateId, isValidId, generateUuid } from './utils/id';
export { normalizePath, getExtension, getFileName, getDirPath, joinPath, isSafePath, isCardFile, isBoxFile } from './utils/path';
export { validateCardMetadata, validateBoxMetadata, validateProtocolVersion, validateTimestamp } from './utils/validation';
export { delay, withTimeout, retry, concurrent } from './utils/async';
```

**验收标准**:
- [ ] 所有模块正确导出
- [ ] 类型导出完整

---

### 2.3 单元测试

#### 任务 11.3.1: 创建 ChipsSDK 单元测试
**优先级**: P0  
**描述**: 创建 `tests/unit/sdk.test.ts`

**测试用例**:
1. SDK 创建
2. SDK 初始化
3. SDK 销毁
4. 单例模式
5. 快捷方法
6. 状态管理
7. 事件发布

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 覆盖率 ≥ 85%

---

## 3. 验收标准

### 3.1 功能验收

- [ ] SDK 初始化正常
- [ ] SDK 销毁正常
- [ ] 所有模块可访问
- [ ] 快捷方法可用
- [ ] 单例模式正常
- [ ] 状态管理正确

### 3.2 性能要求

- [ ] SDK 初始化 < 200ms
- [ ] 首次 API 调用 < 100ms

### 3.3 代码质量

- [ ] 测试覆盖率 ≥ 85%
- [ ] 所有方法有 JSDoc 注释

---

## 4. 注意事项

1. **初始化顺序**: 注意模块依赖关系
2. **资源释放**: destroy 时清理所有资源
3. **状态检查**: 操作前检查 SDK 状态
4. **错误传播**: 统一错误处理

---

**状态更新日期**: 2026-02-01
