# Phase3 - 基础支撑模块

**状态**: 待开始  
**预计时间**: 2-3 天  
**依赖**: Phase1, Phase2

---

## 1. 阶段目标

- 实现 Logger 日志系统
- 实现 ConfigManager 配置管理
- 实现 EventBus 事件系统
- 实现 I18nManager 多语言系统

---

## 2. 任务清单

### 2.1 Logger 日志系统

#### 任务 3.1.1: 定义日志类型
**优先级**: P0  
**描述**: 创建 `src/logger/types.ts`

```typescript
export type LogLevel = 'debug' | 'info' | 'warn' | 'error';

export interface LogEntry {
  level: LogLevel;
  timestamp: string;
  module: string;
  message: string;
  data?: Record<string, unknown>;
}

export interface LoggerOptions {
  level?: LogLevel;
  prefix?: string;
  enableConsole?: boolean;
  enableRemote?: boolean;
  maxHistory?: number;
}

export interface LogHandler {
  (entry: LogEntry): void;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持多级别日志

---

#### 任务 3.1.2: 实现 Logger 类
**优先级**: P0  
**描述**: 创建 `src/logger/logger.ts`

```typescript
import { LogLevel, LogEntry, LoggerOptions, LogHandler } from './types';

const LOG_LEVELS: Record<LogLevel, number> = {
  debug: 0,
  info: 1,
  warn: 2,
  error: 3,
};

const DEFAULT_OPTIONS: Required<LoggerOptions> = {
  level: 'info',
  prefix: 'ChipsSDK',
  enableConsole: true,
  enableRemote: false,
  maxHistory: 1000,
};

/**
 * 日志系统
 */
export class Logger {
  private _options: Required<LoggerOptions>;
  private _history: LogEntry[] = [];
  private _handlers: Set<LogHandler> = new Set();
  private _module: string;

  constructor(module: string, options?: LoggerOptions) {
    this._module = module;
    this._options = { ...DEFAULT_OPTIONS, ...options };
  }

  /**
   * 设置日志级别
   */
  setLevel(level: LogLevel): void {
    this._options.level = level;
  }

  /**
   * 获取当前日志级别
   */
  getLevel(): LogLevel {
    return this._options.level;
  }

  /**
   * Debug 级别日志
   */
  debug(message: string, data?: Record<string, unknown>): void {
    this._log('debug', message, data);
  }

  /**
   * Info 级别日志
   */
  info(message: string, data?: Record<string, unknown>): void {
    this._log('info', message, data);
  }

  /**
   * Warn 级别日志
   */
  warn(message: string, data?: Record<string, unknown>): void {
    this._log('warn', message, data);
  }

  /**
   * Error 级别日志
   */
  error(message: string, data?: Record<string, unknown>): void {
    this._log('error', message, data);
  }

  /**
   * 添加日志处理器
   */
  addHandler(handler: LogHandler): void {
    this._handlers.add(handler);
  }

  /**
   * 移除日志处理器
   */
  removeHandler(handler: LogHandler): void {
    this._handlers.delete(handler);
  }

  /**
   * 获取日志历史
   */
  getHistory(level?: LogLevel, limit?: number): LogEntry[] {
    let entries = this._history;
    
    if (level) {
      entries = entries.filter((e) => e.level === level);
    }
    
    if (limit) {
      entries = entries.slice(-limit);
    }
    
    return entries;
  }

  /**
   * 清空日志历史
   */
  clearHistory(): void {
    this._history = [];
  }

  /**
   * 创建子 Logger
   */
  createChild(subModule: string): Logger {
    return new Logger(`${this._module}:${subModule}`, this._options);
  }

  /**
   * 记录日志
   */
  private _log(level: LogLevel, message: string, data?: Record<string, unknown>): void {
    if (LOG_LEVELS[level] < LOG_LEVELS[this._options.level]) {
      return;
    }

    const entry: LogEntry = {
      level,
      timestamp: new Date().toISOString(),
      module: this._module,
      message,
      data,
    };

    // 添加到历史
    this._history.push(entry);
    if (this._history.length > this._options.maxHistory) {
      this._history.shift();
    }

    // 控制台输出
    if (this._options.enableConsole) {
      this._logToConsole(entry);
    }

    // 调用处理器
    for (const handler of this._handlers) {
      try {
        handler(entry);
      } catch (error) {
        console.error('Log handler error:', error);
      }
    }
  }

  /**
   * 输出到控制台
   */
  private _logToConsole(entry: LogEntry): void {
    const prefix = `[${entry.timestamp}] [${this._options.prefix}] [${entry.module}]`;
    const msg = `${prefix} ${entry.message}`;

    switch (entry.level) {
      case 'debug':
        console.debug(msg, entry.data ?? '');
        break;
      case 'info':
        console.info(msg, entry.data ?? '');
        break;
      case 'warn':
        console.warn(msg, entry.data ?? '');
        break;
      case 'error':
        console.error(msg, entry.data ?? '');
        break;
    }
  }
}
```

**验收标准**:
- [ ] 支持四种日志级别
- [ ] 支持日志历史记录
- [ ] 支持自定义处理器
- [ ] 支持创建子 Logger

---

#### 任务 3.1.3: 创建 Logger 单元测试
**优先级**: P0  
**描述**: 创建 `tests/unit/logger/logger.test.ts`

**验收标准**:
- [ ] 日志级别测试通过
- [ ] 历史记录测试通过
- [ ] 处理器测试通过
- [ ] 覆盖率 ≥ 90%

---

### 2.2 ConfigManager 配置管理

#### 任务 3.2.1: 定义配置类型
**优先级**: P0  
**描述**: 创建 `src/config/types.ts`

```typescript
export interface ConfigSchema {
  [key: string]: {
    type: 'string' | 'number' | 'boolean' | 'object' | 'array';
    default?: unknown;
    required?: boolean;
    validate?: (value: unknown) => boolean;
  };
}

export interface ConfigManagerOptions {
  schema?: ConfigSchema;
  defaults?: Record<string, unknown>;
  persistent?: boolean;
}

export type ConfigChangeHandler = (key: string, newValue: unknown, oldValue: unknown) => void;
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持配置验证

---

#### 任务 3.2.2: 实现 ConfigManager 类
**优先级**: P0  
**描述**: 创建 `src/config/manager.ts`

```typescript
import { CoreConnector } from '../core';
import { ConfigSchema, ConfigManagerOptions, ConfigChangeHandler } from './types';

/**
 * 默认配置
 */
const SDK_DEFAULTS: Record<string, unknown> = {
  'sdk.version': '1.0.0',
  'sdk.debug': false,
  'timeout.default': 30000,
  'timeout.file': 60000,
  'timeout.render': 10000,
  'cache.enabled': true,
  'cache.maxSize': 100,
  'i18n.defaultLocale': 'zh-CN',
  'i18n.fallbackLocale': 'en-US',
  'logger.level': 'info',
  'logger.enableConsole': true,
};

/**
 * 配置管理器
 */
export class ConfigManager {
  private _config = new Map<string, unknown>();
  private _changeHandlers = new Map<string, Set<ConfigChangeHandler>>();
  private _connector: CoreConnector | null = null;
  private _options: ConfigManagerOptions;
  private _initialized = false;

  constructor(options: ConfigManagerOptions = {}) {
    this._options = options;
    
    // 初始化默认配置
    for (const [key, value] of Object.entries(SDK_DEFAULTS)) {
      this._config.set(key, value);
    }
    
    // 应用自定义默认值
    if (options.defaults) {
      for (const [key, value] of Object.entries(options.defaults)) {
        this._config.set(key, value);
      }
    }
  }

  /**
   * 初始化配置管理器
   */
  async initialize(connector: CoreConnector): Promise<void> {
    this._connector = connector;
    
    // 从 Core 加载持久化配置
    if (this._options.persistent) {
      try {
        const response = await connector.request({
          service: 'config',
          method: 'getAll',
          payload: {},
        });
        
        if (response.success && response.data) {
          const remoteConfig = response.data as Record<string, unknown>;
          for (const [key, value] of Object.entries(remoteConfig)) {
            if (this._validateValue(key, value)) {
              this._config.set(key, value);
            }
          }
        }
      } catch (error) {
        console.warn('Failed to load remote config:', error);
      }
    }
    
    this._initialized = true;
  }

  /**
   * 获取配置值
   */
  get<T = unknown>(key: string, defaultValue?: T): T {
    if (this._config.has(key)) {
      return this._config.get(key) as T;
    }
    return defaultValue as T;
  }

  /**
   * 设置配置值
   */
  async set(key: string, value: unknown): Promise<void> {
    // 验证配置值
    if (!this._validateValue(key, value)) {
      throw new Error(`Invalid config value for key: ${key}`);
    }

    const oldValue = this._config.get(key);
    this._config.set(key, value);

    // 触发变更事件
    this._notifyChange(key, value, oldValue);

    // 持久化到 Core
    if (this._options.persistent && this._connector) {
      await this._connector.request({
        service: 'config',
        method: 'set',
        payload: { key, value },
      });
    }
  }

  /**
   * 检查配置项是否存在
   */
  has(key: string): boolean {
    return this._config.has(key);
  }

  /**
   * 删除配置项
   */
  async delete(key: string): Promise<void> {
    const oldValue = this._config.get(key);
    this._config.delete(key);
    
    this._notifyChange(key, undefined, oldValue);

    if (this._options.persistent && this._connector) {
      await this._connector.request({
        service: 'config',
        method: 'delete',
        payload: { key },
      });
    }
  }

  /**
   * 获取所有配置
   */
  getAll(): Record<string, unknown> {
    const result: Record<string, unknown> = {};
    for (const [key, value] of this._config) {
      result[key] = value;
    }
    return result;
  }

  /**
   * 监听配置变更
   */
  onChange(key: string, handler: ConfigChangeHandler): void {
    if (!this._changeHandlers.has(key)) {
      this._changeHandlers.set(key, new Set());
    }
    this._changeHandlers.get(key)!.add(handler);
  }

  /**
   * 取消监听配置变更
   */
  offChange(key: string, handler?: ConfigChangeHandler): void {
    if (!handler) {
      this._changeHandlers.delete(key);
    } else {
      this._changeHandlers.get(key)?.delete(handler);
    }
  }

  /**
   * 重置为默认配置
   */
  reset(): void {
    this._config.clear();
    for (const [key, value] of Object.entries(SDK_DEFAULTS)) {
      this._config.set(key, value);
    }
    if (this._options.defaults) {
      for (const [key, value] of Object.entries(this._options.defaults)) {
        this._config.set(key, value);
      }
    }
  }

  /**
   * 验证配置值
   */
  private _validateValue(key: string, value: unknown): boolean {
    if (!this._options.schema) {
      return true;
    }
    
    const schema = this._options.schema[key];
    if (!schema) {
      return true;
    }
    
    // 类型检查
    const type = typeof value;
    if (Array.isArray(value) && schema.type === 'array') {
      return true;
    }
    if (type !== schema.type && schema.type !== 'object') {
      return false;
    }
    
    // 自定义验证
    if (schema.validate && !schema.validate(value)) {
      return false;
    }
    
    return true;
  }

  /**
   * 通知配置变更
   */
  private _notifyChange(key: string, newValue: unknown, oldValue: unknown): void {
    const handlers = this._changeHandlers.get(key);
    if (handlers) {
      for (const handler of handlers) {
        try {
          handler(key, newValue, oldValue);
        } catch (error) {
          console.error('Config change handler error:', error);
        }
      }
    }

    // 通配符监听
    const wildcardHandlers = this._changeHandlers.get('*');
    if (wildcardHandlers) {
      for (const handler of wildcardHandlers) {
        try {
          handler(key, newValue, oldValue);
        } catch (error) {
          console.error('Config wildcard handler error:', error);
        }
      }
    }
  }
}
```

**验收标准**:
- [ ] 配置读写正常
- [ ] 变更监听有效
- [ ] 验证功能正确
- [ ] 持久化可选

---

### 2.3 EventBus 事件系统

#### 任务 3.3.1: 定义事件类型
**优先级**: P0  
**描述**: 创建 `src/event/types.ts`

```typescript
export interface EventData {
  type: string;
  source: string;
  timestamp: string;
  data: Record<string, unknown>;
}

export type EventHandler<T = unknown> = (data: T) => void | Promise<void>;

export interface EventSubscription {
  id: string;
  eventType: string;
  handler: EventHandler;
  once: boolean;
}

export interface EventBusOptions {
  maxListeners?: number;
  async?: boolean;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持异步处理

---

#### 任务 3.3.2: 实现 EventBus 类
**优先级**: P0  
**描述**: 创建 `src/event/bus.ts`

```typescript
import { EventHandler, EventSubscription, EventBusOptions, EventData } from './types';
import { generateUuid } from '../utils/id';

const DEFAULT_OPTIONS: Required<EventBusOptions> = {
  maxListeners: 100,
  async: true,
};

/**
 * 事件总线
 */
export class EventBus {
  private _subscriptions = new Map<string, Set<EventSubscription>>();
  private _options: Required<EventBusOptions>;

  constructor(options?: EventBusOptions) {
    this._options = { ...DEFAULT_OPTIONS, ...options };
  }

  /**
   * 订阅事件
   */
  on<T = unknown>(eventType: string, handler: EventHandler<T>): string {
    return this._subscribe(eventType, handler as EventHandler, false);
  }

  /**
   * 一次性订阅
   */
  once<T = unknown>(eventType: string, handler: EventHandler<T>): string {
    return this._subscribe(eventType, handler as EventHandler, true);
  }

  /**
   * 取消订阅
   */
  off(eventType: string, handlerOrId?: EventHandler | string): void {
    const subs = this._subscriptions.get(eventType);
    if (!subs) return;

    if (!handlerOrId) {
      this._subscriptions.delete(eventType);
      return;
    }

    for (const sub of subs) {
      if (
        (typeof handlerOrId === 'string' && sub.id === handlerOrId) ||
        (typeof handlerOrId === 'function' && sub.handler === handlerOrId)
      ) {
        subs.delete(sub);
        break;
      }
    }
  }

  /**
   * 发布事件
   */
  async emit<T = unknown>(eventType: string, data: T): Promise<void> {
    const subs = this._subscriptions.get(eventType);
    const wildcardSubs = this._subscriptions.get('*');
    const toRemove: EventSubscription[] = [];

    const processSubscriptions = async (subscriptions: Set<EventSubscription> | undefined): Promise<void> => {
      if (!subscriptions) return;

      for (const sub of subscriptions) {
        try {
          if (this._options.async) {
            await sub.handler(data);
          } else {
            sub.handler(data);
          }

          if (sub.once) {
            toRemove.push(sub);
          }
        } catch (error) {
          console.error(`Event handler error for ${eventType}:`, error);
        }
      }
    };

    await processSubscriptions(subs);
    await processSubscriptions(wildcardSubs);

    // 移除一次性订阅
    for (const sub of toRemove) {
      this._subscriptions.get(sub.eventType)?.delete(sub);
    }
  }

  /**
   * 同步发布事件
   */
  emitSync<T = unknown>(eventType: string, data: T): void {
    const subs = this._subscriptions.get(eventType);
    const wildcardSubs = this._subscriptions.get('*');
    const toRemove: EventSubscription[] = [];

    const processSubscriptions = (subscriptions: Set<EventSubscription> | undefined): void => {
      if (!subscriptions) return;

      for (const sub of subscriptions) {
        try {
          sub.handler(data);
          if (sub.once) {
            toRemove.push(sub);
          }
        } catch (error) {
          console.error(`Event handler error for ${eventType}:`, error);
        }
      }
    };

    processSubscriptions(subs);
    processSubscriptions(wildcardSubs);

    for (const sub of toRemove) {
      this._subscriptions.get(sub.eventType)?.delete(sub);
    }
  }

  /**
   * 检查是否有订阅
   */
  hasListeners(eventType: string): boolean {
    return (this._subscriptions.get(eventType)?.size ?? 0) > 0;
  }

  /**
   * 获取订阅数量
   */
  listenerCount(eventType: string): number {
    return this._subscriptions.get(eventType)?.size ?? 0;
  }

  /**
   * 获取所有事件类型
   */
  eventNames(): string[] {
    return Array.from(this._subscriptions.keys());
  }

  /**
   * 清除所有订阅
   */
  clear(): void {
    this._subscriptions.clear();
  }

  /**
   * 内部订阅方法
   */
  private _subscribe(eventType: string, handler: EventHandler, once: boolean): string {
    if (!this._subscriptions.has(eventType)) {
      this._subscriptions.set(eventType, new Set());
    }

    const subs = this._subscriptions.get(eventType)!;
    
    if (subs.size >= this._options.maxListeners) {
      console.warn(`Max listeners (${this._options.maxListeners}) reached for event: ${eventType}`);
    }

    const subscription: EventSubscription = {
      id: generateUuid(),
      eventType,
      handler,
      once,
    };

    subs.add(subscription);
    return subscription.id;
  }
}
```

**验收标准**:
- [ ] 订阅/取消订阅正常
- [ ] 事件发布正常
- [ ] 一次性订阅有效
- [ ] 通配符订阅支持

---

### 2.4 I18nManager 多语言系统

#### 任务 3.4.1: 定义多语言类型
**优先级**: P1  
**描述**: 创建 `src/i18n/types.ts`

```typescript
export type Locale = string;

export interface Translation {
  [key: string]: string | Translation;
}

export interface I18nManagerOptions {
  defaultLocale?: Locale;
  fallbackLocale?: Locale;
  translations?: Record<Locale, Translation>;
}

export interface PluralRules {
  zero?: string;
  one?: string;
  two?: string;
  few?: string;
  many?: string;
  other: string;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持嵌套翻译

---

#### 任务 3.4.2: 实现 I18nManager 类
**优先级**: P1  
**描述**: 创建 `src/i18n/manager.ts`

```typescript
import { Locale, Translation, I18nManagerOptions, PluralRules } from './types';

const DEFAULT_OPTIONS: Required<I18nManagerOptions> = {
  defaultLocale: 'zh-CN',
  fallbackLocale: 'en-US',
  translations: {},
};

/**
 * 多语言管理器
 */
export class I18nManager {
  private _options: Required<I18nManagerOptions>;
  private _currentLocale: Locale;
  private _translations = new Map<Locale, Translation>();
  private _changeHandlers = new Set<(locale: Locale) => void>();

  constructor(options?: I18nManagerOptions) {
    this._options = { ...DEFAULT_OPTIONS, ...options };
    this._currentLocale = this._options.defaultLocale;

    // 初始化翻译
    for (const [locale, translation] of Object.entries(this._options.translations)) {
      this._translations.set(locale, translation);
    }
  }

  /**
   * 获取当前语言
   */
  get locale(): Locale {
    return this._currentLocale;
  }

  /**
   * 设置当前语言
   */
  setLocale(locale: Locale): void {
    if (locale !== this._currentLocale) {
      this._currentLocale = locale;
      this._notifyChange(locale);
    }
  }

  /**
   * 获取翻译文本
   */
  t(key: string, params?: Record<string, string | number>): string {
    const translation = this._getTranslation(key, this._currentLocale);
    
    if (translation === undefined) {
      // 使用回退语言
      const fallback = this._getTranslation(key, this._options.fallbackLocale);
      if (fallback === undefined) {
        console.warn(`Translation not found: ${key}`);
        return key;
      }
      return this._interpolate(fallback, params);
    }
    
    return this._interpolate(translation, params);
  }

  /**
   * 复数形式翻译
   */
  plural(key: string, count: number, params?: Record<string, string | number>): string {
    const rules = this._getTranslation(key, this._currentLocale) as unknown as PluralRules;
    
    if (!rules || typeof rules !== 'object') {
      return this.t(key, { ...params, count });
    }

    let template: string;
    if (count === 0 && rules.zero) {
      template = rules.zero;
    } else if (count === 1 && rules.one) {
      template = rules.one;
    } else if (count === 2 && rules.two) {
      template = rules.two;
    } else {
      template = rules.other;
    }

    return this._interpolate(template, { ...params, count });
  }

  /**
   * 添加翻译
   */
  addTranslation(locale: Locale, translation: Translation): void {
    const existing = this._translations.get(locale) || {};
    this._translations.set(locale, this._mergeTranslations(existing, translation));
  }

  /**
   * 获取可用语言列表
   */
  getAvailableLocales(): Locale[] {
    return Array.from(this._translations.keys());
  }

  /**
   * 检查语言是否可用
   */
  hasLocale(locale: Locale): boolean {
    return this._translations.has(locale);
  }

  /**
   * 监听语言变更
   */
  onLocaleChange(handler: (locale: Locale) => void): void {
    this._changeHandlers.add(handler);
  }

  /**
   * 取消监听
   */
  offLocaleChange(handler: (locale: Locale) => void): void {
    this._changeHandlers.delete(handler);
  }

  /**
   * 获取翻译值
   */
  private _getTranslation(key: string, locale: Locale): string | undefined {
    const translation = this._translations.get(locale);
    if (!translation) return undefined;

    const parts = key.split('.');
    let current: Translation | string = translation;

    for (const part of parts) {
      if (typeof current !== 'object' || current === null) {
        return undefined;
      }
      current = current[part] as Translation | string;
    }

    return typeof current === 'string' ? current : undefined;
  }

  /**
   * 插值替换
   */
  private _interpolate(template: string, params?: Record<string, string | number>): string {
    if (!params) return template;

    return template.replace(/\{(\w+)\}/g, (match, key) => {
      return params[key] !== undefined ? String(params[key]) : match;
    });
  }

  /**
   * 合并翻译
   */
  private _mergeTranslations(target: Translation, source: Translation): Translation {
    const result = { ...target };
    
    for (const [key, value] of Object.entries(source)) {
      if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
        result[key] = this._mergeTranslations(
          (result[key] as Translation) || {},
          value as Translation
        );
      } else {
        result[key] = value;
      }
    }
    
    return result;
  }

  /**
   * 通知语言变更
   */
  private _notifyChange(locale: Locale): void {
    for (const handler of this._changeHandlers) {
      try {
        handler(locale);
      } catch (error) {
        console.error('Locale change handler error:', error);
      }
    }
  }
}
```

**验收标准**:
- [ ] 翻译获取正常
- [ ] 参数插值正确
- [ ] 回退语言有效
- [ ] 语言切换通知正常

---

### 2.5 模块导出

#### 任务 3.5.1: 创建模块索引文件
**优先级**: P0  
**描述**: 为每个模块创建 index.ts

**文件清单**:
- `src/logger/index.ts`
- `src/config/index.ts`
- `src/event/index.ts`
- `src/i18n/index.ts`

**验收标准**:
- [ ] 所有导出正确
- [ ] 类型导出完整

---

## 3. 验收标准

### 3.1 功能验收

- [ ] Logger 日志系统功能完整
- [ ] ConfigManager 配置读写正常
- [ ] EventBus 事件订阅发布正常
- [ ] I18nManager 多语言支持完整

### 3.2 代码质量

- [ ] 所有类有完整的 JSDoc 注释
- [ ] 错误处理完善
- [ ] 类型定义完整
- [ ] 测试覆盖率 ≥ 85%

### 3.3 性能要求

- [ ] 日志记录延迟 < 1ms
- [ ] 配置读取延迟 < 1ms
- [ ] 事件发布延迟 < 5ms

---

## 4. 注意事项

1. **线程安全**: 注意并发访问的处理
2. **内存管理**: 及时清理不需要的监听器
3. **国际化**: 所有错误消息使用 i18n key
4. **日志级别**: 生产环境默认使用 'info' 级别

---

**状态更新日期**: 2026-02-01
