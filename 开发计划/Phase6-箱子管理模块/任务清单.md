# Phase6 - 箱子管理模块

**状态**: 待开始  
**预计时间**: 2-3 天  
**依赖**: Phase4, Phase5

---

## 1. 阶段目标

- 实现 BoxAPI 箱子业务 API
- 实现箱子创建/读取/更新/删除
- 实现箱子内卡片管理
- 实现布局管理

---

## 2. 任务清单

### 2.1 箱子类型扩展

#### 任务 6.1.1: 扩展箱子类型定义
**优先级**: P0  
**描述**: 扩展 `src/types/box.ts`

```typescript
// 新增类型定义

/**
 * 箱子创建选项
 */
export interface CreateBoxOptions {
  name: string;
  layout?: string;
  tags?: Tag[];
  metadata?: Partial<BoxMetadata>;
}

/**
 * 箱子更新选项
 */
export interface UpdateBoxOptions {
  name?: string;
  layout?: string;
  tags?: Tag[];
  metadata?: Partial<BoxMetadata>;
}

/**
 * 箱子查询选项
 */
export interface QueryBoxOptions {
  tags?: Tag[];
  layout?: string;
  name?: string;
  createdAfter?: Timestamp;
  createdBefore?: Timestamp;
  limit?: number;
  offset?: number;
}

/**
 * 添加卡片选项
 */
export interface AddCardToBoxOptions {
  cardId: ChipsId;
  location: 'internal' | 'external';
  path?: string;
  position?: number;
}

/**
 * 卡片排序选项
 */
export interface ReorderCardsOptions {
  cardIds: ChipsId[];
}

/**
 * 布局配置
 */
export interface LayoutConfig {
  type: string;
  columns?: number;
  gap?: number;
  padding?: number;
  itemWidth?: number;
  itemHeight?: number;
  [key: string]: unknown;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持 CRUD 操作

---

### 2.2 BoxAPI 实现

#### 任务 6.2.1: 实现 BoxAPI 类
**优先级**: P0  
**描述**: 创建 `src/api/box-api.ts`

```typescript
import { CoreConnector, ChipsError, ErrorCodes } from '../core';
import { Logger } from '../logger';
import { ConfigManager } from '../config';
import { EventBus } from '../event';
import { FileAPI } from './file-api';
import { CardAPI } from './card-api';
import {
  Box,
  BoxMetadata,
  BoxCardInfo,
  CreateBoxOptions,
  UpdateBoxOptions,
  AddCardToBoxOptions,
  ReorderCardsOptions,
  LayoutConfig,
  Tag,
} from '../types/box';
import { Card } from '../types/card';
import { ChipsId } from '../types/base';
import { generateId } from '../utils/id';
import { getFileName } from '../utils/path';

/**
 * 箱子 API
 */
export class BoxAPI {
  private _connector: CoreConnector;
  private _logger: Logger;
  private _config: ConfigManager;
  private _eventBus: EventBus;
  private _fileApi: FileAPI;
  private _cardApi: CardAPI;

  constructor(
    connector: CoreConnector,
    logger: Logger,
    config: ConfigManager,
    eventBus: EventBus,
    fileApi: FileAPI,
    cardApi: CardAPI
  ) {
    this._connector = connector;
    this._logger = logger.createChild('BoxAPI');
    this._config = config;
    this._eventBus = eventBus;
    this._fileApi = fileApi;
    this._cardApi = cardApi;
  }

  /**
   * 创建新箱子
   */
  async create(options: CreateBoxOptions): Promise<Box> {
    this._logger.debug('Creating box', { options });

    const id = generateId();
    const now = new Date().toISOString();

    const metadata: BoxMetadata = {
      chip_standards_version: '1.0.0',
      box_id: id,
      name: options.name,
      created_at: now,
      modified_at: now,
      layout: options.layout || 'grid',
      tags: options.tags,
      ...options.metadata,
    };

    const box: Box = {
      id,
      metadata,
      structure: {
        cards: [],
      },
      content: {
        active_layout: options.layout || 'grid',
        layout_configs: {},
      },
    };

    // 发布事件
    await this._eventBus.emit('box:created', { box });

    this._logger.info('Box created', { id, name: options.name });
    return box;
  }

  /**
   * 获取箱子（从文件加载）
   */
  async get(path: string): Promise<Box> {
    return this._fileApi.loadBox(path);
  }

  /**
   * 更新箱子
   */
  async update(box: Box, updates: UpdateBoxOptions): Promise<Box> {
    this._logger.debug('Updating box', { id: box.id, updates });

    const updatedMetadata: BoxMetadata = {
      ...box.metadata,
      modified_at: new Date().toISOString(),
    };

    if (updates.name !== undefined) {
      updatedMetadata.name = updates.name;
    }
    if (updates.layout !== undefined) {
      updatedMetadata.layout = updates.layout;
    }
    if (updates.tags !== undefined) {
      updatedMetadata.tags = updates.tags;
    }
    if (updates.metadata) {
      Object.assign(updatedMetadata, updates.metadata);
    }

    const updatedBox: Box = {
      ...box,
      metadata: updatedMetadata,
    };

    // 发布事件
    await this._eventBus.emit('box:updated', { box: updatedBox, updates });

    this._logger.info('Box updated', { id: box.id });
    return updatedBox;
  }

  /**
   * 保存箱子到文件
   */
  async save(path: string, box: Box, overwrite = false): Promise<void> {
    await this._fileApi.saveBox(path, box, { overwrite });
    
    // 发布事件
    await this._eventBus.emit('box:saved', { path, box });
  }

  /**
   * 删除箱子文件
   */
  async delete(path: string): Promise<void> {
    this._logger.debug('Deleting box', { path });

    await this._fileApi.delete(path);

    // 发布事件
    await this._eventBus.emit('box:deleted', { path });

    this._logger.info('Box deleted', { path });
  }

  /**
   * 复制箱子
   */
  async copy(box: Box, newName?: string): Promise<Box> {
    const id = generateId();
    const now = new Date().toISOString();

    const copiedBox: Box = {
      id,
      metadata: {
        ...box.metadata,
        box_id: id,
        name: newName || `${box.metadata.name} (副本)`,
        created_at: now,
        modified_at: now,
      },
      structure: JSON.parse(JSON.stringify(box.structure)),
      content: JSON.parse(JSON.stringify(box.content)),
    };

    // 发布事件
    await this._eventBus.emit('box:copied', { original: box, copy: copiedBox });

    this._logger.info('Box copied', { originalId: box.id, newId: id });
    return copiedBox;
  }

  // ========== 卡片管理 ==========

  /**
   * 添加卡片到箱子
   */
  async addCard(box: Box, options: AddCardToBoxOptions): Promise<Box> {
    this._logger.debug('Adding card to box', { boxId: box.id, cardId: options.cardId });

    const cardInfo: BoxCardInfo = {
      id: options.cardId,
      location: options.location,
      path: options.path || '',
      filename: options.path ? getFileName(options.path) : `${options.cardId}.card`,
    };

    let cards = [...box.structure.cards];
    
    if (options.position !== undefined && options.position >= 0 && options.position < cards.length) {
      cards.splice(options.position, 0, cardInfo);
    } else {
      cards.push(cardInfo);
    }

    const updatedBox: Box = {
      ...box,
      metadata: {
        ...box.metadata,
        modified_at: new Date().toISOString(),
      },
      structure: {
        ...box.structure,
        cards,
      },
    };

    // 发布事件
    await this._eventBus.emit('box:cardAdded', { box: updatedBox, cardInfo });

    this._logger.info('Card added to box', { boxId: box.id, cardId: options.cardId });
    return updatedBox;
  }

  /**
   * 从箱子移除卡片
   */
  async removeCard(box: Box, cardId: ChipsId): Promise<Box> {
    this._logger.debug('Removing card from box', { boxId: box.id, cardId });

    const cards = box.structure.cards.filter((c) => c.id !== cardId);

    const updatedBox: Box = {
      ...box,
      metadata: {
        ...box.metadata,
        modified_at: new Date().toISOString(),
      },
      structure: {
        ...box.structure,
        cards,
      },
    };

    // 发布事件
    await this._eventBus.emit('box:cardRemoved', { box: updatedBox, cardId });

    this._logger.info('Card removed from box', { boxId: box.id, cardId });
    return updatedBox;
  }

  /**
   * 重排卡片顺序
   */
  async reorderCards(box: Box, options: ReorderCardsOptions): Promise<Box> {
    this._logger.debug('Reordering cards', { boxId: box.id, cardIds: options.cardIds });

    // 创建 ID 到卡片信息的映射
    const cardMap = new Map(box.structure.cards.map((c) => [c.id, c]));
    
    // 按新顺序重建卡片数组
    const reorderedCards: BoxCardInfo[] = [];
    for (const cardId of options.cardIds) {
      const card = cardMap.get(cardId);
      if (card) {
        reorderedCards.push(card);
      }
    }

    // 添加可能遗漏的卡片（不在 cardIds 中的）
    for (const card of box.structure.cards) {
      if (!options.cardIds.includes(card.id)) {
        reorderedCards.push(card);
      }
    }

    const updatedBox: Box = {
      ...box,
      metadata: {
        ...box.metadata,
        modified_at: new Date().toISOString(),
      },
      structure: {
        ...box.structure,
        cards: reorderedCards,
      },
    };

    // 发布事件
    await this._eventBus.emit('box:cardsReordered', { box: updatedBox });

    this._logger.info('Cards reordered', { boxId: box.id });
    return updatedBox;
  }

  /**
   * 获取箱子中的所有卡片信息
   */
  getCards(box: Box): BoxCardInfo[] {
    return box.structure.cards;
  }

  /**
   * 获取箱子中的卡片信息
   */
  getCard(box: Box, cardId: ChipsId): BoxCardInfo | undefined {
    return box.structure.cards.find((c) => c.id === cardId);
  }

  /**
   * 获取卡片数量
   */
  getCardCount(box: Box): number {
    return box.structure.cards.length;
  }

  /**
   * 检查箱子是否包含卡片
   */
  hasCard(box: Box, cardId: ChipsId): boolean {
    return box.structure.cards.some((c) => c.id === cardId);
  }

  /**
   * 加载箱子中的所有卡片
   */
  async loadCards(box: Box): Promise<Card[]> {
    const cards: Card[] = [];
    
    for (const cardInfo of box.structure.cards) {
      if (cardInfo.location === 'internal' || cardInfo.path) {
        try {
          const card = await this._cardApi.get(cardInfo.path);
          cards.push(card);
        } catch (error) {
          this._logger.warn('Failed to load card', { cardId: cardInfo.id, error });
        }
      }
    }
    
    return cards;
  }

  // ========== 布局管理 ==========

  /**
   * 设置当前布局
   */
  async setLayout(box: Box, layoutType: string): Promise<Box> {
    this._logger.debug('Setting layout', { boxId: box.id, layoutType });

    const updatedBox: Box = {
      ...box,
      metadata: {
        ...box.metadata,
        layout: layoutType,
        modified_at: new Date().toISOString(),
      },
      content: {
        ...box.content,
        active_layout: layoutType,
      },
    };

    // 发布事件
    await this._eventBus.emit('box:layoutChanged', { box: updatedBox, layoutType });

    this._logger.info('Layout changed', { boxId: box.id, layoutType });
    return updatedBox;
  }

  /**
   * 获取当前布局
   */
  getLayout(box: Box): string {
    return box.content.active_layout;
  }

  /**
   * 设置布局配置
   */
  async setLayoutConfig(box: Box, layoutType: string, config: LayoutConfig): Promise<Box> {
    this._logger.debug('Setting layout config', { boxId: box.id, layoutType });

    const updatedBox: Box = {
      ...box,
      metadata: {
        ...box.metadata,
        modified_at: new Date().toISOString(),
      },
      content: {
        ...box.content,
        layout_configs: {
          ...box.content.layout_configs,
          [layoutType]: config,
        },
      },
    };

    // 发布事件
    await this._eventBus.emit('box:layoutConfigChanged', { box: updatedBox, layoutType, config });

    return updatedBox;
  }

  /**
   * 获取布局配置
   */
  getLayoutConfig(box: Box, layoutType?: string): LayoutConfig | undefined {
    const type = layoutType || box.content.active_layout;
    return box.content.layout_configs[type] as LayoutConfig | undefined;
  }

  /**
   * 获取所有布局配置
   */
  getAllLayoutConfigs(box: Box): Record<string, LayoutConfig> {
    return box.content.layout_configs as Record<string, LayoutConfig>;
  }

  // ========== 标签管理 ==========

  /**
   * 添加标签
   */
  async addTag(box: Box, tag: Tag): Promise<Box> {
    this._logger.debug('Adding tag to box', { boxId: box.id, tag });

    const currentTags = box.metadata.tags || [];
    
    if (this._hasTag(currentTags, tag)) {
      return box;
    }

    const updatedBox: Box = {
      ...box,
      metadata: {
        ...box.metadata,
        tags: [...currentTags, tag],
        modified_at: new Date().toISOString(),
      },
    };

    // 发布事件
    await this._eventBus.emit('box:tagAdded', { box: updatedBox, tag });

    return updatedBox;
  }

  /**
   * 移除标签
   */
  async removeTag(box: Box, tag: Tag): Promise<Box> {
    this._logger.debug('Removing tag from box', { boxId: box.id, tag });

    const currentTags = box.metadata.tags || [];
    const updatedTags = currentTags.filter((t) => !this._tagEquals(t, tag));

    const updatedBox: Box = {
      ...box,
      metadata: {
        ...box.metadata,
        tags: updatedTags,
        modified_at: new Date().toISOString(),
      },
    };

    // 发布事件
    await this._eventBus.emit('box:tagRemoved', { box: updatedBox, tag });

    return updatedBox;
  }

  /**
   * 获取所有标签
   */
  getTags(box: Box): Tag[] {
    return box.metadata.tags || [];
  }

  // ========== 私有方法 ==========

  private _hasTag(tags: Tag[], tag: Tag): boolean {
    return tags.some((t) => this._tagEquals(t, tag));
  }

  private _tagEquals(a: Tag, b: Tag): boolean {
    if (typeof a === 'string' && typeof b === 'string') {
      return a === b;
    }
    if (Array.isArray(a) && Array.isArray(b)) {
      return a.length === b.length && a.every((v, i) => v === b[i]);
    }
    return false;
  }
}
```

**验收标准**:
- [ ] 箱子 CRUD 操作正常
- [ ] 卡片管理正常
- [ ] 布局管理正常
- [ ] 标签管理正常

---

### 2.3 单元测试

#### 任务 6.3.1: 创建 BoxAPI 单元测试
**优先级**: P0  
**描述**: 创建 `tests/unit/api/box-api.test.ts`

**测试用例**:
1. 创建箱子
2. 获取箱子
3. 更新箱子
4. 删除箱子
5. 复制箱子
6. 添加/移除卡片
7. 重排卡片顺序
8. 布局管理
9. 标签管理
10. 事件发布

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 覆盖率 ≥ 85%

---

## 3. 验收标准

### 3.1 功能验收

- [ ] 箱子创建正常
- [ ] 箱子读取正常
- [ ] 箱子更新正常
- [ ] 箱子删除正常
- [ ] 卡片管理完整
- [ ] 布局管理完整
- [ ] 标签管理完整
- [ ] 事件发布正常

### 3.2 代码质量

- [ ] 测试覆盖率 ≥ 85%
- [ ] 所有方法有 JSDoc 注释
- [ ] 错误处理完善

---

## 4. 注意事项

1. **卡片引用**: 注意内部卡片和外部卡片的区别
2. **布局切换**: 保留所有布局配置，支持无缝切换
3. **事件发布**: 所有变更操作必须发布对应事件
4. **不可变性**: 所有更新操作返回新对象

---

**状态更新日期**: 2026-02-01
