# 测试手册

## 1. 测试策略概述

Chips SDK 采用多层次测试策略,确保 API 的稳定性和可靠性。

### 1.1 测试金字塔

```
              /\
             /  \
            / E2E\           E2E 测试 (5%)
           /      \          - 完整工作流测试
          /--------\
         /          \
        /   集成测试  \       集成测试 (25%)
       /              \      - API 集成
      /----------------\     - 跨平台测试
     /                  \
    /      单元测试        \  单元测试 (70%)
   /                      \ - 函数测试
  /--------------------------\ - 模块测试
```

### 1.2 测试覆盖率目标

- **单元测试覆盖率**: ≥ 90%
- **集成测试覆盖率**: ≥ 70%
- **E2E 测试覆盖率**: 核心场景 100%
- **总体代码覆盖率**: ≥ 85%

## 2. 测试框架和工具

### 2.1 测试框架选择

**Jest** - 单元测试和集成测试

```json
{
  "devDependencies": {
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0",
    "ts-jest": "^29.0.0"
  }
}
```

**Vitest** - 备选（更快的测试运行）

```json
{
  "devDependencies": {
    "vitest": "^1.0.0",
    "@vitest/ui": "^1.0.0"
  }
}
```

### 2.2 配置文件

**jest.config.js**:

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/index.ts',
    '!src/types/**'
  ],
  coverageThreshold: {
    global: {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  }
};
```

## 3. 单元测试

### 3.1 核心 API 测试

#### 3.1.1 ChipsSDK 测试

```typescript
// tests/ChipsSDK.test.ts
import { ChipsSDK } from '@/ChipsSDK';

describe('ChipsSDK', () => {
  let sdk: ChipsSDK;
  
  beforeEach(() => {
    sdk = new ChipsSDK();
  });
  
  afterEach(() => {
    sdk.dispose?.();
  });
  
  describe('loadCard', () => {
    it('应该加载有效的卡片', async () => {
      const card = await sdk.loadCard('./test-data/sample.card');
      
      expect(card).toBeDefined();
      expect(card.id).toBeTruthy();
      expect(card.type).toBe('richtext');
    });
    
    it('应该抛出文件不存在错误', async () => {
      await expect(sdk.loadCard('./non-existent.card'))
        .rejects.toThrow('File not found');
    });
    
    it('应该验证卡片数据', async () => {
      await expect(sdk.loadCard('./test-data/invalid.card'))
        .rejects.toThrow('Invalid card data');
    });
  });
  
  describe('renderCard', () => {
    it('应该渲染卡片到容器', async () => {
      const card = createMockCard();
      const container = document.createElement('div');
      
      await sdk.renderCard(card, container);
      
      expect(container.children.length).toBeGreaterThan(0);
    });
    
    it('应该应用主题', async () => {
      const card = createMockCard();
      const container = document.createElement('div');
      
      await sdk.renderCard(card, container, { theme: 'dark' });
      
      expect(container.classList.contains('theme-dark')).toBe(true);
    });
  });
});
```

#### 3.1.2 文件 API 测试

```typescript
// tests/FileAPI.test.ts
import { FileAPI } from '@/api/FileAPI';

describe('FileAPI', () => {
  let fileAPI: FileAPI;
  
  beforeEach(() => {
    fileAPI = new FileAPI();
  });
  
  it('应该读取卡片文件', async () => {
    const card = await fileAPI.loadCard('./test.card');
    expect(card.type).toBe('richtext');
  });
  
  it('应该保存卡片文件', async () => {
    const card = createMockCard();
    await fileAPI.saveCard(card, './output.card');
    
    const loaded = await fileAPI.loadCard('./output.card');
    expect(loaded.id).toBe(card.id);
  });
  
  it('应该缓存卡片数据', async () => {
    const card1 = await fileAPI.loadCard('./test.card', { cache: true });
    const card2 = await fileAPI.loadCard('./test.card', { cache: true });
    
    expect(card1).toBe(card2); // 同一个对象引用
  });
});
```

### 3.2 解析器测试

```typescript
// tests/parser/ParserEngine.test.ts
import { ParserEngine } from '@/core/parser/ParserEngine';

describe('ParserEngine', () => {
  let parser: ParserEngine;
  
  beforeEach(() => {
    parser = new ParserEngine();
  });
  
  it('应该解析有效的卡片数据', () => {
    const data = createMockCardData();
    const card = parser.parseCard(data);
    
    expect(card.id).toBeDefined();
    expect(card.type).toBe('richtext');
  });
  
  it('应该序列化卡片', () => {
    const card = createMockCard();
    const data = parser.serializeCard(card);
    
    expect(data).toBeInstanceOf(ArrayBuffer);
    expect(data.byteLength).toBeGreaterThan(0);
  });
  
  it('应该验证卡片数据', () => {
    const card = createMockCard();
    const result = parser.validate(card);
    
    expect(result.valid).toBe(true);
    expect(result.errors).toHaveLength(0);
  });
  
  it('应该拒绝无效数据', () => {
    const invalid = { invalid: 'data' };
    
    expect(() => parser.parseCard(invalid as any))
      .toThrow('Invalid card data');
  });
});
```

### 3.3 渲染器测试

```typescript
// tests/renderer/RendererEngine.test.ts
import { RendererEngine } from '@/core/renderer/RendererEngine';

describe('RendererEngine', () => {
  let engine: RendererEngine;
  let container: HTMLElement;
  
  beforeEach(() => {
    engine = new RendererEngine();
    container = document.createElement('div');
  });
  
  it('应该渲染富文本卡片', async () => {
    const card = createRichTextCard();
    
    await engine.render(card, container);
    
    expect(container.querySelector('.richtext-content')).toBeTruthy();
  });
  
  it('应该应用主题', async () => {
    const card = createMockCard();
    const theme = createMockTheme();
    
    await engine.render(card, container, { theme });
    
    const bgColor = container.style.backgroundColor;
    expect(bgColor).toBe(theme.colors.background);
  });
  
  it('应该处理渲染错误', async () => {
    const invalidCard = { ...createMockCard(), type: 'unknown' as any };
    
    await expect(engine.render(invalidCard, container))
      .rejects.toThrow('No renderer found');
  });
});
```

## 4. 集成测试

### 4.1 API 兼容性测试

```typescript
// tests/integration/api-compatibility.test.ts
describe('API 兼容性测试', () => {
  it('应该在 Web 环境中工作', async () => {
    const sdk = new ChipsSDK({ platform: 'web' });
    
    const card = await sdk.loadCard('./test.card');
    const container = document.createElement('div');
    
    await sdk.renderCard(card, container);
    
    expect(container.children.length).toBeGreaterThan(0);
  });
  
  it('应该在 Node.js 环境中工作', async () => {
    const sdk = new ChipsSDK({ platform: 'node' });
    
    const card = await sdk.loadCard('./test.card');
    
    expect(card).toBeDefined();
  });
});
```

### 4.2 跨平台测试

```typescript
// tests/integration/cross-platform.test.ts
describe('跨平台测试', () => {
  const platforms = ['web', 'node', 'electron'];
  
  platforms.forEach(platform => {
    describe(`${platform} 平台`, () => {
      it('应该加载卡片', async () => {
        const sdk = new ChipsSDK({ platform: platform as any });
        const card = await sdk.loadCard('./test.card');
        
        expect(card).toBeDefined();
      });
      
      it('应该保存卡片', async () => {
        const sdk = new ChipsSDK({ platform: platform as any });
        const card = createMockCard();
        
        await sdk.saveCard(card, './output.card');
        
        const loaded = await sdk.loadCard('./output.card');
        expect(loaded.id).toBe(card.id);
      });
    });
  });
});
```

## 5. E2E 测试

### 5.1 完整工作流测试

```typescript
// tests/e2e/workflow.e2e.test.ts
describe('完整工作流 E2E 测试', () => {
  it('应该完成卡片创建到显示的完整流程', async () => {
    const sdk = new ChipsSDK();
    
    // 1. 加载卡片
    const card = await sdk.loadCard('./test.card');
    
    // 2. 修改卡片
    card.content = { text: 'Modified' };
    
    // 3. 保存卡片
    await sdk.saveCard(card, './modified.card');
    
    // 4. 重新加载
    const reloaded = await sdk.loadCard('./modified.card');
    
    // 5. 渲染
    const container = document.createElement('div');
    await sdk.renderCard(reloaded, container);
    
    // 6. 验证
    expect(container.textContent).toContain('Modified');
  });
});
```

## 6. 性能测试

### 6.1 加载性能测试

```typescript
// tests/performance/loading.perf.test.ts
describe('加载性能测试', () => {
  it('应该在100ms内加载小卡片', async () => {
    const sdk = new ChipsSDK();
    
    const start = performance.now();
    await sdk.loadCard('./small.card'); // <50KB
    const end = performance.now();
    
    expect(end - start).toBeLessThan(100);
  });
  
  it('应该在500ms内加载大卡片', async () => {
    const sdk = new ChipsSDK();
    
    const start = performance.now();
    await sdk.loadCard('./large.card'); // <5MB
    const end = performance.now();
    
    expect(end - start).toBeLessThan(500);
  });
});
```

### 6.2 渲染性能测试

```typescript
// tests/performance/rendering.perf.test.ts
describe('渲染性能测试', () => {
  it('应该在200ms内渲染简单卡片', async () => {
    const sdk = new ChipsSDK();
    const card = createSimpleCard();
    const container = document.createElement('div');
    
    const start = performance.now();
    await sdk.renderCard(card, container);
    const end = performance.now();
    
    expect(end - start).toBeLessThan(200);
  });
});
```

## 7. 测试工具函数

```typescript
// tests/helpers/test-utils.ts
export function createMockCard(overrides?: Partial<Card>): Card {
  return {
    id: 'test-' + Date.now(),
    type: 'richtext',
    version: '1.0.0',
    metadata: {},
    content: { blocks: [] },
    ...overrides
  };
}

export function createMockTheme(): Theme {
  return {
    id: 'test-theme',
    name: 'Test Theme',
    version: '1.0.0',
    colors: {
      primary: '#1976d2',
      background: '#ffffff',
      text: '#212121'
    }
  };
}

export async function waitFor(
  condition: () => boolean,
  timeout = 1000
): Promise<void> {
  const start = Date.now();
  while (!condition() && Date.now() - start < timeout) {
    await new Promise(resolve => setTimeout(resolve, 10));
  }
  if (!condition()) {
    throw new Error('Timeout waiting for condition');
  }
}
```

## 8. CI/CD 集成

### 8.1 GitHub Actions 配置

```yaml
# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [18, 20]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

### 8.2 测试脚本

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:unit": "jest --testPathPattern=tests/unit",
    "test:integration": "jest --testPathPattern=tests/integration",
    "test:e2e": "jest --testPathPattern=tests/e2e",
    "test:perf": "jest --testPathPattern=tests/performance"
  }
}
```

## 9. 测试最佳实践

1. **每个 API 函数都要测试**
2. **测试边界条件和错误情况**
3. **保持测试独立性**
4. **使用有意义的测试名称**
5. **避免测试实现细节**
6. **定期审查和更新测试**

## 10. 覆盖率报告

测试运行后查看覆盖率报告：

```bash
npm run test:coverage
open coverage/lcov-report/index.html
```

## 总结

Chips SDK 的测试手册提供了完整的测试策略和实践指南。通过全面的单元测试、集成测试和 E2E 测试，确保 SDK 的质量和稳定性。所有测试都集成到 CI/CD 流程中，实现自动化质量保证。
