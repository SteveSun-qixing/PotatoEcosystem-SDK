# Phase1 - 项目初始化与基础架构

**状态**: 待开始  
**预计时间**: 1-2 天

---

## 1. 阶段目标

- 搭建完整的项目骨架
- 配置构建工具链
- 建立测试框架
- 定义核心类型和接口
- 实现基础工具函数

---

## 2. 任务清单

### 2.1 项目结构搭建

#### 任务 1.1.1: 创建项目目录结构
**优先级**: P0  
**描述**: 创建 SDK 项目的完整目录结构

```
src/
├── index.ts
├── sdk.ts
├── core/
├── api/
├── renderer/
├── plugin/
├── theme/
├── resource/
├── event/
├── config/
├── i18n/
├── logger/
├── utils/
└── types/
tests/
├── unit/
└── integration/
examples/
docs/
```

**验收标准**:
- [ ] 所有目录已创建
- [ ] 每个目录有 index.ts 导出文件

---

#### 任务 1.1.2: 初始化 package.json
**优先级**: P0  
**描述**: 创建并配置 package.json

```json
{
  "name": "@chips/sdk",
  "version": "1.0.0",
  "description": "薯片生态开发工具包",
  "main": "dist/cjs/index.js",
  "module": "dist/esm/index.js",
  "types": "dist/types/index.d.ts",
  "exports": {
    ".": {
      "require": "./dist/cjs/index.js",
      "import": "./dist/esm/index.js",
      "types": "./dist/types/index.d.ts"
    }
  },
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch",
    "test": "vitest",
    "test:coverage": "vitest --coverage",
    "lint": "eslint src --ext .ts",
    "lint:fix": "eslint src --ext .ts --fix",
    "format": "prettier --write src",
    "typecheck": "tsc --noEmit"
  }
}
```

**验收标准**:
- [ ] package.json 配置正确
- [ ] 依赖版本明确
- [ ] scripts 脚本可用

---

#### 任务 1.1.3: 安装依赖
**优先级**: P0  
**描述**: 安装所需的开发依赖

**开发依赖**:
- typescript ^5.0.0
- tsup ^8.0.0
- vitest ^1.0.0
- @vitest/coverage-v8
- eslint ^8.0.0
- @typescript-eslint/eslint-plugin
- @typescript-eslint/parser
- prettier ^3.0.0
- @types/node

**运行时依赖**:
- 暂无（Core 和 Foundation 通过 peerDependencies）

**验收标准**:
- [ ] 所有依赖安装成功
- [ ] package-lock.json 生成

---

### 2.2 构建配置

#### 任务 1.2.1: 配置 TypeScript
**优先级**: P0  
**描述**: 创建 tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "declaration": true,
    "declarationDir": "./dist/types",
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "noImplicitThis": true,
    "alwaysStrict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "moduleResolution": "node",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

**验收标准**:
- [ ] 严格模式启用
- [ ] 类型声明输出配置
- [ ] 编译通过

---

#### 任务 1.2.2: 配置 tsup
**优先级**: P0  
**描述**: 创建 tsup.config.ts

```typescript
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['cjs', 'esm'],
  dts: true,
  splitting: false,
  sourcemap: true,
  clean: true,
  minify: false,
  treeshake: true,
  external: ['@chips/core', '@chips/foundation'],
});
```

**验收标准**:
- [ ] CJS 和 ESM 格式输出
- [ ] 类型声明文件生成
- [ ] Source map 生成

---

#### 任务 1.2.3: 配置 ESLint
**优先级**: P0  
**描述**: 创建 .eslintrc.cjs

```javascript
module.exports = {
  root: true,
  parser: '@typescript-eslint/parser',
  plugins: ['@typescript-eslint'],
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
    'plugin:@typescript-eslint/recommended-requiring-type-checking',
  ],
  parserOptions: {
    project: './tsconfig.json',
    tsconfigRootDir: __dirname,
  },
  rules: {
    '@typescript-eslint/explicit-function-return-type': 'error',
    '@typescript-eslint/no-explicit-any': 'warn',
    '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
    '@typescript-eslint/naming-convention': [
      'error',
      { selector: 'class', format: ['PascalCase'] },
      { selector: 'interface', format: ['PascalCase'] },
      { selector: 'typeAlias', format: ['PascalCase'] },
      { selector: 'enum', format: ['PascalCase'] },
      { selector: 'variable', format: ['camelCase', 'UPPER_CASE'] },
      { selector: 'function', format: ['camelCase'] },
      { selector: 'method', format: ['camelCase'] },
    ],
  },
};
```

**验收标准**:
- [ ] ESLint 配置正确
- [ ] 命名规范检查启用
- [ ] lint 命令可用

---

#### 任务 1.2.4: 配置 Prettier
**优先级**: P0  
**描述**: 创建 .prettierrc

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "bracketSpacing": true,
  "arrowParens": "always"
}
```

**验收标准**:
- [ ] Prettier 配置正确
- [ ] format 命令可用

---

### 2.3 测试框架配置

#### 任务 1.3.1: 配置 Vitest
**优先级**: P0  
**描述**: 创建 vitest.config.ts

```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['tests/**/*.test.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'dist/',
        'tests/',
        '**/*.d.ts',
        '**/*.config.*',
      ],
      thresholds: {
        statements: 85,
        branches: 80,
        functions: 90,
        lines: 85,
      },
    },
  },
});
```

**验收标准**:
- [ ] Vitest 配置正确
- [ ] 覆盖率阈值设置
- [ ] test 命令可用

---

#### 任务 1.3.2: 创建测试工具
**优先级**: P1  
**描述**: 创建测试辅助工具

文件: `tests/helpers/mock-connector.ts`

```typescript
import { CoreConnector, RequestParams, ResponseData } from '../../src/core';

export class MockCoreConnector implements CoreConnector {
  private responses = new Map<string, any>();
  private errors = new Map<string, { code: string; message: string }>();

  mockResponse(service: string, data: any): void {
    this.responses.set(service, data);
  }

  mockError(service: string, code: string, message: string): void {
    this.errors.set(service, { code, message });
  }

  async request(params: RequestParams): Promise<ResponseData> {
    const key = `${params.service}.${params.method}`;
    
    if (this.errors.has(key)) {
      const error = this.errors.get(key)!;
      return { success: false, error: error.message };
    }
    
    if (this.responses.has(key)) {
      return { success: true, data: this.responses.get(key) };
    }
    
    throw new Error(`No mock for ${key}`);
  }

  reset(): void {
    this.responses.clear();
    this.errors.clear();
  }
}
```

**验收标准**:
- [ ] Mock 对象可用
- [ ] 支持模拟响应和错误

---

### 2.4 核心类型定义

#### 任务 1.4.1: 定义基础类型
**优先级**: P0  
**描述**: 创建 `src/types/base.ts`

```typescript
// 十位 62 进制 ID
export type ChipsId = string;

// 时间戳 ISO 8601 格式
export type Timestamp = string;

// 标签类型
export type Tag = string | [string, ...string[]];

// 协议版本
export type ProtocolVersion = `${number}.${number}.${number}`;

// 状态
export type Status = 'success' | 'error' | 'partial';

// 日志级别
export type LogLevel = 'debug' | 'info' | 'warn' | 'error';
```

**验收标准**:
- [ ] 基础类型定义完整
- [ ] 类型注释清晰

---

#### 任务 1.4.2: 定义卡片类型
**优先级**: P0  
**描述**: 创建 `src/types/card.ts`

```typescript
import { ChipsId, Timestamp, Tag, ProtocolVersion } from './base';

export interface CardMetadata {
  chip_standards_version: ProtocolVersion;
  card_id: ChipsId;
  name: string;
  created_at: Timestamp;
  modified_at: Timestamp;
  theme?: string;
  tags?: Tag[];
}

export interface BaseCardInfo {
  id: ChipsId;
  type: string;
}

export interface ResourceInfo {
  path: string;
  size: number;
  type: string;
  checksum?: string;
}

export interface CardManifest {
  card_count: number;
  resource_count: number;
  resources: ResourceInfo[];
}

export interface CardStructure {
  structure: BaseCardInfo[];
  manifest: CardManifest;
}

export interface Card {
  id: ChipsId;
  metadata: CardMetadata;
  structure: CardStructure;
  resources: Map<string, Blob | ArrayBuffer>;
}
```

**验收标准**:
- [ ] 卡片类型定义完整
- [ ] 符合文件格式规范

---

#### 任务 1.4.3: 定义箱子类型
**优先级**: P0  
**描述**: 创建 `src/types/box.ts`

```typescript
import { ChipsId, Timestamp, Tag, ProtocolVersion } from './base';

export interface BoxMetadata {
  chip_standards_version: ProtocolVersion;
  box_id: ChipsId;
  name: string;
  created_at: Timestamp;
  modified_at: Timestamp;
  layout: string;
  tags?: Tag[];
}

export interface BoxCardInfo {
  id: ChipsId;
  location: 'internal' | 'external';
  path: string;
  filename: string;
}

export interface BoxStructure {
  cards: BoxCardInfo[];
}

export interface BoxContent {
  active_layout: string;
  layout_configs: Record<string, any>;
}

export interface Box {
  id: ChipsId;
  metadata: BoxMetadata;
  structure: BoxStructure;
  content: BoxContent;
}
```

**验收标准**:
- [ ] 箱子类型定义完整
- [ ] 符合文件格式规范

---

#### 任务 1.4.4: 定义 API 类型
**优先级**: P0  
**描述**: 创建 `src/types/api.ts`

```typescript
// 加载选项
export interface LoadOptions {
  cache?: boolean;
  verify?: boolean;
  loadResources?: boolean;
}

// 保存选项
export interface SaveOptions {
  overwrite?: boolean;
  compress?: boolean;
  verify?: boolean;
}

// 渲染选项
export interface RenderOptions {
  theme?: string;
  mode?: 'view' | 'edit' | 'preview';
  readOnly?: boolean;
  interactive?: boolean;
  lazyLoad?: boolean;
  virtualScroll?: boolean;
  animations?: boolean;
  layout?: string;
  layoutConfig?: any;
  className?: string;
  style?: Record<string, string>;
  attributes?: Record<string, string>;
}

// 验证结果
export interface ValidationResult {
  valid: boolean;
  errors?: ValidationError[];
  warnings?: ValidationWarning[];
}

export interface ValidationError {
  code: string;
  message: string;
  path?: string;
}

export interface ValidationWarning {
  code: string;
  message: string;
  path?: string;
}
```

**验收标准**:
- [ ] API 类型定义完整
- [ ] 所有选项参数有默认值说明

---

### 2.5 工具函数库

#### 任务 1.5.1: ID 生成工具
**优先级**: P0  
**描述**: 创建 `src/utils/id.ts`

```typescript
const CHARS = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
const ID_LENGTH = 10;

/**
 * 生成十位 62 进制 ID
 */
export function generateId(): string {
  let id = '';
  for (let i = 0; i < ID_LENGTH; i++) {
    id += CHARS.charAt(Math.floor(Math.random() * CHARS.length));
  }
  return id;
}

/**
 * 验证 ID 格式
 */
export function isValidId(id: string): boolean {
  if (id.length !== ID_LENGTH) return false;
  return /^[0-9a-zA-Z]{10}$/.test(id);
}

/**
 * 生成 UUID
 */
export function generateUuid(): string {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0;
    const v = c === 'x' ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}
```

**验收标准**:
- [ ] ID 生成正确
- [ ] 验证函数可用
- [ ] 单元测试通过

---

#### 任务 1.5.2: 路径处理工具
**优先级**: P0  
**描述**: 创建 `src/utils/path.ts`

```typescript
/**
 * 规范化路径
 */
export function normalizePath(path: string): string {
  return path.replace(/\\/g, '/').replace(/\/+/g, '/');
}

/**
 * 获取文件扩展名
 */
export function getExtension(path: string): string {
  const lastDot = path.lastIndexOf('.');
  if (lastDot === -1) return '';
  return path.slice(lastDot + 1).toLowerCase();
}

/**
 * 获取文件名
 */
export function getFileName(path: string): string {
  const normalized = normalizePath(path);
  const lastSlash = normalized.lastIndexOf('/');
  return lastSlash === -1 ? normalized : normalized.slice(lastSlash + 1);
}

/**
 * 获取目录路径
 */
export function getDirPath(path: string): string {
  const normalized = normalizePath(path);
  const lastSlash = normalized.lastIndexOf('/');
  return lastSlash === -1 ? '' : normalized.slice(0, lastSlash);
}

/**
 * 连接路径
 */
export function joinPath(...parts: string[]): string {
  return normalizePath(parts.filter(Boolean).join('/'));
}

/**
 * 检查是否为安全路径（防止路径遍历）
 */
export function isSafePath(path: string): boolean {
  const normalized = normalizePath(path);
  return !normalized.includes('..') && !normalized.startsWith('/');
}

/**
 * 检查是否为卡片文件
 */
export function isCardFile(path: string): boolean {
  return getExtension(path) === 'card';
}

/**
 * 检查是否为箱子文件
 */
export function isBoxFile(path: string): boolean {
  return getExtension(path) === 'box';
}
```

**验收标准**:
- [ ] 路径处理正确
- [ ] 安全检查有效
- [ ] 单元测试通过

---

#### 任务 1.5.3: 验证工具
**优先级**: P0  
**描述**: 创建 `src/utils/validation.ts`

```typescript
import { CardMetadata, BoxMetadata } from '../types';
import { isValidId } from './id';

/**
 * 验证卡片元数据
 */
export function validateCardMetadata(metadata: unknown): metadata is CardMetadata {
  if (!metadata || typeof metadata !== 'object') return false;
  
  const m = metadata as Record<string, unknown>;
  
  return (
    typeof m.chip_standards_version === 'string' &&
    typeof m.card_id === 'string' &&
    isValidId(m.card_id) &&
    typeof m.name === 'string' &&
    typeof m.created_at === 'string' &&
    typeof m.modified_at === 'string'
  );
}

/**
 * 验证箱子元数据
 */
export function validateBoxMetadata(metadata: unknown): metadata is BoxMetadata {
  if (!metadata || typeof metadata !== 'object') return false;
  
  const m = metadata as Record<string, unknown>;
  
  return (
    typeof m.chip_standards_version === 'string' &&
    typeof m.box_id === 'string' &&
    isValidId(m.box_id) &&
    typeof m.name === 'string' &&
    typeof m.layout === 'string' &&
    typeof m.created_at === 'string' &&
    typeof m.modified_at === 'string'
  );
}

/**
 * 验证协议版本
 */
export function validateProtocolVersion(version: string): boolean {
  return /^\d+\.\d+\.\d+$/.test(version);
}

/**
 * 验证时间戳格式
 */
export function validateTimestamp(timestamp: string): boolean {
  const date = new Date(timestamp);
  return !isNaN(date.getTime());
}
```

**验收标准**:
- [ ] 验证逻辑正确
- [ ] 类型守卫有效
- [ ] 单元测试通过

---

#### 任务 1.5.4: 异步工具
**优先级**: P1  
**描述**: 创建 `src/utils/async.ts`

```typescript
/**
 * 延迟执行
 */
export function delay(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

/**
 * 带超时的 Promise
 */
export function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number,
  timeoutError?: Error
): Promise<T> {
  return Promise.race([
    promise,
    new Promise<never>((_, reject) =>
      setTimeout(
        () => reject(timeoutError || new Error('Operation timed out')),
        timeoutMs
      )
    ),
  ]);
}

/**
 * 重试执行
 */
export async function retry<T>(
  fn: () => Promise<T>,
  options: {
    maxRetries?: number;
    delayMs?: number;
    backoff?: boolean;
  } = {}
): Promise<T> {
  const { maxRetries = 3, delayMs = 1000, backoff = true } = options;
  
  let lastError: Error | undefined;
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error instanceof Error ? error : new Error(String(error));
      
      if (i < maxRetries - 1) {
        const waitTime = backoff ? delayMs * Math.pow(2, i) : delayMs;
        await delay(waitTime);
      }
    }
  }
  
  throw lastError;
}

/**
 * 并发限制执行
 */
export async function concurrent<T>(
  tasks: (() => Promise<T>)[],
  limit: number
): Promise<T[]> {
  const results: T[] = [];
  const executing: Promise<void>[] = [];
  
  for (const task of tasks) {
    const p = task().then((result) => {
      results.push(result);
    });
    
    executing.push(p);
    
    if (executing.length >= limit) {
      await Promise.race(executing);
      executing.splice(
        executing.findIndex((ep) => ep === p),
        1
      );
    }
  }
  
  await Promise.all(executing);
  return results;
}
```

**验收标准**:
- [ ] 异步工具可用
- [ ] 超时和重试逻辑正确
- [ ] 单元测试通过

---

## 3. 验收标准

### 3.1 功能验收

- [ ] 项目结构完整
- [ ] 构建配置正确，`npm run build` 成功
- [ ] 测试框架可用，`npm run test` 成功
- [ ] 代码规范检查通过，`npm run lint` 无错误
- [ ] TypeScript 编译通过，`npm run typecheck` 无错误

### 3.2 代码质量

- [ ] 所有类型定义完整
- [ ] 工具函数有完整的 JSDoc 注释
- [ ] 工具函数有单元测试
- [ ] 测试覆盖率 ≥ 90%

### 3.3 文档完整

- [ ] README.md 有基本内容
- [ ] 所有类型有注释说明

---

## 4. 注意事项

1. **依赖版本**: 确保使用最新稳定版本的依赖
2. **类型严格**: TypeScript 必须使用严格模式
3. **路径安全**: 路径处理必须防止路径遍历攻击
4. **ID 格式**: 必须使用十位 62 进制 ID

---

**状态更新日期**: 2026-02-01
