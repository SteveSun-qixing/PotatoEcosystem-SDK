# Phase8 - 主题系统

**状态**: 待开始  
**预计时间**: 2-3 天  
**依赖**: Phase7

---

## 1. 阶段目标

- 实现 ThemeManager 主题管理系统
- 支持主题注册/应用
- 实现 CSS 变量管理
- 支持主题继承和层级覆盖

---

## 2. 任务清单

### 2.1 主题类型定义

#### 任务 8.1.1: 定义主题类型
**优先级**: P0  
**描述**: 创建 `src/theme/types.ts`

```typescript
import { ChipsId } from '../types/base';

/**
 * 主题变量
 */
export type ThemeVariables = Record<string, string>;

/**
 * 主题元数据
 */
export interface ThemeMetadata {
  id: ChipsId;
  name: string;
  version: string;
  description?: string;
  author?: string;
  preview?: string;
  extends?: string;
}

/**
 * 主题定义
 */
export interface Theme {
  metadata: ThemeMetadata;
  variables: ThemeVariables;
  styles?: string;
}

/**
 * 主题应用范围
 */
export type ThemeScope = 'global' | 'card' | 'box' | 'component';

/**
 * 主题应用选项
 */
export interface ApplyThemeOptions {
  scope?: ThemeScope;
  target?: HTMLElement;
  merge?: boolean;
}

/**
 * 主题层级
 */
export interface ThemeLayer {
  id: string;
  themeId: ChipsId;
  scope: ThemeScope;
  target?: HTMLElement;
  variables: ThemeVariables;
  styles?: HTMLStyleElement;
}

/**
 * 主题变更事件数据
 */
export interface ThemeChangeEvent {
  themeId: ChipsId;
  scope: ThemeScope;
  target?: HTMLElement;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持主题继承

---

### 2.2 ThemeManager 实现

#### 任务 8.2.1: 实现 ThemeManager 类
**优先级**: P0  
**描述**: 创建 `src/theme/manager.ts`

```typescript
import { CoreConnector, ChipsError, ErrorCodes } from '../core';
import { Logger } from '../logger';
import { ConfigManager } from '../config';
import { EventBus } from '../event';
import { PluginSystem } from '../plugin';
import {
  Theme,
  ThemeMetadata,
  ThemeVariables,
  ThemeScope,
  ApplyThemeOptions,
  ThemeLayer,
} from './types';
import { ChipsId } from '../types/base';
import { generateUuid } from '../utils/id';

/**
 * 默认主题变量
 */
const DEFAULT_VARIABLES: ThemeVariables = {
  // 颜色
  '--chips-color-primary': '#1890ff',
  '--chips-color-success': '#52c41a',
  '--chips-color-warning': '#faad14',
  '--chips-color-error': '#f5222d',
  '--chips-color-text': '#333333',
  '--chips-color-text-secondary': '#666666',
  '--chips-color-background': '#ffffff',
  '--chips-color-background-secondary': '#f5f5f5',
  '--chips-color-border': '#d9d9d9',
  
  // 字体
  '--chips-font-family': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
  '--chips-font-size-sm': '12px',
  '--chips-font-size-base': '14px',
  '--chips-font-size-lg': '16px',
  '--chips-font-size-xl': '20px',
  
  // 间距
  '--chips-spacing-xs': '4px',
  '--chips-spacing-sm': '8px',
  '--chips-spacing-md': '16px',
  '--chips-spacing-lg': '24px',
  '--chips-spacing-xl': '32px',
  
  // 圆角
  '--chips-radius-sm': '2px',
  '--chips-radius-md': '4px',
  '--chips-radius-lg': '8px',
  
  // 阴影
  '--chips-shadow-sm': '0 1px 2px rgba(0, 0, 0, 0.1)',
  '--chips-shadow-md': '0 4px 12px rgba(0, 0, 0, 0.15)',
  '--chips-shadow-lg': '0 8px 24px rgba(0, 0, 0, 0.2)',
  
  // 过渡
  '--chips-transition-fast': '0.1s ease',
  '--chips-transition-normal': '0.2s ease',
  '--chips-transition-slow': '0.3s ease',
};

/**
 * 主题管理器
 */
export class ThemeManager {
  private _connector: CoreConnector;
  private _logger: Logger;
  private _config: ConfigManager;
  private _eventBus: EventBus;
  private _pluginSystem: PluginSystem;
  
  private _themes = new Map<ChipsId, Theme>();
  private _layers: ThemeLayer[] = [];
  private _currentThemeId: ChipsId | null = null;
  private _styleElement: HTMLStyleElement | null = null;

  constructor(
    connector: CoreConnector,
    logger: Logger,
    config: ConfigManager,
    eventBus: EventBus,
    pluginSystem: PluginSystem
  ) {
    this._connector = connector;
    this._logger = logger.createChild('ThemeManager');
    this._config = config;
    this._eventBus = eventBus;
    this._pluginSystem = pluginSystem;

    // 注册默认主题
    this._registerDefaultTheme();
  }

  /**
   * 注册主题
   */
  async register(theme: Theme): Promise<void> {
    const { id } = theme.metadata;
    
    this._logger.debug('Registering theme', { id, name: theme.metadata.name });

    // 验证主题
    this._validateTheme(theme);

    // 处理继承
    if (theme.metadata.extends) {
      const parentTheme = this._themes.get(theme.metadata.extends);
      if (parentTheme) {
        theme = this._mergeThemes(parentTheme, theme);
      } else {
        this._logger.warn('Parent theme not found', { parent: theme.metadata.extends });
      }
    }

    this._themes.set(id, theme);

    // 发布事件
    await this._eventBus.emit('theme:registered', { theme });

    this._logger.info('Theme registered', { id, name: theme.metadata.name });
  }

  /**
   * 卸载主题
   */
  async unregister(themeId: ChipsId): Promise<void> {
    this._logger.debug('Unregistering theme', { id: themeId });

    if (!this._themes.has(themeId)) {
      throw new ChipsError(ErrorCodes.THEME_NOT_FOUND, `Theme not found: ${themeId}`);
    }

    // 如果是当前主题，先清除
    if (this._currentThemeId === themeId) {
      await this.clear();
    }

    // 移除该主题的所有层级
    this._layers = this._layers.filter((l) => l.themeId !== themeId);

    this._themes.delete(themeId);

    // 发布事件
    await this._eventBus.emit('theme:unregistered', { themeId });

    this._logger.info('Theme unregistered', { id: themeId });
  }

  /**
   * 应用主题
   */
  async apply(themeId: ChipsId, options?: ApplyThemeOptions): Promise<void> {
    const opts: Required<ApplyThemeOptions> = {
      scope: 'global',
      target: document.documentElement,
      merge: false,
      ...options,
    };

    this._logger.debug('Applying theme', { id: themeId, options: opts });

    const theme = this._themes.get(themeId);
    if (!theme) {
      throw new ChipsError(ErrorCodes.THEME_NOT_FOUND, `Theme not found: ${themeId}`);
    }

    // 清除同范围的现有主题（如果不是合并模式）
    if (!opts.merge) {
      this._clearScope(opts.scope, opts.target);
    }

    // 创建主题层级
    const layer = this._createLayer(themeId, theme, opts);
    this._layers.push(layer);

    // 应用变量
    this._applyVariables(layer.variables, opts.target);

    // 应用样式
    if (theme.styles) {
      layer.styles = this._applyStyles(theme.styles, opts.target);
    }

    // 更新当前主题（仅全局范围）
    if (opts.scope === 'global') {
      this._currentThemeId = themeId;
    }

    // 发布事件
    await this._eventBus.emit('theme:applied', { themeId, scope: opts.scope, target: opts.target });

    this._logger.info('Theme applied', { id: themeId, scope: opts.scope });
  }

  /**
   * 清除主题
   */
  async clear(scope?: ThemeScope, target?: HTMLElement): Promise<void> {
    this._logger.debug('Clearing theme', { scope, target });

    if (scope) {
      this._clearScope(scope, target);
    } else {
      // 清除所有
      for (const layer of this._layers) {
        this._removeLayer(layer);
      }
      this._layers = [];
      this._currentThemeId = null;
    }

    // 发布事件
    await this._eventBus.emit('theme:cleared', { scope, target });
  }

  /**
   * 获取主题
   */
  get(themeId: ChipsId): Theme | undefined {
    return this._themes.get(themeId);
  }

  /**
   * 获取当前主题
   */
  getCurrent(): Theme | undefined {
    return this._currentThemeId ? this._themes.get(this._currentThemeId) : undefined;
  }

  /**
   * 获取当前主题 ID
   */
  getCurrentId(): ChipsId | null {
    return this._currentThemeId;
  }

  /**
   * 获取所有主题
   */
  getAll(): Theme[] {
    return Array.from(this._themes.values());
  }

  /**
   * 检查主题是否存在
   */
  has(themeId: ChipsId): boolean {
    return this._themes.has(themeId);
  }

  /**
   * 获取主题变量
   */
  getVariable(name: string, themeId?: ChipsId): string | undefined {
    const theme = themeId ? this._themes.get(themeId) : this.getCurrent();
    return theme?.variables[name];
  }

  /**
   * 设置主题变量（运行时覆盖）
   */
  setVariable(name: string, value: string, target?: HTMLElement): void {
    const el = target || document.documentElement;
    el.style.setProperty(name, value);
  }

  /**
   * 获取所有变量
   */
  getVariables(themeId?: ChipsId): ThemeVariables {
    const theme = themeId ? this._themes.get(themeId) : this.getCurrent();
    return theme?.variables || DEFAULT_VARIABLES;
  }

  /**
   * 获取计算后的变量值
   */
  getComputedVariable(name: string, target?: HTMLElement): string {
    const el = target || document.documentElement;
    return getComputedStyle(el).getPropertyValue(name).trim();
  }

  /**
   * 获取主题数量
   */
  get count(): number {
    return this._themes.size;
  }

  // ========== 私有方法 ==========

  /**
   * 注册默认主题
   */
  private _registerDefaultTheme(): void {
    const defaultTheme: Theme = {
      metadata: {
        id: 'default',
        name: '默认主题',
        version: '1.0.0',
        description: 'Chips SDK 默认主题',
      },
      variables: DEFAULT_VARIABLES,
    };

    this._themes.set('default', defaultTheme);
  }

  /**
   * 验证主题
   */
  private _validateTheme(theme: Theme): void {
    if (!theme.metadata?.id) {
      throw new ChipsError(ErrorCodes.THEME_INVALID, 'Theme must have an id');
    }

    if (!theme.metadata?.name) {
      throw new ChipsError(ErrorCodes.THEME_INVALID, 'Theme must have a name');
    }

    if (!theme.variables || typeof theme.variables !== 'object') {
      throw new ChipsError(ErrorCodes.THEME_INVALID, 'Theme must have variables');
    }
  }

  /**
   * 合并主题
   */
  private _mergeThemes(parent: Theme, child: Theme): Theme {
    return {
      metadata: child.metadata,
      variables: {
        ...parent.variables,
        ...child.variables,
      },
      styles: [parent.styles, child.styles].filter(Boolean).join('\n'),
    };
  }

  /**
   * 创建主题层级
   */
  private _createLayer(themeId: ChipsId, theme: Theme, opts: Required<ApplyThemeOptions>): ThemeLayer {
    return {
      id: generateUuid(),
      themeId,
      scope: opts.scope,
      target: opts.target,
      variables: { ...theme.variables },
    };
  }

  /**
   * 应用变量
   */
  private _applyVariables(variables: ThemeVariables, target: HTMLElement): void {
    for (const [name, value] of Object.entries(variables)) {
      target.style.setProperty(name, value);
    }
  }

  /**
   * 应用样式
   */
  private _applyStyles(styles: string, target: HTMLElement): HTMLStyleElement {
    const styleEl = document.createElement('style');
    styleEl.textContent = styles;
    styleEl.setAttribute('data-chips-theme', 'true');
    
    if (target === document.documentElement) {
      document.head.appendChild(styleEl);
    } else {
      // 对于局部范围，尝试使用 Shadow DOM 或在元素内插入
      target.appendChild(styleEl);
    }
    
    return styleEl;
  }

  /**
   * 清除指定范围的主题
   */
  private _clearScope(scope: ThemeScope, target?: HTMLElement): void {
    const toRemove = this._layers.filter(
      (l) => l.scope === scope && (!target || l.target === target)
    );

    for (const layer of toRemove) {
      this._removeLayer(layer);
    }

    this._layers = this._layers.filter(
      (l) => !(l.scope === scope && (!target || l.target === target))
    );
  }

  /**
   * 移除层级
   */
  private _removeLayer(layer: ThemeLayer): void {
    // 移除样式元素
    if (layer.styles) {
      layer.styles.remove();
    }

    // 移除变量
    if (layer.target) {
      for (const name of Object.keys(layer.variables)) {
        layer.target.style.removeProperty(name);
      }
    }
  }
}
```

**验收标准**:
- [ ] 主题注册/卸载正常
- [ ] 主题应用/清除正常
- [ ] CSS 变量管理正常
- [ ] 主题继承支持

---

### 2.3 单元测试

#### 任务 8.3.1: 创建 ThemeManager 单元测试
**优先级**: P0  
**描述**: 创建 `tests/unit/theme/manager.test.ts`

**测试用例**:
1. 注册主题
2. 卸载主题
3. 应用主题
4. 清除主题
5. 主题继承
6. 变量管理
7. 作用域控制
8. 事件发布

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 覆盖率 ≥ 85%

---

## 3. 验收标准

### 3.1 功能验收

- [ ] 主题注册正常
- [ ] 主题卸载正常
- [ ] 主题应用正常
- [ ] 主题清除正常
- [ ] 主题继承正常
- [ ] 变量管理完整
- [ ] 多作用域支持
- [ ] 事件发布正常

### 3.2 代码质量

- [ ] 测试覆盖率 ≥ 85%
- [ ] 所有方法有 JSDoc 注释
- [ ] 错误处理完善

---

## 4. 注意事项

1. **CSS 变量命名**: 统一使用 `--chips-` 前缀
2. **作用域隔离**: 不同作用域的主题互不影响
3. **继承顺序**: 子主题变量覆盖父主题
4. **性能考虑**: 避免频繁 DOM 操作

---

**状态更新日期**: 2026-02-01
