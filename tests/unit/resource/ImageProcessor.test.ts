/**
 * 图片处理器测试
 *
 * 注意：这些测试需要在支持DOM的环境中运行（如jsdom）
 */

import { describe, it, expect, beforeEach } from 'vitest';
import { ImageProcessor } from '@/resource/ImageProcessor';
import { Logger } from '@/core/logger';

describe('ImageProcessor', () => {
  let processor: ImageProcessor;
  let logger: Logger;

  beforeEach(() => {
    logger = new Logger({ enableConsole: false });
    processor = new ImageProcessor(logger);
  });

  describe('generateThumbnail', () => {
    it.skip('应该生成缩略图（需要DOM环境）', async () => {
      // 这个测试需要DOM环境，在Node.js环境中跳过
      // 创建一个简单的测试图片（1x1像素的PNG）
      const pngData = new Uint8Array([
        0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, // PNG signature
        0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52, // IHDR chunk
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, // 1x1
        0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53, 0xde,
        0x00, 0x00, 0x00, 0x0c, 0x49, 0x44, 0x41, 0x54, // IDAT chunk
        0x08, 0xd7, 0x63, 0xf8, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x49, 0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82, // IEND
      ]);

      const blob = new Blob([pngData], { type: 'image/png' });

      const result = await processor.generateThumbnail(blob, {
        width: 100,
        height: 100,
      });

      expect(result.data).toBeInstanceOf(Blob);
      expect(result.width).toBeLessThanOrEqual(100);
      expect(result.height).toBeLessThanOrEqual(100);
      expect(result.format).toBe('jpeg');
    });
  });

  describe('compress', () => {
    it.skip('应该压缩图片（需要DOM环境）', async () => {
      // 创建一个简单的测试图片
      const pngData = new Uint8Array([
        0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a,
        0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53, 0xde,
        0x00, 0x00, 0x00, 0x0c, 0x49, 0x44, 0x41, 0x54,
        0x08, 0xd7, 0x63, 0xf8, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x49, 0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82,
      ]);

      const blob = new Blob([pngData], { type: 'image/png' });

      const result = await processor.compress(blob, {
        maxWidth: 100,
        maxHeight: 100,
        quality: 0.8,
      });

      expect(result.data).toBeInstanceOf(Blob);
      expect(result.size).toBeGreaterThan(0);
    });
  });

  describe('getImageInfo', () => {
    it.skip('应该获取图片信息（需要DOM环境）', async () => {
      // 创建一个简单的测试图片
      const pngData = new Uint8Array([
        0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a,
        0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53, 0xde,
        0x00, 0x00, 0x00, 0x0c, 0x49, 0x44, 0x41, 0x54,
        0x08, 0xd7, 0x63, 0xf8, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x49, 0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82,
      ]);

      const blob = new Blob([pngData], { type: 'image/png' });

      const info = await processor.getImageInfo(blob);

      expect(info.width).toBeGreaterThan(0);
      expect(info.height).toBeGreaterThan(0);
      expect(info.size).toBeGreaterThan(0);
    });

    it.skip('应该处理ImageData（需要DOM环境）', async () => {
      const canvas = document.createElement('canvas');
      canvas.width = 100;
      canvas.height = 100;
      const ctx = canvas.getContext('2d');
      if (ctx) {
        const imageData = ctx.getImageData(0, 0, 100, 100);
        const info = await processor.getImageInfo(imageData);

        expect(info.width).toBe(100);
        expect(info.height).toBe(100);
      }
    });
  });

  describe('process', () => {
    it.skip('应该处理图片（需要DOM环境）', async () => {
      // 创建一个简单的测试图片
      const pngData = new Uint8Array([
        0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a,
        0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53, 0xde,
        0x00, 0x00, 0x00, 0x0c, 0x49, 0x44, 0x41, 0x54,
        0x08, 0xd7, 0x63, 0xf8, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x49, 0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82,
      ]);

      const blob = new Blob([pngData], { type: 'image/png' });

      const result = await processor.process(blob, {
        width: 50,
        height: 50,
        quality: 0.9,
        format: 'jpeg',
      });

      expect(result.data).toBeInstanceOf(Blob);
      expect(result.width).toBeLessThanOrEqual(50);
      expect(result.height).toBeLessThanOrEqual(50);
      expect(result.format).toBe('jpeg');
    });
  });
});
