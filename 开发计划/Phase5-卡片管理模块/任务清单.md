# Phase5 - 卡片管理模块

**状态**: 待开始  
**预计时间**: 2-3 天  
**依赖**: Phase4

---

## 1. 阶段目标

- 实现 CardAPI 卡片业务 API
- 实现卡片创建/读取/更新/删除
- 实现基础卡片管理
- 实现卡片资源管理
- 实现卡片标签管理

---

## 2. 任务清单

### 2.1 卡片类型扩展

#### 任务 5.1.1: 扩展卡片类型定义
**优先级**: P0  
**描述**: 扩展 `src/types/card.ts`

```typescript
// 新增类型定义

/**
 * 卡片创建选项
 */
export interface CreateCardOptions {
  name: string;
  type?: string;
  theme?: string;
  tags?: Tag[];
  metadata?: Partial<CardMetadata>;
}

/**
 * 卡片更新选项
 */
export interface UpdateCardOptions {
  name?: string;
  theme?: string;
  tags?: Tag[];
  metadata?: Partial<CardMetadata>;
}

/**
 * 卡片查询选项
 */
export interface QueryCardOptions {
  tags?: Tag[];
  type?: string;
  name?: string;
  createdAfter?: Timestamp;
  createdBefore?: Timestamp;
  modifiedAfter?: Timestamp;
  modifiedBefore?: Timestamp;
  limit?: number;
  offset?: number;
}

/**
 * 基础卡片数据
 */
export interface BaseCardData {
  id: ChipsId;
  type: string;
  config: Record<string, unknown>;
  content: unknown;
}

/**
 * 卡片资源
 */
export interface CardResource {
  path: string;
  name: string;
  type: string;
  size: number;
  data?: ArrayBuffer;
}
```

**验收标准**:
- [ ] 类型定义完整
- [ ] 支持 CRUD 操作

---

### 2.2 CardAPI 实现

#### 任务 5.2.1: 实现 CardAPI 类
**优先级**: P0  
**描述**: 创建 `src/api/card-api.ts`

```typescript
import { CoreConnector, ChipsError, ErrorCodes } from '../core';
import { Logger } from '../logger';
import { ConfigManager } from '../config';
import { EventBus } from '../event';
import { FileAPI } from './file-api';
import {
  Card,
  CardMetadata,
  CreateCardOptions,
  UpdateCardOptions,
  QueryCardOptions,
  BaseCardData,
  CardResource,
  Tag,
} from '../types/card';
import { ChipsId, Timestamp } from '../types/base';
import { generateId } from '../utils/id';

/**
 * 卡片 API
 */
export class CardAPI {
  private _connector: CoreConnector;
  private _logger: Logger;
  private _config: ConfigManager;
  private _eventBus: EventBus;
  private _fileApi: FileAPI;

  constructor(
    connector: CoreConnector,
    logger: Logger,
    config: ConfigManager,
    eventBus: EventBus,
    fileApi: FileAPI
  ) {
    this._connector = connector;
    this._logger = logger.createChild('CardAPI');
    this._config = config;
    this._eventBus = eventBus;
    this._fileApi = fileApi;
  }

  /**
   * 创建新卡片
   */
  async create(options: CreateCardOptions): Promise<Card> {
    this._logger.debug('Creating card', { options });

    const id = generateId();
    const now = new Date().toISOString();

    const metadata: CardMetadata = {
      chip_standards_version: '1.0.0',
      card_id: id,
      name: options.name,
      created_at: now,
      modified_at: now,
      theme: options.theme,
      tags: options.tags,
      ...options.metadata,
    };

    const card: Card = {
      id,
      metadata,
      structure: {
        structure: [],
        manifest: {
          card_count: 0,
          resource_count: 0,
          resources: [],
        },
      },
      resources: new Map(),
    };

    // 发布事件
    await this._eventBus.emit('card:created', { card });

    this._logger.info('Card created', { id, name: options.name });
    return card;
  }

  /**
   * 获取卡片（从文件加载）
   */
  async get(path: string): Promise<Card> {
    return this._fileApi.loadCard(path);
  }

  /**
   * 更新卡片
   */
  async update(card: Card, updates: UpdateCardOptions): Promise<Card> {
    this._logger.debug('Updating card', { id: card.id, updates });

    const updatedMetadata: CardMetadata = {
      ...card.metadata,
      modified_at: new Date().toISOString(),
    };

    if (updates.name !== undefined) {
      updatedMetadata.name = updates.name;
    }
    if (updates.theme !== undefined) {
      updatedMetadata.theme = updates.theme;
    }
    if (updates.tags !== undefined) {
      updatedMetadata.tags = updates.tags;
    }
    if (updates.metadata) {
      Object.assign(updatedMetadata, updates.metadata);
    }

    const updatedCard: Card = {
      ...card,
      metadata: updatedMetadata,
    };

    // 发布事件
    await this._eventBus.emit('card:updated', { card: updatedCard, updates });

    this._logger.info('Card updated', { id: card.id });
    return updatedCard;
  }

  /**
   * 保存卡片到文件
   */
  async save(path: string, card: Card, overwrite = false): Promise<void> {
    await this._fileApi.saveCard(path, card, { overwrite });
    
    // 发布事件
    await this._eventBus.emit('card:saved', { path, card });
  }

  /**
   * 删除卡片文件
   */
  async delete(path: string): Promise<void> {
    this._logger.debug('Deleting card', { path });

    await this._fileApi.delete(path);

    // 发布事件
    await this._eventBus.emit('card:deleted', { path });

    this._logger.info('Card deleted', { path });
  }

  /**
   * 复制卡片
   */
  async copy(card: Card, newName?: string): Promise<Card> {
    const id = generateId();
    const now = new Date().toISOString();

    const copiedCard: Card = {
      id,
      metadata: {
        ...card.metadata,
        card_id: id,
        name: newName || `${card.metadata.name} (副本)`,
        created_at: now,
        modified_at: now,
      },
      structure: JSON.parse(JSON.stringify(card.structure)),
      resources: new Map(card.resources),
    };

    // 发布事件
    await this._eventBus.emit('card:copied', { original: card, copy: copiedCard });

    this._logger.info('Card copied', { originalId: card.id, newId: id });
    return copiedCard;
  }

  // ========== 基础卡片管理 ==========

  /**
   * 添加基础卡片
   */
  async addBaseCard(card: Card, baseCard: BaseCardData): Promise<Card> {
    this._logger.debug('Adding base card', { cardId: card.id, baseCardId: baseCard.id });

    const updatedStructure = {
      ...card.structure,
      structure: [...card.structure.structure, { id: baseCard.id, type: baseCard.type }],
      manifest: {
        ...card.structure.manifest,
        card_count: card.structure.manifest.card_count + 1,
      },
    };

    const updatedCard: Card = {
      ...card,
      metadata: {
        ...card.metadata,
        modified_at: new Date().toISOString(),
      },
      structure: updatedStructure,
    };

    // 发布事件
    await this._eventBus.emit('card:baseCardAdded', { card: updatedCard, baseCard });

    return updatedCard;
  }

  /**
   * 移除基础卡片
   */
  async removeBaseCard(card: Card, baseCardId: ChipsId): Promise<Card> {
    this._logger.debug('Removing base card', { cardId: card.id, baseCardId });

    const updatedStructure = {
      ...card.structure,
      structure: card.structure.structure.filter((bc) => bc.id !== baseCardId),
      manifest: {
        ...card.structure.manifest,
        card_count: Math.max(0, card.structure.manifest.card_count - 1),
      },
    };

    const updatedCard: Card = {
      ...card,
      metadata: {
        ...card.metadata,
        modified_at: new Date().toISOString(),
      },
      structure: updatedStructure,
    };

    // 发布事件
    await this._eventBus.emit('card:baseCardRemoved', { card: updatedCard, baseCardId });

    return updatedCard;
  }

  /**
   * 获取所有基础卡片
   */
  getBaseCards(card: Card): BaseCardData[] {
    return card.structure.structure as unknown as BaseCardData[];
  }

  /**
   * 获取基础卡片
   */
  getBaseCard(card: Card, baseCardId: ChipsId): BaseCardData | undefined {
    return card.structure.structure.find((bc) => bc.id === baseCardId) as unknown as BaseCardData;
  }

  // ========== 资源管理 ==========

  /**
   * 添加资源
   */
  async addResource(card: Card, resource: CardResource): Promise<Card> {
    this._logger.debug('Adding resource', { cardId: card.id, resourcePath: resource.path });

    if (!resource.data) {
      throw new ChipsError('RES-1001', 'Resource data is required');
    }

    const updatedResources = new Map(card.resources);
    updatedResources.set(resource.path, resource.data);

    const updatedManifest = {
      ...card.structure.manifest,
      resource_count: card.structure.manifest.resource_count + 1,
      resources: [
        ...card.structure.manifest.resources,
        {
          path: resource.path,
          size: resource.size,
          type: resource.type,
        },
      ],
    };

    const updatedCard: Card = {
      ...card,
      metadata: {
        ...card.metadata,
        modified_at: new Date().toISOString(),
      },
      structure: {
        ...card.structure,
        manifest: updatedManifest,
      },
      resources: updatedResources,
    };

    // 发布事件
    await this._eventBus.emit('card:resourceAdded', { card: updatedCard, resource });

    return updatedCard;
  }

  /**
   * 移除资源
   */
  async removeResource(card: Card, resourcePath: string): Promise<Card> {
    this._logger.debug('Removing resource', { cardId: card.id, resourcePath });

    const updatedResources = new Map(card.resources);
    updatedResources.delete(resourcePath);

    const updatedManifest = {
      ...card.structure.manifest,
      resource_count: Math.max(0, card.structure.manifest.resource_count - 1),
      resources: card.structure.manifest.resources.filter((r) => r.path !== resourcePath),
    };

    const updatedCard: Card = {
      ...card,
      metadata: {
        ...card.metadata,
        modified_at: new Date().toISOString(),
      },
      structure: {
        ...card.structure,
        manifest: updatedManifest,
      },
      resources: updatedResources,
    };

    // 发布事件
    await this._eventBus.emit('card:resourceRemoved', { card: updatedCard, resourcePath });

    return updatedCard;
  }

  /**
   * 获取资源
   */
  getResource(card: Card, resourcePath: string): ArrayBuffer | undefined {
    return card.resources.get(resourcePath) as ArrayBuffer | undefined;
  }

  /**
   * 获取所有资源信息
   */
  getResourceList(card: Card): CardResource[] {
    return card.structure.manifest.resources.map((r) => ({
      ...r,
      name: r.path.split('/').pop() || r.path,
    }));
  }

  // ========== 标签管理 ==========

  /**
   * 添加标签
   */
  async addTag(card: Card, tag: Tag): Promise<Card> {
    this._logger.debug('Adding tag', { cardId: card.id, tag });

    const currentTags = card.metadata.tags || [];
    
    // 检查是否已存在
    if (this._hasTag(currentTags, tag)) {
      return card;
    }

    const updatedCard: Card = {
      ...card,
      metadata: {
        ...card.metadata,
        tags: [...currentTags, tag],
        modified_at: new Date().toISOString(),
      },
    };

    // 发布事件
    await this._eventBus.emit('card:tagAdded', { card: updatedCard, tag });

    return updatedCard;
  }

  /**
   * 移除标签
   */
  async removeTag(card: Card, tag: Tag): Promise<Card> {
    this._logger.debug('Removing tag', { cardId: card.id, tag });

    const currentTags = card.metadata.tags || [];
    const updatedTags = currentTags.filter((t) => !this._tagEquals(t, tag));

    const updatedCard: Card = {
      ...card,
      metadata: {
        ...card.metadata,
        tags: updatedTags,
        modified_at: new Date().toISOString(),
      },
    };

    // 发布事件
    await this._eventBus.emit('card:tagRemoved', { card: updatedCard, tag });

    return updatedCard;
  }

  /**
   * 获取所有标签
   */
  getTags(card: Card): Tag[] {
    return card.metadata.tags || [];
  }

  /**
   * 检查是否有标签
   */
  hasTag(card: Card, tag: Tag): boolean {
    return this._hasTag(card.metadata.tags || [], tag);
  }

  // ========== 私有方法 ==========

  private _hasTag(tags: Tag[], tag: Tag): boolean {
    return tags.some((t) => this._tagEquals(t, tag));
  }

  private _tagEquals(a: Tag, b: Tag): boolean {
    if (typeof a === 'string' && typeof b === 'string') {
      return a === b;
    }
    if (Array.isArray(a) && Array.isArray(b)) {
      return a.length === b.length && a.every((v, i) => v === b[i]);
    }
    return false;
  }
}
```

**验收标准**:
- [ ] 卡片 CRUD 操作正常
- [ ] 基础卡片管理正常
- [ ] 资源管理正常
- [ ] 标签管理正常

---

### 2.3 单元测试

#### 任务 5.3.1: 创建 CardAPI 单元测试
**优先级**: P0  
**描述**: 创建 `tests/unit/api/card-api.test.ts`

**测试用例**:
1. 创建卡片
2. 获取卡片
3. 更新卡片
4. 删除卡片
5. 复制卡片
6. 添加/移除基础卡片
7. 添加/移除资源
8. 添加/移除标签
9. 事件发布

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 覆盖率 ≥ 85%

---

## 3. 验收标准

### 3.1 功能验收

- [ ] 卡片创建正常
- [ ] 卡片读取正常
- [ ] 卡片更新正常
- [ ] 卡片删除正常
- [ ] 基础卡片管理完整
- [ ] 资源管理完整
- [ ] 标签管理完整
- [ ] 事件发布正常

### 3.2 代码质量

- [ ] 测试覆盖率 ≥ 85%
- [ ] 所有方法有 JSDoc 注释
- [ ] 错误处理完善

---

## 4. 注意事项

1. **ID 唯一性**: 每个卡片必须有唯一的 ID
2. **时间戳**: modified_at 必须在每次修改时更新
3. **事件发布**: 所有变更操作必须发布对应事件
4. **不可变性**: 所有更新操作返回新对象，不修改原对象

---

**状态更新日期**: 2026-02-01
