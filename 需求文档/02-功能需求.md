# 功能需求

## 1. 核心功能概述

Chips SDK 的核心功能分为五大模块：
1. **文件操作**：读取、写入、解析卡片文件
2. **渲染引擎**：渲染各种类型的卡片内容
3. **编辑器**：创建和编辑卡片内容
4. **资源管理**：管理文件、缓存和资源
5. **主题系统**：样式定制和主题切换

## 2. 文件操作模块

### 2.1 文件读取

#### 2.1.1 读取卡片文件
```javascript
// 读取单个卡片文件
const card = await chips.loadCard('path/to/card.card');

// 读取多个卡片
const cards = await chips.loadCards([
  'card1.card',
  'card2.card',
  'card3.card'
]);

// 从 URL 读取
const remoteCard = await chips.loadCard('https://example.com/card.card');

// 从 Blob/File 对象读取
const fileCard = await chips.loadCard(fileObject);
```

**功能要求**：
- 支持本地文件路径
- 支持 HTTP/HTTPS URL
- 支持 File/Blob 对象
- 支持批量读取
- 自动检测文件编码
- 验证文件格式和完整性
- 错误处理和降级

#### 2.1.2 解析卡片数据
```javascript
// 解析卡片 JSON 数据
const card = chips.parseCard(jsonString);

// 验证卡片数据
const isValid = chips.validateCard(card);

// 获取卡片元数据
const metadata = chips.getCardMetadata('card.card');
```

### 2.2 文件写入

#### 2.2.1 保存卡片文件
```javascript
// 保存卡片到文件
await chips.saveCard(card, 'output.card');

// 保存为 Blob
const blob = await chips.saveCardAsBlob(card);

// 保存为 JSON 字符串
const json = chips.serializeCard(card);

// 批量保存
await chips.saveCards(cards, 'output-dir/');
```

**功能要求**：
- 支持保存到本地文件
- 支持保存为 Blob 对象
- 支持序列化为 JSON
- 支持批量保存
- 自动创建目录
- 文件冲突处理
- 保存进度回调

#### 2.2.2 导出其他格式
```javascript
// 导出为 HTML
const html = await chips.exportToHTML(card);

// 导出为 Markdown
const markdown = await chips.exportToMarkdown(card);

// 导出为 PDF
const pdf = await chips.exportToPDF(card);

// 导出为图片
const image = await chips.exportToImage(card, {
  format: 'png',
  width: 1200,
  quality: 0.9
});
```

### 2.3 文件转换

#### 2.3.1 导入其他格式
```javascript
// 从 Markdown 导入
const card = await chips.importFromMarkdown(markdownText);

// 从 HTML 导入
const card = await chips.importFromHTML(htmlString);

// 从 Word 文档导入
const card = await chips.importFromDocx(docxFile);

// 从 PDF 导入
const card = await chips.importFromPDF(pdfFile);
```

## 3. 渲染引擎模块

### 3.1 基础渲染

#### 3.1.1 渲染卡片
```javascript
// 渲染卡片到指定容器
await chips.renderCard(card, '#container');

// 使用渲染选项
await chips.renderCard(card, '#container', {
  theme: 'dark',
  readOnly: true,
  interactive: true,
  animations: true
});

// 渲染并返回元素
const element = await chips.renderCardToElement(card, options);
```

**功能要求**：
- 支持所有卡片类型的渲染
- 主题应用
- 响应式布局
- 交互控制
- 动画效果
- 懒加载
- 虚拟滚动

#### 3.1.2 渲染箱子
```javascript
// 渲染箱子
await chips.renderBox(boxPath, '#container', {
  layout: 'grid',  // grid, waterfall, list, kanban
  columns: 3,
  gap: 16
});

// 自定义箱子渲染
await chips.renderBox(boxPath, '#container', {
  renderCard: (card, container) => {
    // 自定义卡片渲染逻辑
  },
  onCardClick: (card) => {
    // 卡片点击处理
  }
});
```

### 3.2 渲染控制

#### 3.2.1 渲染器实例
```javascript
// 创建渲染器实例
const renderer = chips.createRenderer({
  theme: 'light',
  container: '#app'
});

// 渲染多个卡片
await renderer.render(card1);
await renderer.render(card2);

// 清空渲染内容
renderer.clear();

// 销毁渲染器
renderer.destroy();
```

#### 3.2.2 更新渲染
```javascript
// 更新卡片内容
await renderer.update(cardId, {
  content: newContent
});

// 重新渲染
await renderer.rerender();

// 部分更新
await renderer.updatePartial(cardId, 'content.text', 'New text');
```

### 3.3 渲染事件

```javascript
// 监听渲染事件
renderer.on('render:start', (card) => {
  console.log('开始渲染:', card.id);
});

renderer.on('render:complete', (card) => {
  console.log('渲染完成:', card.id);
});

renderer.on('render:error', (error) => {
  console.error('渲染错误:', error);
});
```

## 4. 编辑器模块

### 4.1 创建编辑器

#### 4.1.1 基础编辑器
```javascript
// 创建编辑器
const editor = chips.createEditor('#editor', {
  mode: 'wysiwyg',  // wysiwyg, markdown, split
  toolbar: true,
  sidebar: true,
  autoSave: false
});

// 加载卡片到编辑器
await editor.loadCard('card.card');

// 创建新卡片
editor.createCard('richtext');
```

**功能要求**：
- 所见即所得编辑
- Markdown 模式
- 分屏模式（编辑+预览）
- 工具栏和侧边栏
- 自动保存
- 撤销/重做
- 协作编辑（未来）

#### 4.1.2 内联编辑器
```javascript
// 创建内联编辑器（嵌入现有页面）
const inlineEditor = chips.createInlineEditor('#content', {
  card: existingCard,
  toolbar: 'bubble',  // bubble, float, none
  placeholder: '开始输入...'
});
```

### 4.2 编辑操作

#### 4.2.1 内容编辑
```javascript
// 插入内容
editor.insertText('Hello World');
editor.insertImage('image.jpg');
editor.insertVideo('video.mp4');

// 格式化文本
editor.format('bold');
editor.format('italic');
editor.format('color', '#ff0000');

// 插入卡片
editor.insertCard({ type: 'code', language: 'javascript' });
```

#### 4.2.2 选择和光标
```javascript
// 获取选中文本
const selected = editor.getSelection();

// 设置选区
editor.setSelection(start, end);

// 获取光标位置
const cursor = editor.getCursor();

// 移动光标
editor.moveCursor(position);
```

#### 4.2.3 历史操作
```javascript
// 撤销
editor.undo();

// 重做
editor.redo();

// 获取历史记录
const history = editor.getHistory();

// 清空历史
editor.clearHistory();
```

### 4.3 编辑器事件

```javascript
// 内容变化
editor.on('change', (delta) => {
  console.log('内容已更改:', delta);
});

// 选区变化
editor.on('selection-change', (range) => {
  console.log('选区变化:', range);
});

// 保存
editor.on('save', async () => {
  const card = await editor.getCard();
  await chips.saveCard(card, 'output.card');
});
```

### 4.4 获取编辑结果

```javascript
// 获取卡片数据
const card = await editor.getCard();

// 获取 HTML
const html = editor.getHTML();

// 获取 Markdown
const markdown = editor.getMarkdown();

// 获取纯文本
const text = editor.getText();
```

## 5. 资源管理模块

### 5.1 文件管理

#### 5.1.1 文件系统访问
```javascript
// 创建文件管理器
const fileManager = chips.createFileManager({
  basePath: './cards/',
  autoIndex: true
});

// 列出文件
const files = await fileManager.list('*.card');

// 检查文件是否存在
const exists = await fileManager.exists('card.card');

// 复制文件
await fileManager.copy('src.card', 'dest.card');

// 移动文件
await fileManager.move('old.card', 'new.card');

// 删除文件
await fileManager.delete('card.card');
```

#### 5.1.2 目录管理
```javascript
// 创建目录
await fileManager.mkdir('new-folder');

// 删除目录
await fileManager.rmdir('folder');

// 遍历目录
await fileManager.walk('/', (path, stat) => {
  console.log(path, stat);
});
```

### 5.2 缓存管理

#### 5.2.1 缓存控制
```javascript
// 创建缓存管理器
const cacheManager = chips.createCacheManager({
  maxSize: 100 * 1024 * 1024,  // 100MB
  ttl: 3600 * 1000  // 1小时
});

// 缓存卡片
await cacheManager.set('card-123', cardData);

// 获取缓存
const cached = await cacheManager.get('card-123');

// 删除缓存
await cacheManager.delete('card-123');

// 清空缓存
await cacheManager.clear();
```

#### 5.2.2 缓存策略
```javascript
// 设置缓存策略
cacheManager.setStrategy('lru');  // lru, lfu, fifo

// 获取缓存统计
const stats = cacheManager.getStats();
console.log('命中率:', stats.hitRate);
console.log('大小:', stats.size);
```

### 5.3 资源加载

#### 5.3.1 图片资源
```javascript
// 加载图片
const image = await chips.loadImage('image.jpg');

// 预加载图片
await chips.preloadImages(['img1.jpg', 'img2.jpg']);

// 生成缩略图
const thumbnail = await chips.generateThumbnail('image.jpg', {
  width: 200,
  height: 200,
  quality: 0.8
});
```

#### 5.3.2 媒体资源
```javascript
// 加载视频
const video = await chips.loadVideo('video.mp4');

// 加载音频
const audio = await chips.loadAudio('music.mp3');

// 获取媒体元数据
const metadata = await chips.getMediaMetadata('video.mp4');
```

## 6. 主题系统模块

### 6.1 主题管理

#### 6.1.1 加载主题
```javascript
// 加载内置主题
chips.loadTheme('dark');
chips.loadTheme('light');

// 加载自定义主题
chips.loadTheme({
  id: 'my-theme',
  name: 'My Theme',
  colors: {
    primary: '#1976d2',
    background: '#ffffff',
    text: '#212121'
  },
  typography: {
    fontFamily: 'Arial, sans-serif',
    fontSize: '16px'
  }
});

// 从 URL 加载主题
await chips.loadThemeFromURL('https://example.com/theme.json');
```

#### 6.1.2 应用主题
```javascript
// 应用主题到渲染器
renderer.setTheme('dark');

// 应用主题到编辑器
editor.setTheme('light');

// 全局应用主题
chips.setTheme('dark');
```

### 6.2 主题定制

#### 6.2.1 创建主题
```javascript
// 创建主题构建器
const themeBuilder = chips.createThemeBuilder();

// 设置颜色
themeBuilder.setColors({
  primary: '#1976d2',
  secondary: '#424242'
});

// 设置字体
themeBuilder.setTypography({
  fontFamily: 'Roboto, sans-serif',
  fontSize: '16px'
});

// 设置间距
themeBuilder.setSpacing({
  sm: '8px',
  md: '16px',
  lg: '24px'
});

// 构建主题
const customTheme = themeBuilder.build();
```

#### 6.2.2 导出主题
```javascript
// 导出主题为 JSON
const themeJSON = chips.exportTheme('my-theme');

// 导出主题为 CSS
const themeCSS = chips.exportThemeAsCSS('my-theme');

// 保存主题文件
await chips.saveTheme('my-theme', 'theme.json');
```

### 6.3 主题切换

```javascript
// 动画切换主题
await chips.transitionTheme('dark', {
  duration: 300,
  easing: 'ease-in-out'
});

// 自动跟随系统主题
chips.autoTheme(true);

// 监听系统主题变化
chips.on('system-theme-change', (theme) => {
  console.log('系统主题已更改:', theme);
});
```

## 7. 搜索和过滤

### 7.1 搜索功能

```javascript
// 搜索卡片内容
const results = await chips.search('关键词', {
  caseSensitive: false,
  wholeWord: false,
  regex: false
});

// 高级搜索
const results = await chips.search({
  query: '关键词',
  type: 'richtext',
  tags: ['重要', '工作'],
  dateRange: {
    start: '2024-01-01',
    end: '2024-12-31'
  }
});
```

### 7.2 过滤功能

```javascript
// 按类型过滤
const textCards = cards.filter(chip.filters.byType('richtext'));

// 按标签过滤
const tagged = cards.filter(chips.filters.byTags(['重要']));

// 自定义过滤
const filtered = cards.filter(chips.filters.custom((card) => {
  return card.metadata.author === 'John';
}));
```

## 8. 插件系统

### 8.1 使用插件

```javascript
// 注册插件
chips.use(MyPlugin, options);

// 批量注册
chips.use([Plugin1, Plugin2, Plugin3]);

// 卸载插件
chips.unuse('plugin-id');
```

### 8.2 插件开发

```javascript
// 创建插件
const MyPlugin = {
  id: 'my-plugin',
  name: 'My Plugin',
  version: '1.0.0',
  
  install(chips, options) {
    // 插件初始化逻辑
    chips.registerCardType('custom', CustomCardRenderer);
  },
  
  uninstall(chips) {
    // 插件清理逻辑
  }
};
```

## 9. 工具函数

### 9.1 数据验证

```javascript
// 验证卡片数据
const isValid = chips.validate.card(cardData);

// 验证特定字段
const isValidTitle = chips.validate.title(title);
const isValidURL = chips.validate.url(url);

// 自定义验证
const result = chips.validate.custom(data, schema);
```

### 9.2 数据转换

```javascript
// 转换卡片版本
const upgraded = chips.convert.upgradeCard(oldCard, 'v2.0');

// 转换数据格式
const json = chips.convert.toJSON(card);
const yaml = chips.convert.toYAML(card);
```

### 9.3 工具方法

```javascript
// 生成唯一 ID
const id = chips.utils.generateId();

// 深拷贝对象
const copy = chips.utils.deepClone(card);

// 合并对象
const merged = chips.utils.merge(obj1, obj2);

// 防抖和节流
const debounced = chips.utils.debounce(fn, 300);
const throttled = chips.utils.throttle(fn, 100);
```

## 10. 性能优化

### 10.1 懒加载

```javascript
// 懒加载配置
chips.configure({
  lazyLoad: {
    enabled: true,
    threshold: 200,  // 距离视口 200px 时加载
    placeholder: 'Loading...'
  }
});
```

### 10.2 虚拟滚动

```javascript
// 启用虚拟滚动
await chips.renderBox(boxPath, '#container', {
  virtualScroll: {
    enabled: true,
    itemHeight: 200,
    buffer: 5
  }
});
```

### 10.3 性能监控

```javascript
// 启用性能监控
chips.enablePerfMonitor();

// 获取性能报告
const report = chips.getPerformanceReport();
console.log('渲染时间:', report.renderTime);
console.log('内存使用:', report.memoryUsage);
```

## 11. 错误处理

### 11.1 错误捕获

```javascript
// 全局错误处理
chips.on('error', (error) => {
  console.error('SDK错误:', error);
  
  // 上报错误
  reportError(error);
});

// Try-catch 错误处理
try {
  await chips.loadCard('card.card');
} catch (error) {
  if (error instanceof chips.FileNotFoundError) {
    console.error('文件不存在');
  } else if (error instanceof chips.ParseError) {
    console.error('解析错误');
  }
}
```

### 11.2 错误类型

```typescript
// SDK 提供的错误类型
class ChipsError extends Error {}
class FileNotFoundError extends ChipsError {}
class ParseError extends ChipsError {}
class RenderError extends ChipsError {}
class ValidationError extends ChipsError {}
class NetworkError extends ChipsError {}
```

## 12. 调试支持

### 12.1 调试模式

```javascript
// 启用调试模式
chips.enableDebug(true);

// 设置日志级别
chips.setLogLevel('debug');  // debug, info, warn, error

// 查看内部状态
const state = chips.getDebugState();
console.log(state);
```

### 12.2 开发工具

```javascript
// 启用 DevTools 扩展
chips.enableDevTools();

// 导出调试信息
const debugInfo = chips.exportDebugInfo();

// 性能分析
chips.startProfiling();
// ... 执行操作
const profile = chips.stopProfiling();
```

## 13. 跨平台特性

### 13.1 平台检测

```javascript
// 检测当前平台
const platform = chips.getPlatform();
// 返回: 'web', 'node', 'electron', 'mobile', etc.

// 检测功能支持
const hasFileSystem = chips.supports('filesystem');
const hasWebGL = chips.supports('webgl');
```

### 13.2 平台适配

```javascript
// 平台特定配置
chips.configure({
  web: {
    useBlobURL: true
  },
  node: {
    useFileSystem: true
  },
  mobile: {
    optimizeForTouch: true
  }
});
```

## 14. 多语言支持

SDK完全集成薯片生态的系统统一多语言方案。

> **详细规范**: 参见 [多语言系统规范](../../生态共用/11-多语言系统规范.md)

### 14.1 核心特性

- **零硬编码**：SDK内部和API返回的所有文本都使用系统词汇编码
- **系统接管**：文本显示由系统多语言引擎统一管理
- **自动切换**：切换语言后，所有文本自动更新
- **开发友好**：开发时使用key，打包时自动替换为编码

### 14.2 语言设置

```javascript
import { ChipsSDK } from '@chips/sdk';

const chips = new ChipsSDK();

// 设置语言（支持：zh-CN、zh-TW、en-US、ja-JP、ko-KR）
await chips.setLanguage('en-US');

// 获取当前语言
const currentLang = chips.getLanguage();
// 返回: 'en-US'

// 监听语言切换
chips.onLanguageChange((lang) => {
  console.log(`语言已切换为: ${lang}`);
});
```

### 14.3 SDK内部文本

SDK内部的所有文本（错误信息、提示、状态等）都使用系统多语言：

```javascript
// SDK错误信息会自动使用当前语言
try {
  await chips.loadCard('invalid.card');
} catch (error) {
  // 简体中文: "文件未找到"
  // English: "File not found"
  console.error(error.message);
}
```

### 14.4 开发者文本处理

开发者在应用中使用多语言：

```javascript
import { t } from '@chips/i18n';

// 开发时使用清晰的key
const saveBtn = t('common.save');
const cancelBtn = t('common.cancel');

// 支持变量插值
const msg = t('ui.file_count', { count: 5 });
// 简体中文: "共 5 个文件"
// English: "5 files"

// 打包后自动替换为系统编码
// t('i18n.core.000003')
// t('i18n.core.000002')
```

### 14.5 词汇编码说明

开发者无需关心具体编码，构建工具会自动处理：

| 开发时key | 系统编码 | 说明 |
|----------|---------|------|
| `common.save` | `i18n.core.000003` | 核心词汇"保存" |
| `common.cancel` | `i18n.core.000002` | 核心词汇"取消" |
| `editor.placeholder` | `i18n.editor.200xxx` | 编辑器词汇 |

## 15. 总结

Chips SDK 提供了完整、强大且易用的功能集：

**核心优势**：
- 🎯 **功能完整**：覆盖卡片操作的所有需求
- 🚀 **性能优秀**：优化的渲染和加载策略
- 🔧 **灵活可扩展**：插件系统支持定制
- 📱 **跨平台**：统一 API,多平台运行
- 🐛 **调试友好**：完善的错误处理和调试工具

通过这些功能,开发者可以轻松构建功能丰富的卡片应用。
