# SDK - 架构设计

**版本**: 1.0.0  
**更新日期**: 2026-01-31  
**状态**: 正式版

---

## 1. 整体架构

### 1.1 架构概览

```
┌─────────────────────────────────────────────────────────┐
│                  第三方应用 / 插件开发者                  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    Chips SDK 1.0.0                      │
│  ┌─────────────────────────────────────────────────┐  │
│  │            ChipsSDK (主类)                       │  │
│  │  统一入口 | 简化 API | 开发者友好                │  │
│  └─────────────────────────────────────────────────┘  │
│                            ↓                            │
│  ┌──────────────┬──────────────┬──────────────────┐  │
│  │  FileAPI     │  CardAPI     │  BoxAPI          │  │
│  │  文件操作     │  卡片管理     │  箱子管理         │  │
│  └──────────────┴──────────────┴──────────────────┘  │
│                            ↓                            │
│  ┌──────────────┬──────────────┬──────────────────┐  │
│  │ Renderer     │ PluginSystem │ ThemeManager     │  │
│  │ 渲染引擎      │ 插件系统      │ 主题管理          │  │
│  └──────────────┴──────────────┴──────────────────┘  │
│                            ↓                            │
│  ┌──────────────┬──────────────┬──────────────────┐  │
│  │ Resource     │ EventBus     │ ConfigManager    │  │
│  │ 资源管理      │ 事件系统      │ 配置管理          │  │
│  └──────────────┴──────────────┴──────────────────┘  │
│                            ↓                            │
│  ┌──────────────┬──────────────┬──────────────────┐  │
│  │ I18nManager  │ Logger       │ CoreConnector    │  │
│  │ 多语言        │ 日志系统      │ Core 连接器       │  │
│  └──────────────┴──────────────┴──────────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              CoreConnector (通信层)                      │
│  中心路由请求 | 响应处理 | 错误处理                       │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                Chips Core 1.0.0                         │
│  中心路由 | 模块管理 | 生命周期管理 | 事件总线           │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│           Chips Foundation 1.0.0                        │
│  媒体处理 | 文本处理 | 文件处理 | 网络 | 界面 | 系统     │
└─────────────────────────────────────────────────────────┘
```

### 1.2 架构特点

**分层清晰**:
- 表现层: ChipsSDK 主类,提供统一入口
- 业务层: FileAPI、CardAPI、BoxAPI 等业务模块
- 功能层: Renderer、Plugin、Theme 等功能模块
- 支撑层: Event、Config、I18n、Logger 等支撑模块
- 通信层: CoreConnector,封装与 Core 的通信

**职责明确**:
- SDK 层: 封装友好 API,简化开发
- Core 层: 中心路由,模块管理
- Foundation 层: 通用功能实现

**松耦合**:
- 模块间通过接口通信
- 避免直接依赖
- 易于扩展和测试

---

## 2. 核心模块

### 2.1 ChipsSDK (主类)

**职责**:
- 提供统一的入口点
- 初始化和管理所有子模块
- 提供简化的 API 方法
- 处理全局配置和事件

**关键方法**:
```typescript
class ChipsSDK {
  // 初始化
  constructor(options?: SDKOptions)
  async initialize(): Promise<void>
  
  // 文件操作快捷方法
  async loadCard(path: string): Promise<Card>
  async saveCard(card: Card, path: string): Promise<void>
  
  // 渲染快捷方法
  async renderCard(card: Card, container: string | HTMLElement): Promise<RenderInstance>
  
  // 插件快捷方法
  async registerPlugin(plugin: Plugin): Promise<void>
  
  // 主题快捷方法
  setTheme(themeId: string): void
  
  // 事件快捷方法
  on(event: string, handler: EventHandler): void
  emit(event: string, data?: any): void
  
  // 访问各个模块
  get file(): FileAPI
  get card(): CardAPI
  get box(): BoxAPI
  get renderer(): RendererEngine
  // ... 其他模块
}
```

### 2.2 CoreConnector (通信层)

**职责**:
- 封装与 Chips Core 的通信
- 将 SDK 调用转换为 Core 请求
- 处理响应和错误
- 管理连接状态

**通信流程**:
```
SDK API 调用
  ↓
CoreConnector.request()
  ↓
构造标准请求对象
  ↓
发送到 Chips Core
  ↓
Core 路由到 Foundation
  ↓
Foundation 执行操作
  ↓
返回结果
  ↓
CoreConnector 处理响应
  ↓
返回给 SDK API
```

**关键方法**:
```typescript
class CoreConnector {
  async request(params: RequestParams): Promise<ResponseData>
  async connect(url: string): Promise<void>
  disconnect(): void
  get isConnected(): boolean
}

interface RequestParams {
  service: string;
  method: string;
  payload: any;
  timeout?: number;
}

interface ResponseData {
  status: 'success' | 'error';
  data?: any;
  error?: ErrorInfo;
}
```

### 2.3 FileAPI

**职责**:
- 封装文件操作
- 处理 ZIP 文件解析
- 处理 YAML 配置解析
- 管理文件缓存

**关键流程**:
```
loadCard()
  ↓
检查缓存
  ↓ (缓存未命中)
CoreConnector.request('resource.read')
  ↓ (Core 路由到 Foundation.ZIPProcessor)
读取 ZIP 文件
  ↓
解析 .card/ 目录
  ↓ (Core 路由到 Foundation.YAMLParser)
解析 YAML 配置
  ↓
构造 Card 对象
  ↓
缓存结果
  ↓
返回 Card 对象
```

### 2.4 CardAPI & BoxAPI

**职责**:
- 提供卡片和箱子的业务操作
- 封装复杂的数据处理
- 维护数据一致性

**关键方法**:
```typescript
class CardAPI {
  create(type: string, config?: any): Card
  getMetadata(card: Card): CardMetadata
  setMetadata(card: Card, metadata: Partial<CardMetadata>): void
  addBaseCard(card: Card, type: string, config: any): string
  addResource(card: Card, file: File, path: string): Promise<string>
}

class BoxAPI {
  create(name: string, layout: string): Box
  addCard(box: Box, card: Card | string, mode: 'copy' | 'move' | 'reference'): Promise<void>
  setLayout(box: Box, layoutId: string): void
  setLayoutConfig(box: Box, config: any): void
}
```

### 2.5 RendererEngine

**职责**:
- 封装渲染逻辑
- 管理渲染器插件
- 应用主题
- 处理渲染生命周期

**渲染流程**:
```
renderCard(card, container, options)
  ↓
解析 Card.structure
  ↓
对于每个基础卡片:
  ↓
  获取对应的渲染器插件
  ↓ (通过 PluginSystem)
  获取插件实例
  ↓
  调用插件的 render() 方法
  ↓ (插件通过 CoreConnector 调用 Foundation)
  Foundation 处理资源加载、媒体渲染等
  ↓
  返回渲染的 DOM 元素
  ↓
  应用主题样式
  ↓
插入到容器
  ↓
返回 RenderInstance
```

### 2.6 PluginSystem

**职责**:
- 管理插件注册和卸载
- 处理插件生命周期
- 解析插件依赖
- 提供插件查询

**插件加载流程**:
```
registerPlugin(plugin)
  ↓
验证插件元数据
  ↓
检查ID冲突
  ↓
解析依赖
  ↓
调用 plugin.initialize(context)
  ↓
存储到插件注册表
  ↓
触发 'plugin:register' 事件
```

### 2.7 ThemeManager

**职责**:
- 管理主题注册和应用
- 处理 CSS 变量
- 支持主题切换
- 支持变量覆盖

**主题应用流程**:
```
setTheme(themeId)
  ↓
获取主题对象
  ↓
构造 CSS 变量
  ↓
更新 :root 元素的 style
  ↓
应用组件样式
  ↓
注入自定义 CSS
  ↓
触发 'theme:change' 事件
```

### 2.8 ResourceManager

**职责**:
- 统一资源访问接口
- 处理路径解析
- 管理资源缓存
- 支持多种资源协议

**资源加载流程**:
```
load(uri)
  ↓
解析 URI
  ↓
检查缓存
  ↓ (缓存未命中)
根据协议选择提供者:
  chips://  → 通过 CoreConnector
  file://   → 本地文件系统
  https://  → HTTP 请求
  ↓
加载资源
  ↓
缓存资源
  ↓
返回资源数据
```

---

## 3. 数据流

### 3.1 文件加载流程

```typescript
// 用户代码
const card = await sdk.loadCard('path/to/card.card');

// 内部流程
sdk.loadCard()
  ↓
fileAPI.loadCard()
  ↓
coreConnector.request({
  service: 'resource',
  method: 'read',
  payload: { path: 'path/to/card.card' }
})
  ↓
Chips Core 路由到 Foundation.ZIPProcessor
  ↓
读取和解析 ZIP 文件
  ↓
返回文件内容
  ↓
fileAPI 解析 YAML 配置
  ↓
构造 Card 对象
  ↓
缓存结果
  ↓
返回给用户
```

### 3.2 渲染流程

```typescript
// 用户代码
await sdk.renderCard(card, '#container');

// 内部流程
sdk.renderCard()
  ↓
rendererEngine.renderCard()
  ↓
解析 card.structure
  ↓
对于每个基础卡片:
  ↓
  pluginSystem.get(baseCard.type)
  ↓
  plugin.createRenderer()
  ↓
  renderer.render(baseCardConfig, container)
    ↓ (渲染器通过 CoreConnector 调用 Foundation)
    例如视频卡片:
      coreConnector.request({
        service: 'media.video',
        method: 'createPlayer',
        payload: { src: videoPath }
      })
      ↓
      Foundation.VideoPlayer 创建播放器
      ↓
      返回播放器实例
      ↓
      渲染器将播放器插入到 DOM
  ↓
themeManager.apply(theme)
  ↓
返回 RenderInstance
```

### 3.3 插件调用流程

```typescript
// 插件代码
class VideoCardPlugin {
  async render(config, container) {
    // 插件通过 SDK context 访问 Foundation
    const player = await this.context.request({
      service: 'media.video',
      method: 'createPlayer',
      payload: { src: config.video_file }
    });
    
    container.appendChild(player.element);
  }
}

// 内部流程
plugin.render()
  ↓
context.request()
  ↓
coreConnector.request()
  ↓
Chips Core 路由
  ↓
Foundation.VideoPlayer
  ↓
返回播放器实例
  ↓
插件将其插入 DOM
```

---

## 4. 模块间通信

### 4.1 通信方式

**方法调用**:
- 模块间直接调用公开方法
- 适用于同步操作
- 简单直接

**事件通知**:
- 通过 EventBus 发布和订阅事件
- 适用于异步通知
- 松耦合

**CoreConnector 请求**:
- 需要 Foundation 能力时
- 通过 CoreConnector 发送请求
- Core 路由到 Foundation

### 4.2 通信示例

```typescript
// 1. 方法调用
const card = cardAPI.create('VideoCard', config);

// 2. 事件通知
eventBus.on('card:load', (card) => {
  logger.info('Card loaded', card.id);
});

fileAPI.loadCard('card.card').then(card => {
  eventBus.emit('card:load', card);
});

// 3. CoreConnector 请求
const player = await coreConnector.request({
  service: 'media.video',
  method: 'createPlayer',
  payload: { src: videoPath }
});
```

---

## 5. 技术选型

### 5.1 编程语言

**TypeScript 5.0+**:
- 强类型系统
- 优秀的 IDE 支持
- 编译时错误检查
- 现代 JavaScript 特性

### 5.2 构建工具

**Rollup**:
- 优秀的 Tree Shaking
- 支持多种输出格式
- 插件生态丰富
- 打包体积小

**备选: Webpack**:
- 功能强大
- 生态成熟
- 适合复杂场景

### 5.3 测试框架

**Vitest**:
- 快速的单元测试
- 与 Vite 集成良好
- 兼容 Jest API
- 支持 TypeScript

**Playwright**:
- 跨浏览器测试
- 可靠的端到端测试
- 强大的调试工具

### 5.4 依赖管理

**必需依赖**:
```json
{
  "dependencies": {
    "@chips/core": "^1.0.0",
    "@chips/foundation": "^1.0.0"
  }
}
```

**开发依赖**:
```json
{
  "devDependencies": {
    "typescript": "^5.0.0",
    "rollup": "^3.0.0",
    "vitest": "^1.0.0",
    "playwright": "^1.0.0"
  }
}
```

---

## 6. 设计模式

### 6.1 单例模式

**应用**: ChipsSDK 主类通常作为单例使用

```typescript
class ChipsSDK {
  private static instance: ChipsSDK;
  
  static getInstance(options?: SDKOptions): ChipsSDK {
    if (!ChipsSDK.instance) {
      ChipsSDK.instance = new ChipsSDK(options);
    }
    return ChipsSDK.instance;
  }
}
```

### 6.2 工厂模式

**应用**: 创建渲染器实例

```typescript
class RendererFactory {
  createRenderer(type: string): BaseCardRenderer {
    const plugin = this.pluginSystem.get(type);
    return plugin.createRenderer();
  }
}
```

### 6.3 观察者模式

**应用**: EventBus 事件系统

```typescript
class EventBus {
  private listeners = new Map<string, Set<EventHandler>>();
  
  on(event: string, handler: EventHandler): void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set());
    }
    this.listeners.get(event)!.add(handler);
  }
  
  emit(event: string, data?: any): void {
    this.listeners.get(event)?.forEach(handler => handler(data));
  }
}
```

### 6.4 策略模式

**应用**: 资源加载策略

```typescript
class ResourceManager {
  private providers = new Map<string, ResourceProvider>();
  
  async load(uri: string): Promise<Resource> {
    const protocol = this.getProtocol(uri);
    const provider = this.providers.get(protocol);
    return provider.load(uri);
  }
}
```

---

## 7. 性能优化

### 7.1 懒加载

**模块懒加载**:
```typescript
class ChipsSDK {
  private _renderer?: RendererEngine;
  
  get renderer(): RendererEngine {
    if (!this._renderer) {
      this._renderer = new RendererEngine(this._coreConnector);
    }
    return this._renderer;
  }
}
```

**资源懒加载**:
- 不预加载所有资源
- 渲染时按需加载
- 支持虚拟滚动

### 7.2 缓存

**文件缓存**:
- 加载过的卡片缓存在内存
- LRU 策略管理缓存
- 可配置缓存大小

**资源缓存**:
- 资源数据缓存
- 支持持久化缓存
- 自动过期管理

### 7.3 并发

**批量操作**:
```typescript
async loadCards(paths: string[]): Promise<Card[]> {
  return Promise.all(paths.map(path => this.loadCard(path)));
}
```

---

## 8. 错误处理

### 8.1 错误类型

```typescript
class ChipsError extends Error {
  constructor(
    public code: string,
    message: string,
    public details?: any
  ) {
    super(message);
    this.name = 'ChipsError';
  }
}
```

### 8.2 错误传播

```
用户代码调用
  ↓
SDK API
  ↓ (try-catch)
CoreConnector
  ↓ (响应检查)
Chips Core
  ↓ (错误返回)
CoreConnector 抛出 ChipsError
  ↓
SDK API 捕获并记录
  ↓
重新抛出或返回错误结果
  ↓
用户代码处理
```

---

## 9. 安全机制

### 9.1 输入验证

- 所有路径进行安全检查
- 防止路径遍历攻击
- 验证文件格式
- 限制文件大小

### 9.2 沙箱隔离

- 卡片封面在 iframe 沙箱运行
- 插件权限限制
- 资源访问控制

### 9.3 依赖安全

- 定期审查依赖漏洞
- 使用可信赖的依赖
- 锁定依赖版本

---

## 10. 扩展点

### 10.1 插件扩展

- 基础卡片插件
- 布局插件
- 主题插件
- 工具插件

### 10.2 资源提供者扩展

- 自定义资源协议
- 自定义资源加载逻辑

### 10.3 渲染器扩展

- 自定义渲染器
- 自定义渲染选项

---

**文档维护者**: Chips 生态核心团队  
**反馈渠道**: 提交 Issue 到官方仓库
