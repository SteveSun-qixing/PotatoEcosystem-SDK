# Phase12 - 集成测试与性能优化

**状态**: 待开始  
**预计时间**: 3-4 天  
**依赖**: Phase1 - Phase11

---

## 1. 阶段目标

- 完成集成测试
- 完成端到端测试
- 性能基准测试
- 性能优化
- 内存泄漏检测

---

## 2. 任务清单

### 2.1 集成测试

#### 任务 12.1.1: 文件操作集成测试
**优先级**: P0  
**描述**: 创建 `tests/integration/file-operations.test.ts`

**测试场景**:
1. 创建卡片 → 保存 → 加载 → 验证
2. 创建箱子 → 添加卡片 → 保存 → 加载 → 验证
3. 文件复制/移动/删除
4. 大文件处理
5. 并发文件操作
6. 文件损坏恢复

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { ChipsSDK, createSDK } from '../../src';

describe('File Operations Integration', () => {
  let sdk: ChipsSDK;
  const testDir = '/tmp/chips-sdk-test';

  beforeAll(async () => {
    sdk = createSDK({ autoConnect: false });
    await sdk.initialize();
  });

  afterAll(async () => {
    await sdk.destroy();
  });

  describe('Card File Operations', () => {
    it('should create, save, load, and validate a card', async () => {
      // 创建卡片
      const card = await sdk.createCard({ name: '测试卡片' });
      expect(card.id).toBeDefined();
      expect(card.metadata.name).toBe('测试卡片');

      // 保存卡片
      const path = `${testDir}/test-card.card`;
      await sdk.saveCard(path, card);

      // 加载卡片
      const loadedCard = await sdk.loadCard(path);
      expect(loadedCard.id).toBe(card.id);
      expect(loadedCard.metadata.name).toBe(card.metadata.name);
    });

    // 更多测试用例...
  });

  describe('Box File Operations', () => {
    it('should create box with cards', async () => {
      // 创建箱子和卡片
      const box = await sdk.createBox({ name: '测试箱子' });
      const card1 = await sdk.createCard({ name: '卡片1' });
      const card2 = await sdk.createCard({ name: '卡片2' });

      // 添加卡片到箱子
      const updatedBox = await sdk.box.addCard(box, {
        cardId: card1.id,
        location: 'internal',
      });

      expect(sdk.box.getCardCount(updatedBox)).toBe(1);
    });

    // 更多测试用例...
  });
});
```

**验收标准**:
- [ ] 卡片完整流程测试通过
- [ ] 箱子完整流程测试通过
- [ ] 边界条件测试通过

---

#### 任务 12.1.2: 卡片管理集成测试
**优先级**: P0  
**描述**: 创建 `tests/integration/card-management.test.ts`

**测试场景**:
1. 卡片 CRUD 完整流程
2. 基础卡片添加/删除/排序
3. 资源添加/删除
4. 标签管理
5. 卡片复制
6. 事件触发验证

**验收标准**:
- [ ] CRUD 流程测试通过
- [ ] 资源管理测试通过
- [ ] 事件验证测试通过

---

#### 任务 12.1.3: 箱子管理集成测试
**优先级**: P0  
**描述**: 创建 `tests/integration/box-management.test.ts`

**测试场景**:
1. 箱子 CRUD 完整流程
2. 卡片添加/删除/排序
3. 布局切换
4. 布局配置管理
5. 箱子复制
6. 事件触发验证

**验收标准**:
- [ ] CRUD 流程测试通过
- [ ] 布局管理测试通过
- [ ] 事件验证测试通过

---

#### 任务 12.1.4: 渲染集成测试
**优先级**: P0  
**描述**: 创建 `tests/integration/rendering.test.ts`

**测试场景**:
1. 卡片渲染 → 更新 → 销毁
2. 箱子渲染（带多卡片）
3. 主题应用
4. 插件渲染
5. 渲染实例管理
6. 渲染错误恢复

**验收标准**:
- [ ] 卡片渲染测试通过
- [ ] 箱子渲染测试通过
- [ ] 主题应用测试通过

---

#### 任务 12.1.5: 插件系统集成测试
**优先级**: P0  
**描述**: 创建 `tests/integration/plugin-system.test.ts`

**测试场景**:
1. 插件注册 → 激活 → 使用 → 卸载
2. 多插件交互
3. 插件错误隔离
4. 插件配置更新
5. 插件依赖检查

**验收标准**:
- [ ] 生命周期测试通过
- [ ] 错误隔离测试通过
- [ ] 配置管理测试通过

---

### 2.2 端到端测试

#### 任务 12.2.1: 配置 Playwright
**优先级**: P1  
**描述**: 创建 `playwright.config.ts`

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
});
```

**验收标准**:
- [ ] Playwright 配置完成
- [ ] 三种浏览器配置

---

#### 任务 12.2.2: SDK 初始化 E2E 测试
**优先级**: P1  
**描述**: 创建 `tests/e2e/sdk-init.spec.ts`

**测试场景**:
1. 浏览器环境 SDK 初始化
2. SDK 状态检查
3. 模块可用性验证
4. 错误处理

**验收标准**:
- [ ] 初始化测试通过
- [ ] 三种浏览器兼容

---

#### 任务 12.2.3: 卡片渲染 E2E 测试
**优先级**: P1  
**描述**: 创建 `tests/e2e/card-render.spec.ts`

**测试场景**:
1. 卡片加载和渲染
2. 交互测试
3. 主题切换
4. 响应式布局

**验收标准**:
- [ ] 渲染测试通过
- [ ] 交互测试通过

---

### 2.3 性能测试

#### 任务 12.3.1: 性能基准测试
**优先级**: P0  
**描述**: 创建 `tests/performance/benchmarks.test.ts`

**测试项目**:

```typescript
import { describe, it, expect } from 'vitest';
import { ChipsSDK, createSDK } from '../../src';

describe('Performance Benchmarks', () => {
  let sdk: ChipsSDK;

  beforeAll(async () => {
    sdk = createSDK();
  });

  describe('SDK Initialization', () => {
    it('should initialize within 200ms', async () => {
      const start = performance.now();
      const newSdk = createSDK();
      await newSdk.initialize();
      const duration = performance.now() - start;
      
      expect(duration).toBeLessThan(200);
      await newSdk.destroy();
    });
  });

  describe('File Operations', () => {
    it('should load small card (<1MB) within 100ms', async () => {
      const start = performance.now();
      await sdk.loadCard('/test/small-card.card');
      const duration = performance.now() - start;
      
      expect(duration).toBeLessThan(100);
    });

    it('should load medium card (1-10MB) within 500ms', async () => {
      const start = performance.now();
      await sdk.loadCard('/test/medium-card.card');
      const duration = performance.now() - start;
      
      expect(duration).toBeLessThan(500);
    });
  });

  describe('Rendering', () => {
    it('should render single card within 300ms', async () => {
      const card = await sdk.createCard({ name: 'Test' });
      const container = document.createElement('div');
      
      const start = performance.now();
      await sdk.renderCard(card, container);
      const duration = performance.now() - start;
      
      expect(duration).toBeLessThan(300);
    });

    it('should render box with 100 cards within 1000ms', async () => {
      const box = await sdk.createBox({ name: 'Test Box' });
      const cards = await Promise.all(
        Array(100).fill(null).map((_, i) => sdk.createCard({ name: `Card ${i}` }))
      );
      const container = document.createElement('div');
      
      const start = performance.now();
      await sdk.renderBox(box, container, cards);
      const duration = performance.now() - start;
      
      expect(duration).toBeLessThan(1000);
    });
  });

  describe('API Response Time', () => {
    it('should respond to API calls within 100ms', async () => {
      const times: number[] = [];
      
      for (let i = 0; i < 10; i++) {
        const start = performance.now();
        await sdk.createCard({ name: `Test ${i}` });
        times.push(performance.now() - start);
      }
      
      const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
      expect(avgTime).toBeLessThan(100);
    });
  });
});
```

**性能指标**:

| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| SDK 初始化时间 | < 200ms | performance.now() |
| 首次 API 调用响应 | < 100ms | performance.now() |
| 小文件加载（< 1MB）| < 100ms | performance.now() |
| 中文件加载（1-10MB）| < 500ms | performance.now() |
| 单卡片渲染 | < 300ms | performance.now() |
| 100 卡片渲染 | < 1000ms | performance.now() |
| 内存占用 | < 100MB | performance.memory |
| SDK 包体积 | < 500KB | rollup-plugin-size |

**验收标准**:
- [ ] 所有性能指标达标
- [ ] 性能报告生成

---

#### 任务 12.3.2: 内存泄漏测试
**优先级**: P0  
**描述**: 创建 `tests/performance/memory-leak.test.ts`

**测试场景**:
1. 反复创建/销毁 SDK 实例
2. 反复创建/销毁渲染实例
3. 反复注册/卸载插件
4. 反复订阅/取消订阅事件
5. 大量文件加载/卸载

```typescript
import { describe, it, expect } from 'vitest';
import { ChipsSDK, createSDK } from '../../src';

describe('Memory Leak Tests', () => {
  it('should not leak memory on repeated SDK lifecycle', async () => {
    const initialMemory = (performance as any).memory?.usedJSHeapSize;
    
    for (let i = 0; i < 10; i++) {
      const sdk = createSDK();
      await sdk.initialize();
      await sdk.destroy();
    }
    
    // 强制 GC（如果可用）
    if (global.gc) {
      global.gc();
    }
    
    const finalMemory = (performance as any).memory?.usedJSHeapSize;
    const memoryGrowth = finalMemory - initialMemory;
    
    // 允许 10MB 的增长
    expect(memoryGrowth).toBeLessThan(10 * 1024 * 1024);
  });

  it('should not leak memory on repeated render lifecycle', async () => {
    const sdk = createSDK();
    await sdk.initialize();
    
    const initialMemory = (performance as any).memory?.usedJSHeapSize;
    
    for (let i = 0; i < 100; i++) {
      const card = await sdk.createCard({ name: `Test ${i}` });
      const container = document.createElement('div');
      const result = await sdk.renderCard(card, container);
      if (result.instance) {
        await sdk.renderer.destroy(result.instance.id);
      }
    }
    
    if (global.gc) {
      global.gc();
    }
    
    const finalMemory = (performance as any).memory?.usedJSHeapSize;
    const memoryGrowth = finalMemory - initialMemory;
    
    expect(memoryGrowth).toBeLessThan(20 * 1024 * 1024);
    
    await sdk.destroy();
  });
});
```

**验收标准**:
- [ ] SDK 生命周期无泄漏
- [ ] 渲染生命周期无泄漏
- [ ] 插件生命周期无泄漏

---

### 2.4 性能优化

#### 任务 12.4.1: 代码分析和优化
**优先级**: P1  
**描述**: 分析并优化性能瓶颈

**优化项目**:
1. 懒加载优化
2. 缓存策略优化
3. 事件处理优化
4. DOM 操作优化
5. 内存使用优化

**验收标准**:
- [ ] 性能指标改善 ≥ 10%
- [ ] 无性能退化

---

#### 任务 12.4.2: 包体积优化
**优先级**: P1  
**描述**: 优化构建产物体积

**优化方法**:
1. Tree shaking 验证
2. 代码分割
3. 移除未使用代码
4. 依赖分析

**目标**:
- SDK 核心包 < 500KB
- 完整包 < 2MB

**验收标准**:
- [ ] 包体积达标
- [ ] Bundle 分析报告

---

## 3. 验收标准

### 3.1 测试覆盖率

| 类型 | 目标 |
|------|------|
| 单元测试覆盖率 | ≥ 85% |
| 集成测试覆盖率 | ≥ 70% |
| 分支覆盖率 | ≥ 80% |
| 核心 API 覆盖率 | 100% |

### 3.2 性能要求

- [ ] 所有性能基准测试通过
- [ ] 无明显内存泄漏
- [ ] 包体积符合要求

### 3.3 兼容性

- [ ] Chrome 最新版通过
- [ ] Firefox 最新版通过
- [ ] Safari 最新版通过
- [ ] Node.js 16+ 通过

---

## 4. 注意事项

1. **测试隔离**: 每个测试独立运行
2. **清理资源**: 测试后清理创建的资源
3. **性能稳定**: 多次运行取平均值
4. **CI 兼容**: 确保在 CI 环境可运行

---

**状态更新日期**: 2026-02-01
